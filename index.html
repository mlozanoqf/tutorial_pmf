<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dr.&nbsp;Martín Lozano.">

<title>Financial modeling with  R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="index_files/libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="index_files/libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="index_files/libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<style>html{ scroll-behavior: smooth; }</style>



  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    #btn-back-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 15px; /* Adjust the width */
      height: 15px; /* Adjust the height */
      box-sizing: content-box;
      z-index: 1000;
      background-color: rgba(0, 123, 255, 0.7);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>

<button type="button" class="btn btn-primary btn-lg bi bi-arrow-up" id="btn-back-to-top"></button>

<script>
  let backToTopButton = document.getElementById("btn-back-to-top");

  backToTopButton.addEventListener("click", function () {
    document.documentElement.scrollTop = 0;
  });
</script>



<div id="progress-bar" style="width: 0%; height:2px; background-color: rgb(89 127 235);; position: fixed; top: 0px; z-index: 2000;"></div>

<script id="progressbar" type="text/javascript">

document.addEventListener("DOMContentLoaded", function() {

    const bar = document.querySelector('#progress-bar');
    const post = document.querySelector('#quarto-content');
    const html = document.documentElement;
    
    const height = post.scrollHeight + post.offsetTop;
    
    window.addEventListener('scroll', () => {
        bar.style.width = (html.scrollTop / (height- html.clientHeight)) * 100 + '%';
    });
});
</script>
<link href="index_files/libs/vembedr-0.1.5/css/vembedr.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>





<div id="quarto-content" class="page-columns page-rows-contents page-layout-full toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul class="collapse">
  <li><a href="#introduction." id="toc-introduction." class="nav-link active" data-scroll-target="#introduction.">Introduction.</a>
  <ul class="collapse">
  <li><a href="#finance." id="toc-finance." class="nav-link" data-scroll-target="#finance."><span class="header-section-number">0.1</span> Finance.</a></li>
  <li><a href="#commercial-software-and-r." id="toc-commercial-software-and-r." class="nav-link" data-scroll-target="#commercial-software-and-r."><span class="header-section-number">0.2</span> Commercial software and R.</a></li>
  </ul></li>
  <li><a href="#financial-data." id="toc-financial-data." class="nav-link" data-scroll-target="#financial-data."><span class="header-section-number">1</span> Financial data.</a>
  <ul class="collapse">
  <li><a href="#stock-prices-and-other-financial-data." id="toc-stock-prices-and-other-financial-data." class="nav-link" data-scroll-target="#stock-prices-and-other-financial-data."><span class="header-section-number">1.1</span> Stock prices and other financial data.</a></li>
  <li><a href="#technical-analysis." id="toc-technical-analysis." class="nav-link" data-scroll-target="#technical-analysis."><span class="header-section-number">1.2</span> Technical analysis.</a></li>
  </ul></li>
  <li><a href="#prices-and-returns." id="toc-prices-and-returns." class="nav-link" data-scroll-target="#prices-and-returns."><span class="header-section-number">2</span> Prices and returns.</a>
  <ul class="collapse">
  <li><a href="#from-prices-to-returns." id="toc-from-prices-to-returns." class="nav-link" data-scroll-target="#from-prices-to-returns."><span class="header-section-number">2.1</span> From prices to returns.</a></li>
  <li><a href="#cumulative-returns." id="toc-cumulative-returns." class="nav-link" data-scroll-target="#cumulative-returns."><span class="header-section-number">2.2</span> Cumulative returns.</a></li>
  <li><a href="#distribution-of-returns." id="toc-distribution-of-returns." class="nav-link" data-scroll-target="#distribution-of-returns."><span class="header-section-number">2.3</span> Distribution of returns.</a></li>
  </ul></li>
  <li><a href="#asset-pricing." id="toc-asset-pricing." class="nav-link" data-scroll-target="#asset-pricing."><span class="header-section-number">3</span> Asset pricing.</a>
  <ul class="collapse">
  <li><a href="#what-drives-asset-return-changes" id="toc-what-drives-asset-return-changes" class="nav-link" data-scroll-target="#what-drives-asset-return-changes"><span class="header-section-number">3.1</span> What drives asset return changes?</a></li>
  <li><a href="#single-index-model." id="toc-single-index-model." class="nav-link" data-scroll-target="#single-index-model."><span class="header-section-number">3.2</span> Single-index model.</a></li>
  </ul></li>
  <li><a href="#asset-allocation." id="toc-asset-allocation." class="nav-link" data-scroll-target="#asset-allocation."><span class="header-section-number">4</span> Asset allocation.</a>
  <ul class="collapse">
  <li><a href="#the-single-period-problem." id="toc-the-single-period-problem." class="nav-link" data-scroll-target="#the-single-period-problem."><span class="header-section-number">4.1</span> The single-period problem.</a></li>
  <li><a href="#diversification." id="toc-diversification." class="nav-link" data-scroll-target="#diversification."><span class="header-section-number">4.2</span> Diversification.</a></li>
  <li><a href="#rebalancing-portfolio-and-evaluation." id="toc-rebalancing-portfolio-and-evaluation." class="nav-link" data-scroll-target="#rebalancing-portfolio-and-evaluation."><span class="header-section-number">4.3</span> Rebalancing portfolio and evaluation.</a></li>
  </ul></li>
  <li><a href="#blockchain." id="toc-blockchain." class="nav-link" data-scroll-target="#blockchain."><span class="header-section-number">5</span> Blockchain.</a>
  <ul class="collapse">
  <li><a href="#block." id="toc-block." class="nav-link" data-scroll-target="#block."><span class="header-section-number">5.1</span> Block.</a></li>
  <li><a href="#chain." id="toc-chain." class="nav-link" data-scroll-target="#chain."><span class="header-section-number">5.2</span> Chain.</a></li>
  <li><a href="#hash." id="toc-hash." class="nav-link" data-scroll-target="#hash."><span class="header-section-number">5.3</span> Hash.</a></li>
  <li><a href="#proof-of-work." id="toc-proof-of-work." class="nav-link" data-scroll-target="#proof-of-work."><span class="header-section-number">5.4</span> Proof-of-Work.</a></li>
  <li><a href="#transactions." id="toc-transactions." class="nav-link" data-scroll-target="#transactions."><span class="header-section-number">5.5</span> Transactions.</a></li>
  <li><a href="#digital-signature." id="toc-digital-signature." class="nav-link" data-scroll-target="#digital-signature."><span class="header-section-number">5.6</span> Digital signature.</a></li>
  <li><a href="#network." id="toc-network." class="nav-link" data-scroll-target="#network."><span class="header-section-number">5.7</span> Network.</a></li>
  <li><a href="#privacy." id="toc-privacy." class="nav-link" data-scroll-target="#privacy."><span class="header-section-number">5.8</span> Privacy.</a></li>
  </ul></li>
  <li><a href="#conclusion." id="toc-conclusion." class="nav-link" data-scroll-target="#conclusion."><span class="header-section-number">6</span> Conclusion.</a></li>
  <li><a href="#references." id="toc-references." class="nav-link" data-scroll-target="#references.">References.</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Financial modeling with <i class="fa-brands fa-r-project" aria-label="r-project"></i> <span style="color:white">R</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dr.&nbsp;Martín Lozano. </p>
          </div>
  </div>
    
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">January 2, 2024, 23:59:52 pm.</p>
    </div>
  </div>
    
  </div>
  
<div>
  <div class="abstract">
    <div class="abstract-title">Abstract</div>
    We show how to analyze financial data and extract basic insights from basic financial models using R programming language <span class="citation" data-cites="Rref">(<a href="#ref-Rref" role="doc-biblioref">R Core Team 2024</a>)</span>. We extend examples and codes freely available in Internet including some Matt Dancho’s Business Science IO, and some of my own. As in the philosophy of <span class="citation" data-cites="knuth1984literate">Knuth (<a href="#ref-knuth1984literate" role="doc-biblioref">1984</a>)</span>, the objective of this document is to explain to human beings what we want a computer to do as literate programming. This is a work in progress and it is under revision.
  </div>
</div>

</header>


<br>
<p align="right"> 
  <a href="https://mlozanoqf.github.io/">
    <span style="color: black">Back to Quantitative Finance with </span>
    <img src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/r.svg" alt="R Icon" style="width: 30px; height: 30px;">
  </a>
</p>

<p align="right"> 
    <a href="https://github.com/mlozanoqf" target="blank"><img align="center" src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/github.svg" alt="martin-lozano-21818a22" height="20" width="30"></a>
    <a href="https://ssrn.com/author=1490785" target="blank"><img align="center" src="./ssrn.svg" height="90" width="30"></a>
    <a href="mailto:mlozanoqf@gmail.com" target="blank"><img align="center" src="./envelope-solid.svg" alt="mailto:mlozanoqf@gmail.com" height="20" width="30"></a>
    <a href="https://linkedin.com/in/martin-lozano-21818a22" target="blank"><img align="center" src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/linkedin.svg" alt="martin-lozano-21818a22" height="20" width="30"></a>
    <a href="https://www.youtube.com/user/drmartinlozano" target="blank"><img align="center" src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/youtube.svg" alt="https://www.youtube.com/channel/drmartinlozano" height="20" width="30"></a>
    <a href="https://scholar.google.com/citations?user=w8boOboAAAAJ&amp;hl=en" target="blank"><img align="center" src="./google-scholar.svg" height="30" width="25"></a>
    <a href="https://sites.google.com/site/mlozanoqf" target="blank"><img align="center" src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/icloud.svg" alt="https://www.youtube.com/channel/drmartinlozano" height="20" width="30"></a>
    <a href="https://us02web.zoom.us/j/9209945512" target="blank"><img align="center" src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/zoom.svg" alt="zoom" height="60" width="50"></a>
</p>

<hr style="border:2px solid gray">

<div style="page-break-after: always;"></div>
<section id="introduction." class="level1 unnumbered">
<h1 class="unnumbered">Introduction.</h1>
<p>The main objective of this document is to show how to extract, visualize and analyze financial data in the context of asset pricing models, asset allocation models, a few financial econometrics techniques, and review some the most cutting edge technologies applications such as blockchain, using R. Here, we are interested in explaining concepts and real-life applications by developing examples that start from the data extraction, the problem statement, the proposed solution and the evaluation of the solution.</p>
<p>We start by explaining what finance is about and why we require to incorporate a programming language as a way to conduct financial analysis. Any quantitative analysis requires gathering and manipulating data at some initial step, so we continue by showing how to extract financial and economic information making special emphasis on stock market information and in data visualization. Then, we conduct some basic financial analysis based on the firm’s stock prices. Then, we move from analyzing prices to analyzing asset returns and we introduce the concept of financial risk. With these foundations, then we move into some asset pricing applications to understand what drives asset returns, we discuss the role of risk factors and how the estimation of asset pricing models can help us to make better financing and investment decisions. Given the relevance of future asset prices changes we also incorporate some foundations of asset prices forecast. Then, we introduce the portfolio analysis by showing how an investor could take informed decisions to optimize the performance of his or her investment portfolio, how to reduce risk by implementing diversification tools and financial algorithms, as well as evaluate investment strategies. Finally, we review the concept of blockchain and illustrate how it works. For starters, this technology uses data elements encrypted in blocks of computer code. The blocks are chained together across a shared ledger through cryptology. If someone tries to hack the ledger, it is immediately known by the involved parties and the chain falls apart. Blockchain has the potential to reshape processes that are defined inside finance, primarily because of its cost and control benefits.</p>
<section id="finance." class="level2" data-number="0.1">
<h2 data-number="0.1" class="anchored" data-anchor-id="finance."><span class="header-section-number">0.1</span> Finance.</h2>
<p>According to <span class="citation" data-cites="oecd2020oecd">(<a href="#ref-oecd2020oecd" role="doc-biblioref">OECD 2020</a>)</span>, developed and emerging countries and economies have become increasingly concerned about the level of financial literacy (ability to understand and properly apply financial management skills) of their citizens, including young people. This initially stemmed from concern about the potential impact of shrinking public and private welfare systems, shifting demographics, including the ageing of the population in many countries, and the increased sophistication and expansion of financial services. We all face financial decisions and we demand and offer financial services in this evolving context. As a result, financial literacy is now globally recognized as an essential life skill.</p>
<p>We all have different interests and incentives to learn finance. In finance we mainly study financing and investment decisions under uncertainty. Financing decisions are about looking for funds whereas investment decisions are about assigning funds to run a project. Thus, financing and investment are basically two sides of the same coin called project, business idea, firm, financial asset, countries, etc. A business project is a series of inputs, outputs, investment plans and tasks that need to be completed in order to reach a specific expected outcome in the future. Projects are uncertain by nature because many things can go wrong in the future: a firm might go bankrupt, a business idea can be stolen, sales projections might not be as good as expected, plans could change because of coronavirus pandemic, and so on. This is why we say that financing and investment decisions are taken under uncertainty. Finance decisions are taken today, but their results are seen or realized in the uncertain future. Risky projects and uncertain projects are not necessarily bad projects as uncertainty and risk boost innovation, demands a high-quality quantitative analysis, represent opportunities for entrepreneurs, and returns for investors.</p>
<p>An individual takes financing decisions in the job market, trying to get the maximum salary in the most convenient job to get the funds to pay for food, housing and leisure. This individual takes an investment decision when she decides to use her savings to start a small firm. If this firm performs well in the first year, then the firm will apply for a bank loan to finance a business expansion. Once the firm gets the new funds, the firm will have to invest this money wisely in productive assets, technology and hire experts in the relevant business field. As the firm generates profits, the owner who initially decided to risk her money will get returns. These returns may attract other investors willing to help the manager to export to other countries in exchange for some participation in the firm’s profits. When we replicate this in the economy many times, it is easy to understand how good finance and investment decisions directly contribute to the economic growth and indirectly to the economic development.</p>
<p>Finance can be applied by individuals and firms as illustrated above. Governments get funds from taxpayers to invest in public assets such as education, health, public infrastructure, etc. Governments also can contribute to create certainty about the stability of economic indicators and maintain a rule of law to stimulate private investment. If public spending remains higher than income, the country might fall into a public deficit and this could lead to financial instability which dampers not only public finances but personal and private investment decisions as well.</p>
<p>Most finance decisions are taken based on a risk-return analysis. In particular, if after doing the corresponding maths and consulting with the pillow you conclude that the expected return is higher than the associated risk, then you will most likely go for it. On the other hand, if the risk looks quite high compared with the expected return, you will surely re-think or abandon the project. We, as individuals, perceive the risk and the return differently, we may have biases, and we might not be that rational all the time. Consider the following real example. For each of the past 17 years, the All-England Lawn Tennis Club has paid for an insurance policy to guard against losses if Wimbledon should have to be cancelled in the event of a worldwide pandemic. This was considered for some as an excessive cost, a foolish strategy, until recently. Wimbledon received about £114 million because 2020 tournament was cancelled due to the coronavirus. A similar thing happens when you buy a used car. Surely the buyer considers the car cheap enough, and the seller considers the car price expensive enough to close the deal. So, it is sometimes good to have some sort of different perspectives about prices, risk and returns as this allows commercial and financial transactions to exist. We also perceive risk and return differently as we use different methods, data and procedures to estimate risk and return.</p>
<p>Although we all perceive risk and return differently by nature, we may also perceive the risk and return simply wrong by lack of knowledge. This is not uncommon as we may apply political decisions to finance problems, or make financial decisions without the relevant knowledge in the field, or ignoring the power of data analysis. Underestimating risks and overestimating returns may be as harmful as overestimating risk and underestimating returns. The first could lead to an excess of risk and the latter could lead to forego a good business. We are not suggesting everybody should become a finance expert, but finance professionals are expected to contribute to make better and correct financial decisions most of the times.</p>
<p>Finance is not a pure exact area of knowledge, it borrows some principles of physics and mathematics to develop financial models.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> For instance, we are sure that at standard atmospheric pressure, water boils at approximately 100 degrees Celsius. But we do not know for sure whether my business profits will grow at 10% next year. Returns are uncertain, this is why we call them expected returns. In fact, after doing some financial analysis, I can estimate that my profits will grow in the range of 5% to 15%, this range shows how uncertain my profits are. This is why returns and risk are two main pillars in finance. The ability of understanding the economic conditions, the market, and the firm will determine the success of financing and investment decisions. This means that finance requires some knowledge of economics, statistics, math, accounting, probability, marketing, psychology, and data science to transform data into intelligent decisions.</p>
<p>Finance is an area within economics. The Journal of Economic Literature (JEL) classification system is used to classify articles, dissertations, books, book reviews, and working papers in EconLit, and in many other applications. The JEL classify finance as <em>financial economics</em> and includes:</p>
<ul>
<li>G00. Financial Crises.</li>
<li>G1. General Financial Markets, Portfolio Choice, Investment Decisions, Asset Pricing, Trading Volume, Bond Interest Rates, Contingent Pricing, Futures Pricing, Information and Market Efficiency, Event Studies, Insider Trading, International Financial Markets, Financial Forecasting and Simulation, Government Policy and Regulation.</li>
<li>G2. Financial Institutions and Services, Banks, Depository Institutions, Micro Finance Institutions, Mortgages, Insurance, Insurance Companies, Actuarial Studies, Non-bank Financial Institutions, Financial Instruments, Institutional Investors, Investment Banking, Venture Capital, Brokerage, Ratings and Ratings Agencies, Government Policy and Regulation.</li>
<li>G3. Corporate Finance and Governance, Capital Budgeting, Fixed Investment and Inventory Studies, Capacity, Financing Policy, Financial Risk and Risk Management, Capital and Ownership Structure, Value of Firms, Goodwill, Bankruptcy, Liquidation, Mergers, Acquisitions, Restructuring, Corporate Governance, Payout Policy, Government Policy and Regulation.</li>
<li>G4. Behavioral Finance, Role and Effects of Psychological, Emotional, Social, and Cognitive Factors on Decision Making in Financial Markets.</li>
<li>G5. Household Finance, Household Saving, Borrowing, Debt, and Wealth, Insurance, Financial Literacy.</li>
</ul>
<p>In this document we focus on only a few areas of finance: asset pricing, portfolio choice, financial forecasting, financial risk and risk management.</p>
</section>
<section id="commercial-software-and-r." class="level2" data-number="0.2">
<h2 data-number="0.2" class="anchored" data-anchor-id="commercial-software-and-r."><span class="header-section-number">0.2</span> Commercial software and R.</h2>
<p>Every area of knowledge requires computers to conduct interesting analysis and applications. Traditionally, people use good commercials (and sometimes expensive) software such as Microsoft Excel, SPSS, STATA, E-Views, and many others. These commercial software are good alternatives. However, given that these programs are fully controlled by private firms who genuinely seek to create value for their shareholders, there is no guarantee that their associated file formats could be readable in the future, or even exist in the future, which negatively impacts reproducibility. Reproducibility is desirable as it helps to verify that results in a paper or report can be attained by a different research team, using the same methods. Learning and use R (or Python) for data analysis is a good way to attain repeatability and reproducibility. These computer languages are user-oriented and are created and constantly improved by a growing scientific community with an immense online presence to assist users.</p>
<!-- Commercial software products as the ones listed above are definitely important in the job market, but you also have to realize that the main interaction with these programs is by using the mouse to click on pre-defined, limited and inflexible menus. This kind of user-interaction is most of the times ephemeral and unrecorded, so that many of the choices made during a full quantitative procedure are frequently undocumented and this turns out to be highly problematic because there is no trace about how an analysis was conducted, and also because it becomes hard to propose an extension to the analysis in phases or replication in different contexts. Coding allows us to conduct and develop reproducible research. Learning how to code is equivalent as writing a cooking recipe and every time you click run you get the dish done. Although, chefs have to pay for ovens, kitchen items and even ingredients, while in finance most of our inputs are free data and the technology is also free as R is an open source software. -->
<!-- Other commercial products in which you do not have to code like Microsoft Excel, SPSS, STATA, E-Views and many others, have high licensing fees and also rely on mysterious black boxes to produce a battery of results. These black boxes are problematic because the data comes in and the result comes out as magic, showing no details about the procedure followed to produce the final results, and the user could sadly get the wrong illusion that he or she understands data analysis. This might be convenient in some specific and limited cases but in others you miss the fun that represents having access to all the details of the computation and limit the extent to which you can customize or extend to innovative and create new improved applications. The general alternative to using a point-and-click program is to familiarize with languages like R which allows writing scripts to program algorithms for economic and financial analysis and visualizations. -->
<p>R is a language and environment for statistical computing and graphics. R is a powerful integrated suite of software facilities for data manipulation, calculation and graphical display. R is available as Free Software under the terms of the Free Software Foundation’s GNU General Public License in source code form. It compiles and runs on a wide variety of UNIX platforms and similar systems (including FreeBSD and Linux), Windows and MacOS. Given its popularity and flexibility, R is currently implemented in virtually all areas of knowledge including finance by students, practitioners, researchers, universities, institutions, firms, think tanks, and policy makers around the world.</p>
<p>Many users think of R as a statistics system. We prefer to think of it as an environment within which statistical techniques are implemented. This is why R is a popular choice for finance and economic modeling. R can be easily extended via packages. There are about eight default packages supplied with the R distribution and many more are available through the CRAN family of Internet sites covering a very wide range of modern statistics, data science and finance applications.</p>
<p>Let’s see how many packages are there as today using R code by implementing the <tt><code>available.packages()</code></tt> function.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>R_packages <span class="ot">&lt;-</span> <span class="fu">available.packages</span>(<span class="at">filters =</span> <span class="st">"duplicates"</span>,</span>
<span id="cb1-2"><a href="#cb1-2"></a>                                 <span class="at">repos =</span> <span class="st">"https://cran.rstudio.com"</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"There are"</span>, <span class="fu">nrow</span>(R_packages), </span>
<span id="cb1-4"><a href="#cb1-4"></a>            <span class="st">"R packages available in CRAN as of"</span>, </span>
<span id="cb1-5"><a href="#cb1-5"></a>            <span class="fu">Sys.Date</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "There are 20249 R packages available in CRAN as of 2024-01-02"</code></pre>
</div>
</div>
<p>Every R package has its own PDF online documentation and there are many online examples developed by users as well, you just have to Google it. Many times, we do not know how to deal with an error message, and we can find our way out by Google it. <!-- I have been using R, Matlab, Python, Octave and other languages for the last 15 years and I can confirm every time I do not know how to code something in R, I can easily find a solution online either in specialized discussion forums, official documentation, or in YouTube videos and tutorials. You also have several online and free resources in the course syllabus, and you can always ask me for help. --></p>
<p>R offers numerous advantages for data analysis compared with other alternatives like Microsoft Excel. R is free; it is easy to do reproducible research, self-documenting, repeatable; it is scalable, this is, applicable to small or large problems; there is a big and growing R online community by discipline and by region, including R-Ladies groups; Stack Overflow; plenty of learning resources; many R books and online resources. Finally, R is ‘becoming’ the new norm in data science and specifically in finance analysis. Even if you are interested in other languages like Python, at the end learning one language can help you to understand others.</p>
<!-- While some people find the use of a commandline environment for coding daunting, it is becoming a necessary skill for managers, management analysts, and data scientists as the volume and variety of data has grown. Thus, scripting or programming has become a third language for modern professionals, in addition to their native language, and discipline specific terminology. -->
<!-- Below is the way we show R code and R output throughout this tutorial. -->
<!-- ```{r} -->
<!-- # We write comments in italics. The R code looks like this: -->
<!-- print("hello world") -->
<!-- ``` -->
<!-- The output of the R code above is a string text: \texttt{hello world}. The R function \texttt{print} prints in the screen the quoted string in parenthesis. We will use a number of R functions to illustrate finance applications and examples. Nobody expects you to memorize each function and its syntax as you can always access R documentation to help you out with R functions syntax and even examples. This is done by typing \texttt{?print} in the console. You will see a right panel with the corresponding help. This is part of the help documentation when you type \texttt{?print}: -->
<!-- Print Values. Description. \texttt{print} prints its argument and returns it invisibly (via invisible(x)). It is a generic function which means that new printing methods can be easily added for new classes. Usage. \texttt{print(x, ...)} -->
<!-- Now, a simple numerical example to show R code and R output. -->
<!-- ```{r} -->
<!-- # Define the value of a. -->
<!-- a <- 2 + 2 -->
<!-- # Print the value of a. -->
<!-- print(a) -->
<!-- # Or simply. -->
<!-- a -->
<!-- ``` -->
<!-- So, \texttt{a} is equal to 4. Of course, R is more than a Fisher-Price calculator. But it is always useful to see simple examples first. -->
<!-- In the following sections, we show and explain examples that the participants can replicate for their own purposes and interests. In particular, we expect the participants to "copy - paste - edit - review" the structure of the code to replicate some analysis on their own. For example, imagine you are interested in producing a variable \texttt{b} that contains the result of $3+3$. Given the previous example, you know you can do this by typing $b = 3 + 3$. A variable \texttt{c} which is the product of \texttt{a} and \texttt{b} is then $c = a \times b$. You will soon realize that there are many ways in which we can define \texttt{c}. An alternative is $c = (2+2) * b$, or $c = a * (3+3)$, $c = (2+2) * (3+3)$, and even $c = 4 * 6$. This means that there are many equivalent ways to do one task. -->
</section>
</section>
<section id="financial-data." class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Financial data.</h1>
<p>Data is everywhere and finance has always been about data.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Industries perceive data as an essential commodity and fuel to take decisions under uncertainty. As a matter of fact, data science and finance go hand in hand. Even before the term data science was coined, finance was using it. Data Science is widely used in areas like risk analytics, credit risk, fraud detection, risk management, pricing, and algorithmic trading. Financial institutions were among the earliest users and presumably pioneers of data analytics. We need data to perform financial analysis, estimate financial models, forecast financial variables, take financing and investment decisions, and more. The alternative of data is to listen to your guts, your intuition, or experience. This alternative is not bad by itself, but it would not be our main approach here.</p>
<p>Financial data is usually free and available in electronic sources for downloading. There are exemptions as private firms are not obligated to make their financial information public. Also, there are some kind of financial information that public firms are not obligated to make public given the international regulations. Sometimes, financial data is not fully available but we have summary statistics that can be quite useful to simulate the data by ourselves. Financial markets are a great source of financial information like exchange rates, commodities, financial instruments, etc. Public institutions and international organizations are useful sources of financial information as well. In any case, we have more financial data than time and resources to analyze it, and the gap is getting bigger and bigger.</p>
<!-- ## Financial statements. -->
<!-- Financial data comes in a wide variety of formats, and is reported and stored in numerous electronic sources. Financial statements represent a great source to analyze and understand the financial health of a firm, individuals and even governments. Financial statements are standard and well-organized reports that summarize important financial accounting information of a business. The traditional approach to analyze financial statements is looking at those in the firm's annual reports, or downloading them in PDF or Excel format in the firm's investor website site. -->
<!-- In R, we can download public firm's financial statements from the US Securities and Exchange Commission using the *finreportr* package (there are others like *finstr*). This is useful to evaluate a firm performance and conduct financial analysis as we do not need to visit the firm site. In fact, we could replicate or extend the full analysis by running the code instead of downloading newer financial statements. -->
<!-- In case you are not familiar with R packages, you should know you need to download the packages you need before using them. This is an easy process in RStudio. First, select the "Tools" menu, and then "Install Packages..." option. Now, type the name of the package you need, in this case type *finreportr* for accessing financial statements (later we will need *tidyquant* as well and others), leave the default options as they are, and click "Install". You will see a typical bar progress of this download process and R will let you know when this is done. You only need to download packages once, but you have to load the package (using the function *library*) every time you will use the package in your script. 

<!-- If you are interested in working with financial statements, you should look for the *finreportr* package documentation online or users' examples available in Internet. Perhaps the main drawback of this package is that it may be slow, you normally need to wait for R to download the financial reports. Let's start with some examples here. First, we load the previously downloaded packages. -->
<!-- ```{r} -->
<!-- # Load the tidyquant package to manipulate the data and more. -->
<!-- library(tidyquant) -->
<!-- library(dplyr) -->
<!-- library(tidyr) -->
<!-- ``` -->
<!-- This is why we are interested firms to perform well in the economy. If firms are well managed, they are expected to take good strategic decisions to increase the value of the firm. In particular, the firm looks for funds from banks or owners, then invests in assets to produce or provide a service to the market. If things go well, sales increase and if revenues are greater than costs, the firm makes profits. When the firm increases their assets, they might also need more people to produce or manage those assets, then employment increases. More jobs mean more families with available income, and families will spend their income and stimulate the whole economy further. Even government may increase their tax revenues to (hopefully) spend them into high-quality public goods to increase society's welfare. Not only that, as a firm performs well, the whole value chain straightens as the firm requires inputs and services from other firms to operate. We are interested firms to perform well in the economy because that is good for the population in general and to other firms as well. Private investment stimulates the whole economy. -->

<!-- Strictly speaking, firms (regardless of their size) do not own what they have. Firm's assets were originally bought or financed using others' money (liabilities) and/or owners' money (equity). In simple terms, people are interested to finance the firm activities because the firm is supposed to know how to invest those funds in productive assets to make profits as in the case of Facebook. When the financial statements show that firms take bad decisions, their assets do not produce profits and people will not be very interested in financing a non-profitable firm. In good times, people who finance productive firms receive interests, returns, or dividends as a compensation for putting their money at risk. -->
<!-- Firms have incentives to be and keep being financially healthy in the future to attract financing more easily. Public firms (as those participating in the stock market) are subject to strict regulations and public scrutiny so everybody can constantly evaluate the firm performance. Regulations do not prevent all frauds or bankruptcies, but they are intended to minimize irregular and illegal practices. We were able to freely download financial statements because regulators ask public firms to do so given some deadlines and specific guidelines. Yearly and quarterly financial statements are analyzed in detail to evaluate firms as projects, and the main interest is the relationship between risk and return, so people can make better investment decisions. The decision of financing a firm operation is risky, but the reward is supposed to be attractive enough to compensate that risk. In finance we are interested to measure how risky are the investment opportunities in the form of firms, projects, and financial assets in general. When we do a financial analysis, we also compare the performance of one company not only with respect to previous years, but also with respect to other firms, and also with respect to their own industry or sector. This is not difficult as the regulators ask public firms to publish their financial statements in a similar manner, so comparisons among different firms are valid. -->
<!-- Finance is about people taking decisions under uncertainty with the help of data analysis. Think in two kind of people in the world: those who have money but no ideas (investors), and those who have ideas but no money (firms or entrepreneurs). We refer to ideas as business ideas, innovations, business projects that require funds to get started. Those with ideas and money are rare in this world, and those without ideas and without money are in trouble. When the financial system works well, productive projects will succeed at attracting funds, firms will invest in productive assets, private investment grows, and we should expect economic growth, and hopefully economic development improves. When the financial system fails, good projects might fail to get funding and probably bad projects get financing. This could be frustrating. -->
<!-- People with money and no ideas are looking for opportunities for their money to grow. They basically face two alternatives: to save their money (put it in the bank and receive a small but certain return), or invest their money in risky projects offered by firms or entrepreneurs. The final decision is taken based on a risk-return analysis, with the help of data analysis and financial models. Imagine the bank offers a secure 4%, and the firm offers a risky 3.5% return (assume it could be as low as −1% or as high as 4%). In that case, most of us might agree (if you are risk averse as me) that the funds are better in a bank. Now assume a different situation. The bank offers a secure 4%, and the firm offers a risky 6% return (it could be as low as 3.5% and as high as 8%). In that case, there might be some investors that after doing some analysis finally decides to put their money at risk. Things become interesting and complex because the same project can be attractive for some investors and bad for others as they might have different tools to analyze risky projects and they might also have different risk appetite levels. -->
<!-- People with ideas but no money are looking for funds to run their projects. If the project is impressively good, then the firm could ask for funds in exchange of a reduced return. The project is then not too risky and the return is also low. On the other hand, if the project looks OK but entails a high risk, the firm or entrepreneur should be willing to pay high returns to investors to compensate for the associated risk. This is why risk and return move together, the higher the risk the higher the return and vice-versa. If this rule fails, then we are in trouble. -->
<!-- Interestingly, an excess of private investment is not always good for the economy. Imagine the interest rate (return of savings, and the cost of asking for a loan) is low and the economic perspectives look good. In that case, we have good conditions for the private investment to grow as it is cheap to ask for financing. In the extreme, families now have more money and they start spending a lot. Aggregate demand for all goods and services increase and consequently the prices of all goods and services increase as well. The country is experiencing an increase in the inflation levels. Then, even though people have money in their pockets, they are not able to buy as prices increase faster than families' income. In order to reduce inflation levels, the monetary authority increases the interest rates, making savings more attractive and investment less attractive. If they succeed, people will spend less and save more. This decreases the aggregate demand for goods and services and prices could decrease again to desired levels. To add more drama, imagine that this increase in interest rates is so high that now economic growth is slowing down and the risk of falling into a recession increase. If that happens, then the monetary authority should decrease the interest rates again to incentive people to stop saving and start investing again. This is why you see that interest rates go up and down, although we have had low interest rates for a while. -->
<!-- Let's go back to finance and illustrate the process of a firm looking for funds, the difference between private and public firms, and see how a firm can grow or go bankrupt in a simple but illustrative example. -->
<!-- Firms can sell bonds or stocks as a way to get funds. Let's focus on the stocks. By selling stocks, the firm can increase their equity and consequently increase their assets. People who buy stocks expect the firm to make wise investment decisions to get a return in the future. Initially, in time zero $t=0$, assume the firm is private and has the following balance sheet: -->
<!-- ```{r} -->
<!-- # The firm is private now.  -->
<!-- private_firm_bs <- c(assets = 100, liabilities = 40, equity = 60) -->
<!-- # Print results. -->
<!-- private_firm_bs -->
<!-- ``` -->
<!-- Private firms cannot sell stocks in the stock market, only public firms can. Selling stocks in the stock market is attractive for some firms because it is a way for them to grow. Stock markets allow more participant firms as long as they fulfill some strict requirements. Given the balance sheet above, the owner of this private firm invested 60 USD. When the firm goes 100% public, then the owner will sell the 60 USD investment to others. -->
<!-- In $t=1$, with the objective of getting fresh funds, the firm decides to go 100% public and sell 60 stocks at 1 USD each. Imagine that the firm succeeded at selling all 60 stocks at 1 USD. This is because investors who participate in the stock market consider that this is a fair value for the firm. These investors become new owners; this is why we say the firm is now public. So, by the end of $t=1$ we have: -->
<!-- ```{r} -->
<!-- # The firm is public now.  -->
<!-- public_firm_bs <- c(assets = 100, liabilities = 40,  -->
<!--                     equity_60x1 = 60) -->
<!-- # Print results. -->
<!-- public_firm_bs -->
<!-- ``` -->
<!-- In $t=2$ more investors realize that the firm is well managed, its market is growing and there is no close competition. Now, investors actually think that paying 1 USD per stock is actually a bargain, so they are willing to pay even more than 1 USD to participate in this project. So, the demand for those stocks increases, and as a result the price goes from 1 to 2 USD per share. By the end of $t=2$ we have: -->
<!-- ```{r} -->
<!-- # Stock price increased from 1 to 2. -->
<!-- public_firm_bs <- c(assets = 100+60, liabilities = 40,  -->
<!--                     equity_60x2 = 120) -->
<!-- # Print results. -->
<!-- public_firm_bs -->
<!-- ``` -->
<!-- Now the firm has grown by going public and by showing good perspectives. -->
<!-- However, in $t=3$ we sadly get to know that the firm's financial statements were overestimating profits, and a big fraud was detected today. Big scandal and all newspapers talk about it. Then, investors are now interested in selling all their stocks as quickly as they can. Investors are so desperate to sell their stocks that they drop the stock price to almost zero. By the end of $t=3$ we have: -->
<!-- ```{r} -->
<!-- # Stock price decrease to 0. -->
<!-- public_firm_bs <- c(assets = 40, liabilities = 40,  -->
<!--                     equity_60x0 = 0) -->
<!-- # Print results. -->
<!-- public_firm_bs -->
<!-- ``` -->
<!-- There are still 60 stocks in the market with a unit price of zero, so the market value of equity is null. This hypothetical firm is virtually bankrupt as they need to sell all their assets to pay the debt. In simple terms, a firm is bankrupt when the liabilities are greater than the assets. The firm will hardly get fresh funds as investors realize this was a bad project. -->
<!-- Many things can happen when a firm faces this difficult situation. Sometimes it is worthwhile to try to improve the firm's financial condition, hiring professional managers, and hope to recover the investor's confidence. Before bankruptcy, firms could also negotiate with their debt holders. If negotiation succeeds, the firm could get a longer debt maturity, a reduced debt to help the firm remain alive and hope to recover its operations, or a more innovative solution. There are also other firms that look for firms in trouble to buy them for a wide variety of reasons. In the US, you may hear about "Chapter 11", which is a form of bankruptcy that involves a reorganization of a debtor's business affairs, debts, and assets, and for that reason is known as "reorganization" bankruptcy. Corporations generally file Chapter 11 if they require time to restructure their debts. This version of bankruptcy gives the debtor a fresh start. However, the terms are subject to the debtor's fulfillment of its obligations under the plan of reorganization. -->
<!-- As we show before, the stock price evolution is generally a good indicator about how the investors interpret the future of the firm. When the stock price increases, then investors are demanding more stocks. A higher stock price is associated with a more valuable equity and this is good for the firm. When the stock price decreases, then there are more people trying to sell stocks compared to those trying to buy so the stock price falls. There might be some cases in which a drop in the stock price is associated with a firm good performance. Consider the stock price has increased in the last week, investors bought at 10 USD and today's price is 15 USD. Those investors might be interested to sell now to make a 5 USD profit. This increase in the supply of stocks could be significant enough to drop prices in the short run. -->
<!-- Remember this firm needed to go public before issuing and selling stocks in the stock market. Normally, these firms are big, although there are some stock markets for medium-sized firms. Small firms can hardly access these kinds of markets to get funding in a direct way. This might be problematic because small firms are the ones which require more alternatives to get financing so they can grow. The literature regarding small firms show that one of the most important problems they face is precisely the lack of financing or the limited alternatives to get funds. This remains an open challenge for the financial services and an opportunity for fintech companies. In the world there are significantly more small firms compared with big firms, so any improvement in the credit conditions of small firms could have a significant impact on the income of many people. -->
<!-- In the following section we move from a financial statement analysis to the analysis of stock prices. Note that both are linked by the equity and overall performance of public firms. -->
<section id="stock-prices-and-other-financial-data." class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="stock-prices-and-other-financial-data."><span class="header-section-number">1.1</span> Stock prices and other financial data.</h2>
<p>Financial markets not only facilitate financial transactions between sellers and buyers, they also represent a rich source of financial data. Here, we show how to use R to download stock price data from financial markets by using a few examples.</p>
<p>R packages like <tt><code>quantmod</code></tt> and <tt><code>tidyquant</code></tt> make the process of downloading financial data to perform financial analysis very straightforward. The <tt><code>quantmod</code></tt> package for R is designed to assist the quantitative trader in the development, testing, and deployment of statistically based trading models. The <tt><code>tidyquant</code></tt> package is part of the so-called <tt><code>tidyverse</code></tt>, an opinionated collection of R packages introduced by Hadley Wickham and designed for data science. All <tt><code>tidyverse</code></tt> packages share an underlying design philosophy, grammar, and data structures.</p>
<p>There are plenty of YouTube tutorials showing how to install packages in R. This is one of them:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">embed_url</span>(<span class="st">"https://youtu.be/JBcVi-fAT_k"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="vembedr">
<div>
<iframe src="https://www.youtube.com/embed/JBcVi-fAT_k" width="533" height="300" frameborder="0" allowfullscreen="" data-external="1"></iframe>
</div>
</div>
</div>
</div>
<p>In the past, when we were interested in performing a financial analysis in a rudimentary statistical software, we had to open the financial market site, download the data in Excel or text format, and then convert it to a compatible format given the statistical software requirements. In ancient times, people had to gather financial data from the newspaper. Fortunately for us, now we have R packages to make this process not only easy but also free, extremely efficient and immediate.</p>
<p>Let’s download Apple stock prices in one step using the <tt><code>tq_get()</code></tt> function available in the <tt><code>tidyquant</code></tt> package.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Get stock prices for Apple stock from Yahoo! finance site.</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>aapl_stock_prices <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(<span class="st">"AAPL"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We are done. The variable <tt><code>aapl_stock_prices</code></tt> contains Apple stock prices and other relevant information. Many things happened here in a very few steps. First, we need to have Internet access, R and R Studio working on our computer. Then, we load the <tt><code>tidyquant</code></tt> package. This package presumably integrates the best resources for collecting and analyzing financial data in R. The <tt><code>tq_get()</code></tt> function belongs to the <tt><code>tidyquant</code></tt> package, and <tt><code>tidyquant</code></tt> belongs to the <tt><code>tidyverse</code></tt> packages. Specifically, <tt><code>tq_get()</code></tt> connects to a default financial site, which in this case is the finance.yahoo.com and looks for the “AAPL” symbol which corresponds to Apple Inc.&nbsp;Finally, we store the data into <tt><code>aapl_stock_prices</code></tt>.</p>
<p>To see what it is inside the <tt><code>aapl_stock_prices</code></tt> object we can do the following.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># str function is a way to display the structure of an R object.</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="fu">str</span>(aapl_stock_prices)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [2,516 × 8] (S3: tbl_df/tbl/data.frame)
 $ symbol  : chr [1:2516] "AAPL" "AAPL" "AAPL" "AAPL" ...
 $ date    : Date[1:2516], format: "2014-01-02" "2014-01-03" ...
 $ open    : num [1:2516] 19.8 19.7 19.2 19.4 19.2 ...
 $ high    : num [1:2516] 19.9 19.8 19.5 19.5 19.5 ...
 $ low     : num [1:2516] 19.7 19.3 19.1 19.2 19.2 ...
 $ close   : num [1:2516] 19.8 19.3 19.4 19.3 19.4 ...
 $ volume  : num [1:2516] 2.35e+08 3.92e+08 4.13e+08 3.17e+08 2.59e+08 ...
 $ adjusted: num [1:2516] 17.3 16.9 17 16.9 17 ...</code></pre>
</div>
</div>
<p>According to the <tt><code>str()</code></tt> function output, <tt><code>aapl_stock_prices</code></tt>, we have 2516 daily observations for 7 variables. As you can see, we have not only prices but also volume. Let’s consider a different way to see and have a grasp of what it is inside <tt><code>aapl_stock_prices</code></tt>. In particular, we can see the first and the last part of this lengthy daily database.</p>
<p>The first observations.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># See the first observations of aapl_stock_prices.</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="fu">head</span>(aapl_stock_prices)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 8
  symbol date        open  high   low close    volume adjusted
  &lt;chr&gt;  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 AAPL   2014-01-02  19.8  19.9  19.7  19.8 234684800     17.3
2 AAPL   2014-01-03  19.7  19.8  19.3  19.3 392467600     16.9
3 AAPL   2014-01-06  19.2  19.5  19.1  19.4 412610800     17.0
4 AAPL   2014-01-07  19.4  19.5  19.2  19.3 317209200     16.9
5 AAPL   2014-01-08  19.2  19.5  19.2  19.4 258529600     17.0
6 AAPL   2014-01-09  19.5  19.5  19.1  19.2 279148800     16.8</code></pre>
</div>
</div>
<p>The last observations.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">tail</span>(aapl_stock_prices)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 8
  symbol date        open  high   low close   volume adjusted
  &lt;chr&gt;  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 AAPL   2023-12-21  196.  197.  194.  195. 46482500     195.
2 AAPL   2023-12-22  195.  195.  193.  194. 37122800     194.
3 AAPL   2023-12-26  194.  194.  193.  193. 28919300     193.
4 AAPL   2023-12-27  192.  194.  191.  193. 48087700     193.
5 AAPL   2023-12-28  194.  195.  193.  194. 34049900     194.
6 AAPL   2023-12-29  194.  194.  192.  193. 42628800     193.</code></pre>
</div>
</div>
<p>By default, the <tt><code>tq_get()</code></tt> function downloads the latest set of data available. You can verify that the last date of <tt><code>aapl_stock_prices</code></tt> above approximately corresponds to the production date of this tutorial. If there is a difference it is simply because the stock market is still close or we are running the code in a weekend. In this case:</p>
<ul>
<li>Last <tt><code>aapl_stock_prices</code></tt> observation: 2023-12-29.</li>
<li>Today is: 2024-01-02.</li>
</ul>
<p>We also like to show the data in a plot.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">plot</span>(aapl_stock_prices<span class="sc">$</span>date, aapl_stock_prices<span class="sc">$</span>adjusted, </span>
<span id="cb11-2"><a href="#cb11-2"></a>     <span class="at">type =</span> <span class="st">"l"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-asp" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-asp-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.1: Apple stock prices.</figcaption>
</figure>
</div>
</div>
</div>
<p>We can add a few instructions to improve the format of our plot. In particular, <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> labels, the title, and the color of the line.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">plot</span>(aapl_stock_prices<span class="sc">$</span>date, aapl_stock_prices<span class="sc">$</span>adjusted, </span>
<span id="cb12-2"><a href="#cb12-2"></a>     <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">xlab =</span> <span class="st">"Date"</span>, <span class="at">ylab =</span> <span class="st">"Adjusted price"</span>, </span>
<span id="cb12-3"><a href="#cb12-3"></a>     <span class="at">main =</span> <span class="st">"Apple stock price"</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-aspif" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-aspif-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.2: Apple stock prices, improved format.</figcaption>
</figure>
</div>
</div>
</div>
<p>We can compare Apple versus a stock index like S&amp;P500. Download the S&amp;P500 index:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>SP <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(<span class="st">"^GSPC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Plot both assets together.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">5</span>))</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="fu">plot</span>(SP<span class="sc">$</span>date, SP<span class="sc">$</span>adjusted, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="st">"red"</span>,</span>
<span id="cb14-3"><a href="#cb14-3"></a>     <span class="at">ylab =</span> <span class="st">"Standard and Poors 500 index"</span>,</span>
<span id="cb14-4"><a href="#cb14-4"></a>     <span class="at">xlab =</span> <span class="st">"Date"</span>)</span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="fu">par</span>(<span class="at">new =</span> T)</span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="fu">plot</span>(aapl_stock_prices<span class="sc">$</span>date, aapl_stock_prices<span class="sc">$</span>adjusted, </span>
<span id="cb14-7"><a href="#cb14-7"></a>     <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">axes =</span> F, <span class="at">xlab =</span> <span class="cn">NA</span>, <span class="at">ylab =</span> <span class="cn">NA</span>, <span class="at">cex =</span> <span class="fl">1.2</span>)</span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="fu">axis</span>(<span class="at">side =</span> <span class="dv">4</span>)</span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="fu">mtext</span>(<span class="at">side =</span> <span class="dv">4</span>, <span class="at">line =</span> <span class="dv">3</span>, <span class="st">"Apple stock price"</span>)</span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>,</span>
<span id="cb14-11"><a href="#cb14-11"></a>       <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"SP500"</span>, <span class="st">"Apple"</span>),</span>
<span id="cb14-12"><a href="#cb14-12"></a>       <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"black"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-aspas" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-aspas-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.3: Apple stock prices and SP500.</figcaption>
</figure>
</div>
</div>
</div>
<p>Let’s continue with the Apple stock analysis. Stock prices change throughout the trading day. This is, the open price changes every minute (sometimes in milliseconds), so the open price is normally different from the closing price. We can calculate the difference between the high and low price of each day and then show the result in a plot.</p>
<p>Create a new variable <tt><code>aapl_diff</code></tt>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>aapl_diff <span class="ot">=</span> aapl_stock_prices<span class="sc">$</span>high <span class="sc">-</span> aapl_stock_prices<span class="sc">$</span>low</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Plot the new variable.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">plot</span>(aapl_stock_prices<span class="sc">$</span>date, aapl_diff, <span class="at">type =</span> <span class="st">"h"</span>, <span class="at">xlab =</span> <span class="st">"Date"</span>, </span>
<span id="cb16-2"><a href="#cb16-2"></a>     <span class="at">ylab =</span> <span class="st">"Difference between high and low prices"</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-astv" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-astv-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.4: Apple stock trading volume.</figcaption>
</figure>
</div>
</div>
</div>
<p>The difference between high and low prices show that the stock price changes during a trading day. These changes can be considerably high. Moreover, this volatility has increased in recent times. Is it possible to know the exact date in which this difference is the highest? One alternative is to sort all observations, but there is a simpler approach.</p>
<p>Which observation has the maximum value of <tt><code>aapl_diff</code></tt>?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>highest_change <span class="ot">=</span> <span class="fu">which.max</span>(aapl_diff)</span>
<span id="cb17-2"><a href="#cb17-2"></a>highest_change</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1682</code></pre>
</div>
</div>
<p>Consider the value of <tt><code>highest_change</code></tt> as an index. This is, the number of the row that contains the highest <tt><code>aapl_diff</code></tt> value. We can use this index to extract the date and the actual <tt><code>aapl_diff</code></tt> value.</p>
<p>Extract the date and the actual value of <tt><code>aapl_diff</code></tt>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># The brackets [] are used to extract a single row value.</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>when <span class="ot">=</span> aapl_stock_prices<span class="sc">$</span>date[highest_change]</span>
<span id="cb19-3"><a href="#cb19-3"></a>when</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-09-04"</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>top <span class="ot">=</span> aapl_diff[highest_change]</span>
<span id="cb21-2"><a href="#cb21-2"></a>top</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 12.81</code></pre>
</div>
</div>
<p>The output above shows <tt><code>when</code></tt> Apple stock had its highest price change <tt><code>top</code></tt> in one day. We can use when and top variables to improve our plot.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="fu">plot</span>(aapl_stock_prices<span class="sc">$</span>date, aapl_diff, <span class="at">type =</span> <span class="st">"h"</span>, <span class="at">xlab =</span> <span class="st">"Date"</span>, </span>
<span id="cb23-2"><a href="#cb23-2"></a>     <span class="at">ylab =</span> <span class="st">"Difference between high and low prices"</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="co"># Here, we add the red point.</span></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="fu">points</span>(when, top, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">cex =</span> <span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-astvafa" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-astvafa-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.5: Apple stock trading volume a further analysis.</figcaption>
</figure>
</div>
</div>
</div>
<p>Up to know, we have been using default options as we simply ask for stock prices of Apple without any other kind of instruction. As a result, we get data starting from 2010: <tt><code>tq_get("AAPL")</code></tt>. However, we can change default options if needed to get data back to 1990. I will take some online available examples developed by the author of <tt><code>tidyquant</code></tt> Matt Dancho.</p>
<p>Download Apple stock prices.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>aapl_prices  <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(<span class="st">"AAPL"</span>, <span class="at">get =</span> <span class="st">"stock.prices"</span>, </span>
<span id="cb24-2"><a href="#cb24-2"></a>                       <span class="at">from =</span> <span class="st">" 1990-01-01"</span>)</span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="co"># Show results.</span></span>
<span id="cb24-4"><a href="#cb24-4"></a>aapl_prices</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8,565 × 8
   symbol date        open  high   low close    volume adjusted
   &lt;chr&gt;  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 AAPL   1990-01-02 0.315 0.335 0.312 0.333 183198400    0.263
 2 AAPL   1990-01-03 0.339 0.339 0.335 0.335 207995200    0.265
 3 AAPL   1990-01-04 0.342 0.346 0.333 0.336 221513600    0.266
 4 AAPL   1990-01-05 0.337 0.342 0.330 0.337 123312000    0.267
 5 AAPL   1990-01-08 0.335 0.339 0.330 0.339 101572800    0.269
 6 AAPL   1990-01-09 0.339 0.339 0.330 0.336  86139200    0.266
 7 AAPL   1990-01-10 0.336 0.336 0.319 0.321 199718400    0.255
 8 AAPL   1990-01-11 0.324 0.324 0.308 0.308 211052800    0.244
 9 AAPL   1990-01-12 0.306 0.310 0.301 0.308 171897600    0.244
10 AAPL   1990-01-15 0.308 0.319 0.306 0.306 161739200    0.242
# ℹ 8,555 more rows</code></pre>
</div>
</div>
<p>Sometimes we are interested in periodicity aggregation from daily to monthly. We cannot transform from monthly to daily, but we can always transform from daily to monthly, monthly to yearly and so on. FANG is a dataset containing the daily historical stock prices for the FANG tech stocks, FB, AMZN, NFLX, and GOOG, spanning from the beginning of 2013 through the end of 2016.</p>
<p>Let’s aggregate the pre-loaded data from daily to monthly frequency.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">data</span>(<span class="st">"FANG"</span>)</span>
<span id="cb26-2"><a href="#cb26-2"></a>FANG <span class="sc">|&gt;</span></span>
<span id="cb26-3"><a href="#cb26-3"></a>    <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4"></a>    <span class="fu">tq_transmute</span>(<span class="at">select =</span> adjusted, <span class="at">mutate_fun =</span> to.monthly, </span>
<span id="cb26-5"><a href="#cb26-5"></a>                 <span class="at">indexAt =</span> <span class="st">"lastof"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 192 × 3
# Groups:   symbol [4]
   symbol date       adjusted
   &lt;chr&gt;  &lt;date&gt;        &lt;dbl&gt;
 1 FB     2013-01-31     31.0
 2 FB     2013-02-28     27.2
 3 FB     2013-03-31     25.6
 4 FB     2013-04-30     27.8
 5 FB     2013-05-31     24.4
 6 FB     2013-06-30     24.9
 7 FB     2013-07-31     36.8
 8 FB     2013-08-31     41.3
 9 FB     2013-09-30     50.2
10 FB     2013-10-31     50.2
# ℹ 182 more rows</code></pre>
</div>
</div>
<p>The <tt><code>tidyquant</code></tt> package can also access other kinds of data from diverse sources like the Federal Reserve Economic Data (FRED). Federal Reserve Economic Data is a database maintained by the Research division of the Federal Reserve Bank of St.&nbsp;Louis that has more than 819,000 US and international time series from 110 sources. Consider the WTI Crude Oil Prices.</p>
<p>Download oil prices from FRED.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># See https://fred.stlouisfed.org/series/DCOILWTICO</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>wti_price_usd <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(<span class="st">"DCOILWTICO"</span>, <span class="at">get =</span> <span class="st">"economic.data"</span>)</span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="co"># Show results.</span></span>
<span id="cb28-4"><a href="#cb28-4"></a>wti_price_usd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,605 × 3
   symbol     date       price
   &lt;chr&gt;      &lt;date&gt;     &lt;dbl&gt;
 1 DCOILWTICO 2014-01-01  NA  
 2 DCOILWTICO 2014-01-02  95.1
 3 DCOILWTICO 2014-01-03  93.7
 4 DCOILWTICO 2014-01-06  93.1
 5 DCOILWTICO 2014-01-07  93.3
 6 DCOILWTICO 2014-01-08  91.9
 7 DCOILWTICO 2014-01-09  91.4
 8 DCOILWTICO 2014-01-10  92.4
 9 DCOILWTICO 2014-01-13  91.4
10 DCOILWTICO 2014-01-14  92.2
# ℹ 2,595 more rows</code></pre>
</div>
</div>
<p>Now that we have oil prices in basically one single step, we can plot them. It is interesting because recently the oil prices have turned negative in one day. Negative prices are rare but not impossible, especially in commodities.</p>
<p>Create a simple line plot to show the oil price evolution.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="fu">ggplot</span>(wti_price_usd, <span class="fu">aes</span>(date, price)) <span class="sc">+</span> </span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb30-3"><a href="#cb30-3"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-op" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-op-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.6: Oil prices.</figcaption>
</figure>
</div>
</div>
</div>
<p>It is easy to find out the exact day when the oil price was negative. Extract one row given a <tt><code>price</code></tt> condition.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">subset</span>(wti_price_usd, price <span class="sc">&lt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  symbol     date       price
  &lt;chr&gt;      &lt;date&gt;     &lt;dbl&gt;
1 DCOILWTICO 2020-04-20 -37.0</code></pre>
</div>
</div>
<p>Without going into technical arguments, we can interpret negative prices as the following. Imagine, as it actually happened, that storing oil is expensive, not only that, imagine oil producers have no further physical space to store oil, so they are desperate to get rid of the oil production. On the other hand, oil buyers realize that the economic perspectives in the world look bad. If the economic activity suddenly stops, then we expect a lower demand for fuel including oil as firms are producing less. Then, producers want to sell and buyers are not interested to buy as they do not need as countries have more than enough inventories. This could go to the extreme in which producers are (sadly) willing to pay people in exchange of taking the oil out of their hands. This is why commodity prices can be negative.</p>
<p>There are other explanations, for example one related to the maturity of oil futures contracts. The price that went negative on Monday 2020-04-20 was for futures contracts to be delivered in May. Those contracts expired on Tuesday 2020-04-21. Upon expiration of the futures contract, the clearinghouse matches the holder of a long contract against the holder of a short position. The short position delivers the underlying asset to the long position. So, on Monday, traders — who were not equipped to take physical deliveries — were rushing to sell them to buyers who have booked storage.</p>
<p>The <tt><code>quantmod</code></tt> package can retrieve exchange rates as well.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="co"># Download USD/MXN exchange rate from Oanda site.</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>exchange_rate <span class="ot">&lt;-</span> <span class="fu">getSymbols</span>(<span class="st">"USD/MXN"</span>, <span class="at">src =</span> <span class="st">"oanda"</span>, </span>
<span id="cb33-3"><a href="#cb33-3"></a>                            <span class="at">auto.assign =</span> <span class="cn">FALSE</span>)</span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="co"># Plot the results.</span></span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="fu">plot</span>(exchange_rate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-uer" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-uer-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.7: USD/MXN exchange rate.</figcaption>
</figure>
</div>
</div>
</div>
<p>We can show the time series information into a density plot.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="co"># Density plots.</span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="fu">ggplot</span>(exchange_rate, <span class="fu">aes</span>(<span class="at">x =</span> USD.MXN)) <span class="sc">+</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">fill =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb34-5"><a href="#cb34-5"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"USD.MXN"</span>, <span class="at">x =</span> <span class="st">"USD.MXN"</span>, <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb34-7"><a href="#cb34-7"></a>  <span class="fu">scale_fill_tq</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ueradp" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-ueradp-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.8: USD/MXN exchange rate, a density plot.</figcaption>
</figure>
</div>
</div>
</div>
<p>We can also create some interesting visualizations about US employment and the US recessions (in the shaded area) over time. The code below is not so compact but it works.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="co"># NBER Recession indicator and US nonfarm payroll employment</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>tickers<span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"USREC"</span>, <span class="st">"PAYEMS"</span>)</span>
<span id="cb35-3"><a href="#cb35-3"></a>df <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(tickers, <span class="at">get =</span> <span class="st">"economic.data"</span>, <span class="at">from =</span> <span class="st">"1948-01-01"</span>)</span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="co"># recession df (for plotting)</span></span>
<span id="cb35-5"><a href="#cb35-5"></a>recessions.df <span class="ot">=</span> <span class="fu">read.table</span>(<span class="fu">textConnection</span>(</span>
<span id="cb35-6"><a href="#cb35-6"></a>  <span class="st">"Peak, Trough</span></span>
<span id="cb35-7"><a href="#cb35-7"></a><span class="st">  1945-02-01, 1945-10-01</span></span>
<span id="cb35-8"><a href="#cb35-8"></a><span class="st">  1948-11-01, 1949-10-01</span></span>
<span id="cb35-9"><a href="#cb35-9"></a><span class="st">  1953-07-01, 1954-05-01</span></span>
<span id="cb35-10"><a href="#cb35-10"></a><span class="st">  1957-08-01, 1958-04-01</span></span>
<span id="cb35-11"><a href="#cb35-11"></a><span class="st">  1960-04-01, 1961-02-01</span></span>
<span id="cb35-12"><a href="#cb35-12"></a><span class="st">  1969-12-01, 1970-11-01</span></span>
<span id="cb35-13"><a href="#cb35-13"></a><span class="st">  1973-11-01, 1975-03-01</span></span>
<span id="cb35-14"><a href="#cb35-14"></a><span class="st">  1980-01-01, 1980-07-01</span></span>
<span id="cb35-15"><a href="#cb35-15"></a><span class="st">  1981-07-01, 1982-11-01</span></span>
<span id="cb35-16"><a href="#cb35-16"></a><span class="st">  1990-07-01, 1991-03-01</span></span>
<span id="cb35-17"><a href="#cb35-17"></a><span class="st">  2001-03-01, 2001-11-01</span></span>
<span id="cb35-18"><a href="#cb35-18"></a><span class="st">  2007-12-01, 2009-06-01</span></span>
<span id="cb35-19"><a href="#cb35-19"></a><span class="st">  2020-02-01, 2021-04-30"</span>), <span class="at">sep =</span> <span class="st">','</span>, </span>
<span id="cb35-20"><a href="#cb35-20"></a>  <span class="at">colClasses =</span> <span class="fu">c</span>(<span class="st">'Date'</span>, <span class="st">'Date'</span>), <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-21"><a href="#cb35-21"></a>rec3 <span class="ot">&lt;-</span> <span class="fu">filter</span>(df, df<span class="sc">$</span>symbol <span class="sc">==</span> <span class="st">"PAYEMS"</span>)</span>
<span id="cb35-22"><a href="#cb35-22"></a>my_trans <span class="ot">&lt;-</span> <span class="cf">function</span>(in.data,<span class="at">transform =</span> <span class="st">"pctdiff3"</span>) {</span>
<span id="cb35-23"><a href="#cb35-23"></a>  <span class="cf">switch</span>(transform, <span class="at">logdiff  =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(<span class="fu">log</span>(in.data))),       </span>
<span id="cb35-24"><a href="#cb35-24"></a>         <span class="at">pctdiff3 =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">Delt</span>(in.data, <span class="at">k =</span> <span class="dv">3</span>),</span>
<span id="cb35-25"><a href="#cb35-25"></a>        <span class="at">logdiff3 =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">3</span>), <span class="fu">diff</span>(<span class="fu">log</span>(in.data), <span class="dv">3</span>)))</span>
<span id="cb35-26"><a href="#cb35-26"></a>}</span>
<span id="cb35-27"><a href="#cb35-27"></a></span>
<span id="cb35-28"><a href="#cb35-28"></a>vlist <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"PAYEMS"</span>)</span>
<span id="cb35-29"><a href="#cb35-29"></a>df2 <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb35-30"><a href="#cb35-30"></a>  <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span></span>
<span id="cb35-31"><a href="#cb35-31"></a>  <span class="fu">mutate</span>(<span class="at">x =</span> <span class="fu">ifelse</span>(symbol <span class="sc">%in%</span> vlist, <span class="fu">my_trans</span>(price), price))</span>
<span id="cb35-32"><a href="#cb35-32"></a></span>
<span id="cb35-33"><a href="#cb35-33"></a>df2 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>price) <span class="sc">|&gt;</span> </span>
<span id="cb35-34"><a href="#cb35-34"></a>  <span class="fu">spread</span>(symbol, x) <span class="sc">|&gt;</span></span>
<span id="cb35-35"><a href="#cb35-35"></a>  <span class="fu">mutate</span>(<span class="at">REC12 =</span> <span class="fu">lead</span>(USREC, <span class="dv">12</span>)) <span class="ot">-&gt;</span> df3       </span>
<span id="cb35-36"><a href="#cb35-36"></a></span>
<span id="cb35-37"><a href="#cb35-37"></a>df41 <span class="ot">&lt;-</span> <span class="fu">filter</span>(df3, <span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="dv">1945</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We have the data, now we can plot.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df41, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> PAYEMS)) <span class="sc">+</span> </span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> recessions.df, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb36-3"><a href="#cb36-3"></a>            <span class="fu">aes</span>(<span class="at">xmin =</span> Peak, <span class="at">xmax =</span> Trough, </span>
<span id="cb36-4"><a href="#cb36-4"></a>                <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="sc">+</span><span class="cn">Inf</span>), </span>
<span id="cb36-5"><a href="#cb36-5"></a>            <span class="at">fill =</span> <span class="st">'black'</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb36-6"><a href="#cb36-6"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb36-7"><a href="#cb36-7"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span> </span>
<span id="cb36-8"><a href="#cb36-8"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">""</span>, </span>
<span id="cb36-9"><a href="#cb36-9"></a>       <span class="at">title =</span> <span class="st">"US employment growth and recessions."</span>,</span>
<span id="cb36-10"><a href="#cb36-10"></a>       <span class="at">subtitle =</span> <span class="st">"Shaded area are NBER recessions."</span>, </span>
<span id="cb36-11"><a href="#cb36-11"></a>       <span class="at">caption =</span> <span class="st">"Source: US Bureau of Labor Statistics.</span></span>
<span id="cb36-12"><a href="#cb36-12"></a><span class="st">       </span><span class="sc">\n</span><span class="st">Retrieved from FRED, Federal Reserve Bank of St. Louis."</span>) <span class="sc">+</span> </span>
<span id="cb36-13"><a href="#cb36-13"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb36-14"><a href="#cb36-14"></a>  <span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb36-15"><a href="#cb36-15"></a>        <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"italic"</span>, <span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb36-16"><a href="#cb36-16"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here we can see the magnitude of the current and upcoming financial and economic crisis. The fall in the US employment is impressive as you can see. Note how recessions (gray bars) are very closely related with falls in the employment over time.</p>
<p>Given the recent health crisis many sectors and firms in the US economy stopped or reduced operations as a way to reduce the spread of the virus. As firms produce less (or nothing), they sell less (or nothing). Firms face two kinds of costs, variable and fixed. Variable costs depend on production, so if production decreases the variable costs decreases as well. The problem here is fixed costs because they never disappear, they are fixed and they have to be paid no matter what. Some firms might have the possibility to pay fixed costs with reduced or null revenues for a while (days, weeks, probably a little bit more), but definitely not for long. I believe it is clear what happen next. Some firms did not make it, they could not survive and they simply went bankrupt and definitely closed operations. These firms had employees and now they are unemployed. Even those firms who are still operating, in some cases they had to reduce the payroll, and some employees are now unemployed. Less aggregate production and more families without an income reduce the aggregate supply and demand. This is why this current-next economic crisis has no precedent.</p>
<p>Having easy access to financial and economic data is important to facilitate the data analysis. However, it is even more important to be able to manipulate the financial and economic data correctly to communicate facts and discover new insights to make better decisions.</p>
</section>
<section id="technical-analysis." class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="technical-analysis."><span class="header-section-number">1.2</span> Technical analysis.</h2>
<p>Technical analysis is the forecasting of future financial price movements based on an examination of past price movements and volume of trading. Technical analysis is applicable to stocks, indexes, commodities, futures or any tradable instrument where the price is influenced by the forces of supply and demand. This analysis is limited because it fails to incorporate other forces and factors that can influence the price of the security. Although this analysis is limited, it is still quite popular, and given that we now know how to get financial prices, it seems convenient to illustrate the basics of technical analysis.</p>
<p>Let’s use FANG data again.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># Get AAPL and AMZN stock prices.</span></span>
<span id="cb37-2"><a href="#cb37-2"></a>AAPL <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(<span class="st">"AAPL"</span>, <span class="at">get =</span> <span class="st">"stock.prices"</span>, <span class="at">from =</span> <span class="st">"2015-09-01"</span>, </span>
<span id="cb37-3"><a href="#cb37-3"></a>               <span class="at">to =</span> <span class="st">"2016-12-31"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s begin with one plot.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>AAPL <span class="sc">|&gt;</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> close)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb38-3"><a href="#cb38-3"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Closing price"</span>, <span class="at">x =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb38-4"><a href="#cb38-4"></a>    <span class="fu">theme_tq</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-alc" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-alc-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.9: Apple line chart.</figcaption>
</figure>
</div>
</div>
</div>
<p>The plot above represents closing prices. However, we also have open and close prices per day. We could take advantage of this by plotting vertical lines per day. The length of the daily vertical lines represents the difference between the open and close prices. To make it more informative, blue lines are those cases when the close price is greater than the open price, and red lines are those cases when the close price is lower than the open price.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>AAPL <span class="sc">|&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> close)) <span class="sc">+</span></span>
<span id="cb39-3"><a href="#cb39-3"></a>  <span class="fu">geom_candlestick</span>(<span class="fu">aes</span>(<span class="at">open =</span> open, <span class="at">high =</span> high, <span class="at">low =</span> low, </span>
<span id="cb39-4"><a href="#cb39-4"></a>                       <span class="at">close =</span> close)) <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Closing Price"</span>, <span class="at">x =</span> <span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb39-6"><a href="#cb39-6"></a>  <span class="fu">theme_tq</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-acc" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-acc-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.10: Apple candlestick chart.</figcaption>
</figure>
</div>
</div>
</div>
<p>There are some blank spaces. This is simply because the close price of yesterday is not always exactly the same as the open price of today. Local stock markets close on weekends and holidays.</p>
<p>These kinds of charts are difficult to read when we have many observations. Let’s do a zoom:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>AAPL <span class="sc">|&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> close)) <span class="sc">+</span></span>
<span id="cb40-3"><a href="#cb40-3"></a>  <span class="fu">geom_candlestick</span>(<span class="fu">aes</span>(<span class="at">open =</span> open, <span class="at">high =</span> high, <span class="at">low =</span> low, </span>
<span id="cb40-4"><a href="#cb40-4"></a>                       <span class="at">close =</span> close)) <span class="sc">+</span></span>
<span id="cb40-5"><a href="#cb40-5"></a>  <span class="fu">coord_x_date</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="st">"2016-12-15"</span>, <span class="st">"2016-12-31"</span>), </span>
<span id="cb40-6"><a href="#cb40-6"></a>               <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">28.75</span>, <span class="fl">29.5</span>)) <span class="sc">+</span></span>
<span id="cb40-7"><a href="#cb40-7"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Closing Price"</span>, <span class="at">x =</span> <span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb40-8"><a href="#cb40-8"></a>  <span class="fu">theme_tq</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-accz" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-accz-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.11: Apple candlestick chart, zoom.</figcaption>
</figure>
</div>
</div>
</div>
<p>A formal interpretation is difficult given the limitations of this analysis. However, the main idea is the following. Consider the stock is increasing quickly, then it is believed that before a fall in the price, the stock will increase at a lower speed. Big blue bars are eventually followed by smaller blue bars before exhibiting a price fall (a red bar).<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> The same logic can be applied the other way around. A dramatic fall in the price eventually reach a floor. This is, big red bars are eventually followed by smaller red bars before experiencing a price increase.</p>
<p>Could you guess what will happen with the price given the chart above? Seems difficult as the last four observations are consecutive blue-red-blue-red. Then, this indicator alone, without any complementary analysis, does not seem to deliver a clear trading signal.</p>
<p>Moving averages are supposed to anticipate price movements. The idea is the following. We have two line plots, one is the original evolution of the price chart in black and the second is the moving average in blue. In this case we have a 30-day moving average. The blue line is simply the average of the last 30-day stock prices. In the code below, this value is easily modified by changing the value of <span class="math inline">\(n\)</span>, in this case <span class="math inline">\(n=30\)</span>. The blue line (moving average) seems to anticipate what happens to the black line. The way we interpret the moving average is simple. If the black line crosses the blue from top to down in <span class="math inline">\(t\)</span>, then we are expected to anticipate a drop in the stock price in <span class="math inline">\(t+1\)</span>. In case the black line remains below the blue after <span class="math inline">\(t+1\)</span>, then we expect the stock price to keep falling in the following periods.</p>
<p>If the black line crosses the blue from down to top, then we are supposed to anticipate an increase in the stock price. The sign is stronger when the black line crosses the blue line showing a steeper slope. What happens in practice is that the value of <span class="math inline">\(n\)</span> should be calibrated until we fit the moving average with the behaviour of the price stock. This indicator alone is far from being perfect as there might be a lot of contrary signals which might make it difficult to follow the interpretation as we explained above.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>AAPL <span class="sc">|&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> close)) <span class="sc">+</span></span>
<span id="cb41-3"><a href="#cb41-3"></a>  <span class="fu">geom_line</span>()  <span class="sc">+</span></span>
<span id="cb41-4"><a href="#cb41-4"></a>  <span class="fu">geom_ma</span>(<span class="at">ma_fun =</span> SMA, <span class="at">n =</span> <span class="dv">30</span>, <span class="at">linetype =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.25</span>) <span class="sc">+</span></span>
<span id="cb41-5"><a href="#cb41-5"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Closing Price"</span>, <span class="at">x =</span> <span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb41-6"><a href="#cb41-6"></a>  <span class="fu">theme_tq</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-a3dmac" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-a3dmac-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.12: Apple 30-day moving average chart.</figcaption>
</figure>
</div>
</div>
</div>
<p>There is a price fall a few weeks before January 2016 and a few weeks after January 2016. This price fall was correctly anticipated by the moving average. Then the stock price increased a bit more than 110 USD, this was also correctly anticipated by the moving average. The period around July 2016 is less clear. By the end of the time-series, the black line is above the blue, so trying to follow our previous explanation this means that we should not expect a significant drop in the stock price.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>AAPL_recent <span class="ot">&lt;-</span> <span class="fu">tq_get</span>(<span class="st">"AAPL"</span>, <span class="at">get =</span> <span class="st">"stock.prices"</span>, </span>
<span id="cb42-2"><a href="#cb42-2"></a>                      <span class="at">from =</span> <span class="st">"2016-12-30"</span>, <span class="at">to =</span> <span class="st">"2017-01-12"</span>)</span>
<span id="cb42-3"><a href="#cb42-3"></a>AAPL_recent</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 8
  symbol date        open  high   low close    volume adjusted
  &lt;chr&gt;  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 AAPL   2016-12-30  29.2  29.3  28.9  29.0 122345200     26.9
2 AAPL   2017-01-03  29.0  29.1  28.7  29.0 115127600     27.0
3 AAPL   2017-01-04  29.0  29.1  28.9  29.0  84472400     27.0
4 AAPL   2017-01-05  29.0  29.2  29.0  29.2  88774400     27.1
5 AAPL   2017-01-06  29.2  29.5  29.1  29.5 127007600     27.4
6 AAPL   2017-01-09  29.5  29.9  29.5  29.7 134247600     27.7
7 AAPL   2017-01-10  29.7  29.8  29.6  29.8  97848400     27.7
8 AAPL   2017-01-11  29.7  30.0  29.6  29.9 110354400     27.9</code></pre>
</div>
</div>
<p>The Bollinger Bands are envelopes plotted at a standard deviation level above and below a simple moving average of the price. Because the distance of the bands is based on standard deviation, they are supposed to adjust to volatility swings in the underlying price. This indicator can help us to understand the size of the expected change in the future. If the Bollinger Bands become wider then we should expect drastic changes in the stock price.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>AAPL <span class="sc">|&gt;</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> close, <span class="at">open =</span> open,</span>
<span id="cb44-3"><a href="#cb44-3"></a>             <span class="at">high =</span> high, <span class="at">low =</span> low, <span class="at">close =</span> close)) <span class="sc">+</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>  <span class="fu">geom_bbands</span>(<span class="at">ma_fun =</span> SMA, <span class="at">sd =</span> <span class="dv">2</span>, <span class="at">n =</span> <span class="dv">30</span>,</span>
<span id="cb44-6"><a href="#cb44-6"></a>              <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>,</span>
<span id="cb44-7"><a href="#cb44-7"></a>              <span class="at">fill        =</span> <span class="fu">palette_light</span>()[[<span class="dv">1</span>]],</span>
<span id="cb44-8"><a href="#cb44-8"></a>              <span class="at">color_bands =</span> <span class="fu">palette_light</span>()[[<span class="dv">1</span>]],</span>
<span id="cb44-9"><a href="#cb44-9"></a>              <span class="at">color_ma    =</span> <span class="fu">palette_light</span>()[[<span class="dv">2</span>]]) <span class="sc">+</span></span>
<span id="cb44-10"><a href="#cb44-10"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Closing Price"</span>, <span class="at">x =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb44-11"><a href="#cb44-11"></a>  <span class="fu">theme_tq</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-abbasma" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-abbasma-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.13: Apple Bollinger bands and simple moving average.</figcaption>
</figure>
</div>
</div>
</div>
<p>Let’s look at the very last observation. The price line is above the moving average (now in red, dotted line). This means that we should not expect a drop in the stock price in the following periods. However, the Bollinger Bands suggest that the price is currently very close to the upper bound, plus the upper bounds is also close to the historical maximum price at least in this plot. In sum, the last price is 115.82 USD and we do not expect a fall in the stock price according to the moving average and the expected price change is in the range of 107 to 119 USD approximately.</p>
<p>In case you may have a different view or concerns about the previous interpretation then you now realize the pitfalls and the disadvantages of this kind of analysis when it is conducted as a simple chart read. Although, the technical analysis is popular, it could lead to different interpretations easily when we interpret one or two indicators by eye. This does not mean we have to ignore this kind of analysis because we can always incorporate formal techniques to try to validate buy and sell signals to help traders and conduct short-run investment strategies. In fact, there are very serious developments like the <tt><code>quantstrat</code></tt> package, which provides a generic infrastructure to model and backtest signal-based quantitative strategies.</p>
<p>We can show the simple moving average for Facebook.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>FANG <span class="sc">|&gt;</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>  <span class="fu">filter</span>(symbol <span class="sc">==</span> <span class="st">"FB"</span>) <span class="sc">|&gt;</span></span>
<span id="cb45-3"><a href="#cb45-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> close)) <span class="sc">+</span></span>
<span id="cb45-4"><a href="#cb45-4"></a>  <span class="fu">geom_line</span>()  <span class="sc">+</span></span>
<span id="cb45-5"><a href="#cb45-5"></a>  <span class="fu">geom_ma</span>(<span class="at">ma_fun =</span> SMA, <span class="at">n =</span> <span class="dv">60</span>, <span class="at">linetype =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">1.25</span>) <span class="sc">+</span></span>
<span id="cb45-6"><a href="#cb45-6"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Closing Price"</span>, <span class="at">x =</span> <span class="st">""</span>) <span class="sc">+</span> </span>
<span id="cb45-7"><a href="#cb45-7"></a>  <span class="fu">theme_tq</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-f6dmac" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-f6dmac-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;1.14: Facebook 60-day moving average chart.</figcaption>
</figure>
</div>
</div>
</div>
<p>This suggests that the stock price will decrease in the near future. Let’s see if the moving average signal is correct.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>FANG <span class="sc">|&gt;</span></span>
<span id="cb46-2"><a href="#cb46-2"></a>  <span class="fu">filter</span>(symbol <span class="sc">==</span> <span class="st">"FB"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-3"><a href="#cb46-3"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;=</span> <span class="st">"2014-01-01"</span> <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> <span class="st">"2014-02-01"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 21 × 8
   symbol date        open  high   low close   volume adjusted
   &lt;chr&gt;  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 FB     2014-01-02  54.8  55.2  54.2  54.7 43195500     54.7
 2 FB     2014-01-03  55.0  55.7  54.5  54.6 38246200     54.6
 3 FB     2014-01-06  54.4  57.3  54.0  57.2 68852600     57.2
 4 FB     2014-01-07  57.7  58.5  57.2  57.9 77207400     57.9
 5 FB     2014-01-08  57.6  58.4  57.2  58.2 56682400     58.2
 6 FB     2014-01-09  58.7  59.0  56.7  57.2 92253300     57.2
 7 FB     2014-01-10  57.1  58.3  57.1  57.9 42449500     57.9
 8 FB     2014-01-13  57.9  58.2  55.4  55.9 63010900     55.9
 9 FB     2014-01-14  56.5  57.8  56.1  57.7 37503600     57.7
10 FB     2014-01-15  58.0  58.6  57.3  57.6 33663400     57.6
# ℹ 11 more rows</code></pre>
</div>
</div>
<p>The moving average sent the right stock price movement signal.</p>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="prices-and-returns." class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Prices and returns.</h1>
<p>An asset is any resource owned by a business or an economic entity. It is anything that can produce value (or returns) in the future. Here, we frequently use firm stocks as financial assets, but we also show other examples of assets such as commodities, currencies, bonds, derivatives, etc.</p>
<p>A return is the percentage change of an asset price. In finance, we are very interested in asset returns because it allows us to measure asset (like stocks) performance in relative terms. Consider the following example. In (1) I buy at $100 and sell at $110; and in (2) I buy at $10 and sell at $12. I make money in both situations because $110 &gt; $100 and $12 &gt; $10. But which situation is the best deal? In absolute terms, I made $10 in (1) and only $2 in (2). However, in relative terms I made 10% in (1) and a great 20% in (2).</p>
<p>The previous returns were calculated as a simple percentage change: <span class="math inline">\(\frac{\$110-\$100}{\$100}\)</span> and <span class="math inline">\(\frac{\$12-\$10}{\$10}\)</span> respectively. We can calculate log-returns instead and these are equivalent, and sometimes we prefer to calculate log-returns especially when we deal with short periods of time.</p>
<p>In this case the log-returns are <span class="math inline">\(Ln\left(\frac{\$110}{\$100}\right)\)</span> and <span class="math inline">\(Ln\left(\frac{\$12}{\$10}\right)\)</span> which are 9.53% and 18.23% respectively.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="fu">log</span>(<span class="dv">110</span><span class="sc">/</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.09531018</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="fu">log</span>(<span class="dv">12</span><span class="sc">/</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1823216</code></pre>
</div>
</div>
<p>Both absolute and relative valuations ($10 versus $2, and 10% versus 20%) are important and valid depending on what we want to report. However, the good thing about the relative approach (percentages) is that we can compare among different alternatives more easily. Returns also have some relevant statistical properties (like stationarity) that are needed to implement some quantitative financial and econometrics models.</p>
<p>Returns can be expressed in relative terms with respect to the associated asset risk. Consider another example. In (1) I have an asset with an expected return of 5% with a risk of 5%; and in (2) a different asset with an expected return of 5% with a risk of 10%. So, in relative terms (1) is an asset with 1 unit of return per unit of risk and (2) is an asset with 0.5 unit of return per unit of risk. Now, it is clear we should prefer alternative (1).</p>
<p>There are more technical reasons to work with returns, but we can proceed with our analysis. Also, there are other ways to measure and report asset returns including different frequencies, cumulative returns, compounded returns, etc., but that is something we can discuss later.</p>
<section id="from-prices-to-returns." class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="from-prices-to-returns."><span class="header-section-number">2.1</span> From prices to returns.</h2>
<p>We need time series of asset prices to calculate time series of asset returns. Let’s begin with a visual representation of the <tt><code>FANG</code></tt> database. Here, we have daily stock prices per stock.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>FANG_daily_all <span class="ot">&lt;-</span> FANG <span class="sc">|&gt;</span></span>
<span id="cb52-2"><a href="#cb52-2"></a>  <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span></span>
<span id="cb52-3"><a href="#cb52-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> adjusted, <span class="at">color =</span> symbol)) <span class="sc">+</span></span>
<span id="cb52-4"><a href="#cb52-4"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb52-5"><a href="#cb52-5"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Adjusted prices"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb52-6"><a href="#cb52-6"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb52-7"><a href="#cb52-7"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span> </span>
<span id="cb52-8"><a href="#cb52-8"></a>  <span class="fu">scale_color_tq</span>()</span>
<span id="cb52-9"><a href="#cb52-9"></a></span>
<span id="cb52-10"><a href="#cb52-10"></a>FANG_daily_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-dspnsetr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-dspnsetr-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.1: Daily stock prices - not so easy to read.</figcaption>
</figure>
</div>
</div>
</div>
<p>See how stock prices fluctuate in different ranges. It would be a mistake to prefer Amazon or Google simply because they have larger price values compared with Facebook or Netflix. Taking investment decisions based on prices could be misleading because investors are most of the time looking for returns, and in particular for an attractive risk-return combination. The vertical axis is also problematic in the plot as it is difficult to see the price evolution clearly for each stock. In sum, we do not take investment decisions based on this kind of visual representation. If we are interested to evaluate the stock performance, we need a risk-return analysis, not a price chart.</p>
<p>Let’s add one line of code to see the price time-series more clearly.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>FANG_daily <span class="ot">&lt;-</span> FANG_daily_all <span class="sc">+</span></span>
<span id="cb53-2"><a href="#cb53-2"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> symbol, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb53-3"><a href="#cb53-3"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb53-4"><a href="#cb53-4"></a></span>
<span id="cb53-5"><a href="#cb53-5"></a>FANG_daily</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-dspetr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-dspetr-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.2: Daily Stock Prices - easier to read.</figcaption>
</figure>
</div>
</div>
</div>
<p>Now it is clear that all stock prices have a positive trend over time. It is also clear that 2014 was a bad year for Amazon, Google and even Netflix. This is because the stock price decreased in the period of 2014-2015. The year 2015 was good for Amazon and Google. The main point is that this new visualization of the data can help us to compare the evolution of price per stock. Remember we still have prices and not returns. Stock returns are easily calculated in R.</p>
<p>Here, we first select adjusted prices, then transform into yearly returns.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="co"># Create yearly returns.</span></span>
<span id="cb54-2"><a href="#cb54-2"></a>FANG_annual_returns <span class="ot">&lt;-</span> FANG <span class="sc">|&gt;</span></span>
<span id="cb54-3"><a href="#cb54-3"></a>    <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span></span>
<span id="cb54-4"><a href="#cb54-4"></a>    <span class="fu">tq_transmute</span>(<span class="at">select     =</span> adjusted,</span>
<span id="cb54-5"><a href="#cb54-5"></a>                 <span class="at">mutate_fun =</span> periodReturn,</span>
<span id="cb54-6"><a href="#cb54-6"></a>                 <span class="at">period     =</span> <span class="st">"yearly"</span>,</span>
<span id="cb54-7"><a href="#cb54-7"></a>                 <span class="at">type       =</span> <span class="st">"arithmetic"</span>)</span>
<span id="cb54-8"><a href="#cb54-8"></a>FANG_annual_returns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 3
# Groups:   symbol [4]
   symbol date       yearly.returns
   &lt;chr&gt;  &lt;date&gt;              &lt;dbl&gt;
 1 FB     2013-12-31         0.952 
 2 FB     2014-12-31         0.428 
 3 FB     2015-12-31         0.341 
 4 FB     2016-12-30         0.0993
 5 AMZN   2013-12-31         0.550 
 6 AMZN   2014-12-31        -0.222 
 7 AMZN   2015-12-31         1.18  
 8 AMZN   2016-12-30         0.109 
 9 NFLX   2013-12-31         3.00  
10 NFLX   2014-12-31        -0.0721
11 NFLX   2015-12-31         1.34  
12 NFLX   2016-12-30         0.0824
13 GOOG   2013-12-31         0.550 
14 GOOG   2014-12-31        -0.0597
15 GOOG   2015-12-31         0.442 
16 GOOG   2016-12-30         0.0171</code></pre>
</div>
</div>
<p>This is what we call tidy data because (1) each variable forms a column; (2) each observation forms a row; and (3) each type of observational unit forms a table. These yearly returns are expressed in decimal notation. This means that 0.95 is in reality 95%.</p>
<p>The next chunk of code shows how to visualize the annual returns in a nice plot.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>FANG_annual_returns <span class="sc">|&gt;</span></span>
<span id="cb56-2"><a href="#cb56-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date<span class="dv">-365</span>, <span class="at">y =</span> yearly.returns, <span class="at">fill =</span> symbol)) <span class="sc">+</span></span>
<span id="cb56-3"><a href="#cb56-3"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb56-4"><a href="#cb56-4"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb56-5"><a href="#cb56-5"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb56-6"><a href="#cb56-6"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Annual returns"</span>, <span class="at">x =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb56-7"><a href="#cb56-7"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> symbol, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb56-8"><a href="#cb56-8"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span> </span>
<span id="cb56-9"><a href="#cb56-9"></a>  <span class="fu">scale_fill_tq</span>() <span class="sc">+</span></span>
<span id="cb56-10"><a href="#cb56-10"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-far" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-far-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.3: FANG: annual returns.</figcaption>
</figure>
</div>
</div>
</div>
<p>Risky stocks like these are risky because the returns change drastically from time to time. Note that here, it is easy to see that 2014 was indeed a bad year for Amazon, Google and Netflix as we anticipate when looking at the price chart. These three assets confirm what we anticipate before because we see negative returns in 2014. The year 2015 was good for Amazon and Google as we said before.</p>
<p>The question that arises now is: What would be the result of investing money in each stock during these years (starting the first day of 2013 and finishing the last day of 2016)? Yearly returns show what happens from one year to another, but we cannot tell which stock would represent the best investment strategy in these years looking at this past information. Cumulative returns can be useful to answer this question.</p>
</section>
<section id="cumulative-returns." class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="cumulative-returns."><span class="header-section-number">2.2</span> Cumulative returns.</h2>
<p>Let’s start with a brief note about working with quantities affected by percentage changes. My salary is $100 and I manage to get a 5% increase. Then my new salary is <span class="math inline">\(\$100 \times (1+0.05) = \$105\)</span>. If I do <span class="math inline">\(\$100 \times 0.05 = \$5\)</span> I only get the net increase, but what I care about is my new salary. Now I negotiate to change from full-time to part-time and agree to a salary decrease of 20%. Then, my current salary is <span class="math inline">\(\$100 \times (1+0.05) \times (1-0.2) = \$84\)</span>.</p>
<p>Imagine we invest $100 in Amazon for this period. Let’s calculate the value of our investment considering that we receive the four yearly returns listed and shown above. Remember the Amazon’s yearly returns from 2013 to 2016 are: 54.98%, −22.18%, 117.78%, 10.95% in this specific order.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a><span class="co"># Investment in USD.</span></span>
<span id="cb57-2"><a href="#cb57-2"></a>investment <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb57-3"><a href="#cb57-3"></a><span class="co"># Amazon's cumulative return in percentage.</span></span>
<span id="cb57-4"><a href="#cb57-4"></a>AMZN_cum_percentage <span class="ot">=</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.54984265</span>) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.22177086</span>) <span class="sc">*</span></span>
<span id="cb57-5"><a href="#cb57-5"></a>  (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">1.17783149</span>) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.10945565</span>) <span class="sc">-</span> <span class="dv">1</span> </span>
<span id="cb57-6"><a href="#cb57-6"></a><span class="co"># Amazon's cumulative return in USD.</span></span>
<span id="cb57-7"><a href="#cb57-7"></a>AMZN_cum_usd <span class="ot">=</span> investment <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> AMZN_cum_percentage)</span>
<span id="cb57-8"><a href="#cb57-8"></a><span class="co"># Show results.</span></span>
<span id="cb57-9"><a href="#cb57-9"></a>AMZN_cum_percentage</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.914267</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a>AMZN_cum_usd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 291.4267</code></pre>
</div>
</div>
<p>The dollar value of $100 invested in Amazon at the end of the 4 years is $291.4267. The cumulative return is 191.4267%. For the sake of clarity, we can check these values are correct by applying this return over the $100: <span class="math inline">\(\$100 \times (1+1.914267) = \$291.4267\)</span>.</p>
<p>The 191.4267% cumulative return is usually not reported as it is here because it accumulates 4 years of returns. We normally express mean returns, in this case mean yearly return. The arithmetic mean of the returns, calculated by taking the sum of the returns and dividing by 4 is:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a><span class="co"># Arithmetic mean return.</span></span>
<span id="cb61-2"><a href="#cb61-2"></a>AMZN_arith_mean_retun <span class="ot">=</span> (<span class="fl">0.54984265</span> <span class="sc">-</span> <span class="fl">0.22177086</span> <span class="sc">+</span> </span>
<span id="cb61-3"><a href="#cb61-3"></a>                         <span class="fl">1.17783149</span> <span class="sc">+</span> <span class="fl">0.10945565</span>) <span class="sc">/</span> <span class="dv">4</span></span>
<span id="cb61-4"><a href="#cb61-4"></a>AMZN_arith_mean_retun</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4038397</code></pre>
</div>
</div>
<p>Let’s reveal a problem with returns calculated as an arithmetic mean that it is sometimes disregarded. In our example, the arithmetic mean of returns is 40.38397% per year. Note that this could be misleading if we calculate the growth of a $100 investment for four years:</p>
<p>The long way.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>investment <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> AMZN_arith_mean_retun) <span class="sc">*</span> </span>
<span id="cb63-2"><a href="#cb63-2"></a>  (<span class="dv">1</span> <span class="sc">+</span> AMZN_arith_mean_retun) <span class="sc">*</span> </span>
<span id="cb63-3"><a href="#cb63-3"></a>  (<span class="dv">1</span> <span class="sc">+</span> AMZN_arith_mean_retun) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> AMZN_arith_mean_retun)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 388.3919</code></pre>
</div>
</div>
<p>The short way. ::: {.cell}</p>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a>investment <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> AMZN_arith_mean_retun) <span class="sc">^</span> <span class="dv">4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 388.3919</code></pre>
</div>
<p>:::</p>
<p>See something strange? We know that the dollar value of $100 invested in Amazon at the end of the 4 years is $291.4267. However, taking this mean arithmetic return we have $388.3919. See how problematic this could be. I can say my $100 investment in Amazon during the past 4 years was great because I get a mean return of 40.38397% per year. People might think that my money grew from $100 to $388.3919 by the end of the fourth year, whereas in reality my money grew from $100 to $291.4267.</p>
<p>The way we reconcile this difference is by calculating a geometric mean return rather than an arithmetic mean return. A geometric mean is the <span class="math inline">\(n\)</span>-th root of the product of <span class="math inline">\(n\)</span> numbers. In particular:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a><span class="co"># Geometric mean return.</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>AMZN_geom_mean_retun <span class="ot">=</span> ((<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.54984265</span>) <span class="sc">*</span> (<span class="dv">1</span><span class="fl">-0.22177086</span>) <span class="sc">*</span> </span>
<span id="cb67-3"><a href="#cb67-3"></a>                        (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">1.17783149</span>) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fl">0.10945565</span>)) <span class="sc">^</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb67-4"><a href="#cb67-4"></a>AMZN_geom_mean_retun</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3065689</code></pre>
</div>
</div>
<p>I can say my $100 investment in Amazon during the past 4 years was great because I get a mean (geometric) return of 30.65689% per year. People might think that my money grew from $100 to $291.4267 by the end of the fourth year, and this is correct. Let’s verify the procedure.</p>
<p>The long way.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a>investment <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> AMZN_geom_mean_retun) <span class="sc">*</span> </span>
<span id="cb69-2"><a href="#cb69-2"></a>  (<span class="dv">1</span> <span class="sc">+</span> AMZN_geom_mean_retun) <span class="sc">*</span> </span>
<span id="cb69-3"><a href="#cb69-3"></a>  (<span class="dv">1</span> <span class="sc">+</span> AMZN_geom_mean_retun) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> AMZN_geom_mean_retun)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 291.4267</code></pre>
</div>
</div>
<p>The short way.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a>investment <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> AMZN_geom_mean_retun) <span class="sc">^</span> <span class="dv">4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 291.4267</code></pre>
</div>
</div>
<p>This phenomenon is an example of a result that is well known in mathematics. The geometric mean of a set of numbers is always less than the arithmetic mean (30.6 &lt; 40.3). Although our arithmetic mean return of 40.38397% can lead to an overestimation of the investment dollar returns, we usually report mean returns. This is a common issue when reporting mutual funds returns as it is tempting to report arithmetic mean returns because they are higher. This is why in some jurisdictions, regulations require fund managers to report geometric mean returns instead, 30.65689% in this case.</p>
<p>For now, we will work with arithmetic returns. Let’s see How $100 investment growth each year per stock. Note that the plotted values are in USD.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a><span class="co"># Yearly returns.</span></span>
<span id="cb73-2"><a href="#cb73-2"></a>FANG_annual_returns <span class="ot">&lt;-</span> FANG <span class="sc">|&gt;</span></span>
<span id="cb73-3"><a href="#cb73-3"></a>    <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span></span>
<span id="cb73-4"><a href="#cb73-4"></a>    <span class="fu">tq_transmute</span>(<span class="at">select     =</span> adjusted,</span>
<span id="cb73-5"><a href="#cb73-5"></a>                 <span class="at">mutate_fun =</span> periodReturn,</span>
<span id="cb73-6"><a href="#cb73-6"></a>                 <span class="at">period     =</span> <span class="st">"yearly"</span>,</span>
<span id="cb73-7"><a href="#cb73-7"></a>                 <span class="at">type       =</span> <span class="st">"arithmetic"</span>)</span>
<span id="cb73-8"><a href="#cb73-8"></a><span class="co"># Cumulative returns.</span></span>
<span id="cb73-9"><a href="#cb73-9"></a>FANG_annual_cum_returns <span class="ot">&lt;-</span> FANG_annual_returns <span class="sc">|&gt;</span></span>
<span id="cb73-10"><a href="#cb73-10"></a>  <span class="fu">mutate</span>(<span class="at">cr =</span> <span class="dv">100</span><span class="sc">*</span><span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">+</span> yearly.returns)) <span class="sc">|&gt;</span></span>
<span id="cb73-11"><a href="#cb73-11"></a><span class="co"># Plot the results.</span></span>
<span id="cb73-12"><a href="#cb73-12"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date<span class="dv">-365</span>, <span class="at">y =</span> cr, <span class="at">fill =</span> symbol)) <span class="sc">+</span> <span class="fu">geom_col</span>() <span class="sc">+</span> </span>
<span id="cb73-13"><a href="#cb73-13"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"100 USD investment growth from 2013-01-01 to 2016-12-31."</span>,</span>
<span id="cb73-14"><a href="#cb73-14"></a>  <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"USD value at the end of the year"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb73-15"><a href="#cb73-15"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb73-16"><a href="#cb73-16"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> symbol, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb73-17"><a href="#cb73-17"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span> </span>
<span id="cb73-18"><a href="#cb73-18"></a>  <span class="fu">scale_color_tq</span>() <span class="sc">+</span></span>
<span id="cb73-19"><a href="#cb73-19"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb73-20"><a href="#cb73-20"></a></span>
<span id="cb73-21"><a href="#cb73-21"></a>FANG_annual_cum_returns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ycurafv" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-ycurafv-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.4: Yearly cumulative USD returns, a facet view.</figcaption>
</figure>
</div>
</div>
</div>
<p>Please verify that the dollar value of $100 invested in Amazon at the end of the 4 years is $291.4267, as we discussed before.</p>
<p>We can also modify the code above to show monthly returns instead of yearly.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a><span class="co"># Monthly returns.</span></span>
<span id="cb74-2"><a href="#cb74-2"></a>FANG_monthly_returns <span class="ot">&lt;-</span> FANG <span class="sc">|&gt;</span></span>
<span id="cb74-3"><a href="#cb74-3"></a>    <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span></span>
<span id="cb74-4"><a href="#cb74-4"></a>    <span class="fu">tq_transmute</span>(<span class="at">select     =</span> adjusted,</span>
<span id="cb74-5"><a href="#cb74-5"></a>                 <span class="at">mutate_fun =</span> periodReturn,</span>
<span id="cb74-6"><a href="#cb74-6"></a>                 <span class="at">period     =</span> <span class="st">"monthly"</span>,</span>
<span id="cb74-7"><a href="#cb74-7"></a>                 <span class="at">type       =</span> <span class="st">"arithmetic"</span>)</span>
<span id="cb74-8"><a href="#cb74-8"></a><span class="co"># Plot the results.</span></span>
<span id="cb74-9"><a href="#cb74-9"></a><span class="fu">ggplot</span>(FANG_monthly_returns, <span class="fu">aes</span>(<span class="at">x =</span> date<span class="dv">-12</span>, </span>
<span id="cb74-10"><a href="#cb74-10"></a>       <span class="at">y =</span> monthly.returns, <span class="at">fill =</span> symbol)) <span class="sc">+</span></span>
<span id="cb74-11"><a href="#cb74-11"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb74-12"><a href="#cb74-12"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb74-13"><a href="#cb74-13"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb74-14"><a href="#cb74-14"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Monthly returns"</span>, <span class="at">x =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb74-15"><a href="#cb74-15"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> symbol, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb74-16"><a href="#cb74-16"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span> </span>
<span id="cb74-17"><a href="#cb74-17"></a>  <span class="fu">scale_fill_tq</span>() <span class="sc">+</span></span>
<span id="cb74-18"><a href="#cb74-18"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fmrafv" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fmrafv-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.5: FANG: monthly returns, a facet view.</figcaption>
</figure>
</div>
</div>
</div>
<p>By increasing the frequency from yearly to monthly we now have 12 observations per month instead of 1. Note that this new plot reveals how volatile these stock returns are. There is a negative return just the month after GOOG reached a positive 20% return. It looks hard to anticipate what will happen the next month since there is evidence that these returns change from positive to negative quite frequently.</p>
<p>Let’s see cumulative monthly returns per stock to extend our $100 investment example.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1"></a><span class="co"># Calculate monthly cumulative returns.</span></span>
<span id="cb75-2"><a href="#cb75-2"></a>FANG_monthly_cum_returns <span class="ot">&lt;-</span> FANG_monthly_returns <span class="sc">|&gt;</span></span>
<span id="cb75-3"><a href="#cb75-3"></a>  <span class="fu">mutate</span>(<span class="at">cr =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">+</span> monthly.returns))</span>
<span id="cb75-4"><a href="#cb75-4"></a><span class="co"># Plot results.</span></span>
<span id="cb75-5"><a href="#cb75-5"></a>FANG_monthly_all <span class="ot">&lt;-</span> FANG_monthly_cum_returns <span class="sc">|&gt;</span></span>
<span id="cb75-6"><a href="#cb75-6"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date<span class="dv">-12</span>, <span class="at">y =</span> cr, <span class="at">color =</span> symbol)) <span class="sc">+</span></span>
<span id="cb75-7"><a href="#cb75-7"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb75-8"><a href="#cb75-8"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">"2012-12-31"</span>), <span class="at">y =</span> <span class="dv">100</span>), </span>
<span id="cb75-9"><a href="#cb75-9"></a>             <span class="at">size =</span> <span class="dv">4</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb75-10"><a href="#cb75-10"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"100 USD investment growth from 2013-01-01 to 2016-12-31."</span>,</span>
<span id="cb75-11"><a href="#cb75-11"></a>         <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"USD value at the end of the month"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb75-12"><a href="#cb75-12"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb75-13"><a href="#cb75-13"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span> </span>
<span id="cb75-14"><a href="#cb75-14"></a>  <span class="fu">scale_color_tq</span>()</span>
<span id="cb75-15"><a href="#cb75-15"></a></span>
<span id="cb75-16"><a href="#cb75-16"></a>FANG_monthly_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-mcur" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-mcur-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.6: Monthly cumulative USD returns.</figcaption>
</figure>
</div>
</div>
</div>
<p>Alternatively, we can split the plot in four panels. This facilitates the reading of the plot.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a>FANG_monthly <span class="ot">&lt;-</span> FANG_monthly_all <span class="sc">+</span></span>
<span id="cb76-2"><a href="#cb76-2"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> symbol, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb76-3"><a href="#cb76-3"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb76-4"><a href="#cb76-4"></a></span>
<span id="cb76-5"><a href="#cb76-5"></a>FANG_monthly</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-mcurafv" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-mcurafv-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.7: Monthly cumulative USD returns, a facet view.</figcaption>
</figure>
</div>
</div>
</div>
<p>Again, please verify that the dollar value of $100 invested in Amazon at the end of the 4 years is $291.4267, as we discussed before. Here, we can see the USD evolution of my investment every month.</p>
<p>Remember this plot?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a>FANG_daily_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-dspnsetra" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-dspnsetra-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.8: Daily stock prices - not so easy to read (again).</figcaption>
</figure>
</div>
</div>
</div>
<p>Netflix stock price remains down all the time. However, $100 invested in Netflix during these 4 year would lead to the highest value of almost $1,000. This is why we should conduct a return analysis to make investment decisions.</p>
<p>Plotting prices and returns over time is revealing because we can see the evolution of the stock performance over time. It is useful because we could analyze what happens on specific dates to better understand the behaviour of stocks. Remember 2014 was a bad year for Amazon and Google, it would be interesting to investigate what went wrong then so we can better understand the determinants of the firm’s value.</p>
</section>
<section id="distribution-of-returns." class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="distribution-of-returns."><span class="header-section-number">2.3</span> Distribution of returns.</h2>
<p>Although time series plots represent a useful tool for financial analysis, it is not the only way we can show stock returns. Density plots forget about time and show the distribution of values. The height (vertical axis) represents how frequent a given return (horizontal axis) is. This approach is useful when we are interested to know the most likely return that the stock can have, how unlikely is to expect determined return values, how risky a specific stock return is.</p>
<p>Let’s visualize a density plot for the <tt><code>FANG</code></tt> data.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a><span class="fu">ggplot</span>(FANG_monthly_returns, <span class="fu">aes</span>(<span class="at">x =</span> monthly.returns, <span class="at">fill =</span> symbol)) <span class="sc">+</span></span>
<span id="cb78-2"><a href="#cb78-2"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb78-3"><a href="#cb78-3"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="fu">palette_light</span>()[[<span class="dv">1</span>]]) <span class="sc">+</span></span>
<span id="cb78-4"><a href="#cb78-4"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Monthly returns"</span>, <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span> </span>
<span id="cb78-5"><a href="#cb78-5"></a>  <span class="fu">xlim</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb78-6"><a href="#cb78-6"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span> </span>
<span id="cb78-7"><a href="#cb78-7"></a>  <span class="fu">scale_fill_tq</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fmradv" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fmradv-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.9: FANG: monthly returns, a density view.</figcaption>
</figure>
</div>
</div>
</div>
<p>Note that monthly returns around zero are frequent, whereas monthly returns above 50% are very infrequent. Apparently, this 50% value is red, so this should be the case of Facebook. It is also noteworthy to mention that Netflix has the higher monthly return dispersion of all. If this is not clear enough, we can add one line to the code to make it clearer.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1"></a><span class="co"># Density plots.</span></span>
<span id="cb79-2"><a href="#cb79-2"></a><span class="fu">ggplot</span>(FANG_monthly_returns, <span class="fu">aes</span>(<span class="at">x =</span> monthly.returns, <span class="at">fill =</span> symbol)) <span class="sc">+</span></span>
<span id="cb79-3"><a href="#cb79-3"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb79-4"><a href="#cb79-4"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb79-5"><a href="#cb79-5"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Monthly returns"</span>, <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span> </span>
<span id="cb79-6"><a href="#cb79-6"></a>  <span class="fu">xlim</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb79-7"><a href="#cb79-7"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span> </span>
<span id="cb79-8"><a href="#cb79-8"></a>  <span class="fu">scale_fill_tq</span>() <span class="sc">+</span> </span>
<span id="cb79-9"><a href="#cb79-9"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> symbol, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb79-10"><a href="#cb79-10"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fmradafv" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fmradafv-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.10: FANG: monthly returns, a density and facet view.</figcaption>
</figure>
</div>
</div>
</div>
<p>Now, we have one density plot for each stock. Let’s analyze each plot.</p>
<ul>
<li>AMZN. Note the highest value is zero, this suggests that the most frequent return value is around zero. The majority of observations are within −25% and 25%, and there are only a very few returns higher than 25%.</li>
<li>GOOG. As in the case of AMZN, the most frequent return value is around zero. Contrary to AMZN, there are no monthly returns higher than 25%. GOOG shows a less dispersed distribution so it is less risky than AMZN.</li>
<li>FB. The highest value is slightly above zero, this means that the average return should be higher compared with AMZN and GOOG. However, FB exhibits a greater dispersion of returns as there are a few around 50%.</li>
<li>NFLX. This is the most riskiest asset compared with the rest as the monthly returns have a wide dispersion.</li>
</ul>
<p>Density distributions are useful to have an idea about the overall risk and return of assets as they summarize 48 observations (in this case 12 observations per year, <span class="math inline">\(12 \times 4\)</span>). Some may argue 48 observations are not enough to conduct a financial analysis.</p>
<p>Here is another way to show the returns.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1"></a>FANG_monthly_returns <span class="sc">|&gt;</span></span>
<span id="cb80-2"><a href="#cb80-2"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.factor</span>(<span class="fu">year</span>(date))) <span class="sc">|&gt;</span></span>
<span id="cb80-3"><a href="#cb80-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> monthly.returns, <span class="at">fill =</span> symbol)) <span class="sc">+</span></span>
<span id="cb80-4"><a href="#cb80-4"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb80-5"><a href="#cb80-5"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb80-6"><a href="#cb80-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Monthly returns"</span>, <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span> <span class="fu">xlim</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb80-7"><a href="#cb80-7"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span> </span>
<span id="cb80-8"><a href="#cb80-8"></a>  <span class="fu">scale_fill_tq</span>() <span class="sc">+</span> </span>
<span id="cb80-9"><a href="#cb80-9"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> year, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fmrdpy" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fmrdpy-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.11: FANG: Monthly return distribution per year.</figcaption>
</figure>
</div>
</div>
</div>
<p>Now, let’s propose some statistical indicators to complement our previous analysis.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a><span class="co"># Calculate relevant statistics.</span></span>
<span id="cb81-2"><a href="#cb81-2"></a>FANG_stats <span class="ot">&lt;-</span> FANG_monthly_returns <span class="sc">|&gt;</span></span>
<span id="cb81-3"><a href="#cb81-3"></a><span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(monthly.returns), <span class="at">sd =</span> <span class="fu">sd</span>(monthly.returns), </span>
<span id="cb81-4"><a href="#cb81-4"></a>          <span class="at">sr =</span> mean<span class="sc">/</span>sd, <span class="at">iqr =</span> <span class="fu">IQR</span>(monthly.returns))</span>
<span id="cb81-5"><a href="#cb81-5"></a>FANG_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  symbol   mean     sd    sr    iqr
  &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1 AMZN   0.0257 0.0817 0.314 0.126 
2 FB     0.0341 0.0989 0.345 0.108 
3 GOOG   0.0176 0.0594 0.296 0.0646
4 NFLX   0.0592 0.167  0.355 0.193 </code></pre>
</div>
</div>
<p>The mean is basically a measure of an expected return of the stock. The stock with the lowest mean is GOOG and the highest is NFLX. This is consistent with our previous graphical analysis. GOOG expected return is very close to zero, whereas NFLX expected return is definitely higher as the highest value corresponds to a positive return. The standard deviation <tt><code>sd</code></tt> is a measure of how disperse are the returns or in financial terms, how risky are the returns. The stock with less risk is GOOG and the stock with highest risk is NFLX. This is also consistent with our previous graphical analysis. <tt><code>IQR</code></tt> is the interquartile range which is the first quartile subtracted from the third quartile.</p>
<p>Comparing return and risk, or mean and standard deviation of stock returns can be troublesome. This is because the relationship between risk and return is not perfectly proportional.</p>
<p>Let’s see the risk and return in a plot.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a><span class="co"># Mean variance plot.</span></span>
<span id="cb83-2"><a href="#cb83-2"></a>FANG_stats <span class="sc">|&gt;</span></span>
<span id="cb83-3"><a href="#cb83-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sd, <span class="at">y =</span> mean, <span class="at">color =</span> symbol)) <span class="sc">+</span></span>
<span id="cb83-4"><a href="#cb83-4"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb83-5"><a href="#cb83-5"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(sr, <span class="dv">3</span>))), </span>
<span id="cb83-6"><a href="#cb83-6"></a>            <span class="at">vjust =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb83-7"><a href="#cb83-7"></a>  <span class="fu">xlim</span>(<span class="fl">0.04</span>, <span class="fl">0.18</span>) <span class="sc">+</span> </span>
<span id="cb83-8"><a href="#cb83-8"></a>  <span class="fu">ylim</span>(<span class="fl">0.01</span>, <span class="fl">0.06</span>) <span class="sc">+</span></span>
<span id="cb83-9"><a href="#cb83-9"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Numerical values represent return per unit of risk."</span>,</span>
<span id="cb83-10"><a href="#cb83-10"></a>       <span class="at">x =</span> <span class="st">"Risk"</span>, <span class="at">y =</span> <span class="st">"Expected return"</span>) <span class="sc">+</span> </span>
<span id="cb83-11"><a href="#cb83-11"></a>  <span class="fu">theme_tq</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fthtrthtr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fthtrthtr-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.12: FANG: the higher the risk, the higher the return.</figcaption>
</figure>
</div>
</div>
</div>
<p>According to our results, Netflix is the stock with the highest return and risk. Does this mean Netflix has the highest return per unit of risk? This is easy to find out by dividing the mean by the standard deviation. This indicator is called <tt><code>sr</code></tt> in the table above. According to this, Netflix has the highest return per unit of risk compared with the rest of the stocks. This is clearly consistent with our previous analysis of cumulative returns.</p>
<p>The plot above measures returns in <span class="math inline">\(y\)</span>-axis and risk in <span class="math inline">\(x\)</span>-axes. In finance, we call this a mean-variance approach as mean is the measure of return and variance, or its square root the standard deviation, is the measure of risk. The mean-variance approach was a breakthrough in finance because we can clearly compare any kind of assets under the basis of risk and return.</p>
<p>Imagine stock 1 has a return of 5% and a risk of 4%, whereas stock 2 has a return of 6% and a risk of 8%. Although stock 2 has a higher return, this return does not compensate for the increase in the risk. In particular stock 1 has a 1.25 return per unit of risk (5/4), and stock 2 has a 0.75 return per unit of risk. In this case, we would prefer to invest our money in stock 1. Again, the relative values are useful to make decisions. Here the relative value is stock return per unit of risk.</p>
<p>Note how we can differentiate between a less risky and a riskier asset returns by looking at their correspondent distributions. Let’s highlight these principles by using a brief example. Below we simulate a couple of asset returns by generating random values. Both artificially created assets have the same return of 0% and one is riskier than the other.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1"></a><span class="co"># Create random assets.</span></span>
<span id="cb84-2"><a href="#cb84-2"></a>less_risky <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">length =</span> <span class="fu">rnorm</span>(<span class="dv">10000</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb84-3"><a href="#cb84-3"></a>more_risky <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">length =</span> <span class="fu">rnorm</span>(<span class="dv">10000</span>, <span class="dv">0</span>, <span class="dv">2</span>))</span>
<span id="cb84-4"><a href="#cb84-4"></a><span class="co"># Name random assets.</span></span>
<span id="cb84-5"><a href="#cb84-5"></a>less_risky<span class="sc">$</span>asset <span class="ot">&lt;-</span> <span class="st">'Less risky asset'</span></span>
<span id="cb84-6"><a href="#cb84-6"></a>more_risky<span class="sc">$</span>asset <span class="ot">&lt;-</span> <span class="st">'Riskier asset'</span></span>
<span id="cb84-7"><a href="#cb84-7"></a>assets <span class="ot">&lt;-</span> <span class="fu">rbind</span>(less_risky, more_risky)</span>
<span id="cb84-8"><a href="#cb84-8"></a><span class="co"># Plot the assets.</span></span>
<span id="cb84-9"><a href="#cb84-9"></a><span class="fu">ggplot</span>(assets, <span class="fu">aes</span>(length, <span class="at">fill =</span> asset)) <span class="sc">+</span> </span>
<span id="cb84-10"><a href="#cb84-10"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">adjust =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb84-11"><a href="#cb84-11"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ri" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-ri-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;2.13: Risk illustration.</figcaption>
</figure>
</div>
</div>
</div>
<p>The risky asset can take a wider range of returns. In particular, the risky asset can take values ranging approximately from −7% to +7%, whereas the less risky asset about −3% to +3%. In the code above we ask R to generate 10,000 random values following a normal distribution with mean zero, and a standard deviation of 1% and 2% for the less and riskier asset respectively.</p>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="asset-pricing." class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Asset pricing.</h1>
<p>The aim of asset pricing theories is to determine the fundamental value of an asset. There is a close relation between this fundamental value and an appropriate return. Then, the main focus of asset pricing theories and models is to determine this appropriate return. Most models relate expected returns to risks investors have to bear and have to be compensated for. They differ mainly in the risk factors they allow to enter into the model.</p>
<p>Although a large number of risk factors have been proposed in the literature and many models are used, none of the presented models or any other models used by practitioners are able to explain the observed asset prices or returns sufficiently. While most models work quite well for time horizons of more than a year, they fail in explaining short term movements.</p>
<section id="what-drives-asset-return-changes" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="what-drives-asset-return-changes"><span class="header-section-number">3.1</span> What drives asset return changes?</h2>
<p>What drives asset return changes? This is a big question in finance. Stock returns change as expectations of the stock market participants (buyers and sellers) change. Good or positive expectations can be interpreted as an opportunity for investors to buy now looking to generate a profit in the future. Positive expectations could increase the demand for this stock, the stock price increases and the return increases as well. Negative expectations could increase the supply for this stock as stock market participants are now willing to sell the stock before the stock price falls. An increase in the supply decreases the stock price and the return. In practice, supply and demand of a given stock change at the same time and at different magnitudes most of the time, so it is not easy to explain and anticipate changes in asset returns.</p>
<p>Expectations are fueled by information, and information comes from data analysis in many forms including business news, macroeconomic news, new financial information of the firm available, market conditions, rumors, fake news, tweets, and many more. This data is subject to a wide variety of financial analysis and models, so it is not uncommon that one investor anticipates a price fall whereas others anticipate a price increase. Again, it is not easy to explain and anticipate changes in returns as measuring expectations seems like a complicated task. We can argue that changes in risk factors change expectations so risk factors drive changes in asset returns. Let’s elaborate more on these risk factors.</p>
<p>Consider an extreme example about what we mean by explaining and anticipating changes in stock returns. Let’s say someone has been awake for the last 24 hours and is driving after drinking too much alcohol. Here, we have two well known risk factors that can anticipate and explain a potential car accident. Anybody under any circumstances is exposed to a car accident, but here there are two very clear risk factors that explain and anticipate a potential car accident. Knowing the relevant and most important risk factors is important because we can teach young people how to avoid car accidents and if we do it very well, we could even decrease the rate of car accidents. There might be many risk factors but surely there are some more significant than others. Consider driving while listening to music at a high volume. I think it is not crazy to assume that driving drunk is more dangerous than driving while listening to music at a high volume. It sounds reasonable to assume that adding two risk factors like lack of sleep and alcohol increases the chances of a car accident significantly.</p>
<p>Asset pricing and financial econometrics are usually combined in order to find out the risk factors of stock return changes (among other things). A typical risk factor is firm size. In particular, there is some evidence that suggests that small firms have higher returns than big firms. The industry is also considered as a risk factor as there are some industries which exhibit consistently lower returns than others. There are also some financial ratios that can be interpreted as risk factors for stock returns. In sum, we have some understanding of the risk factors of stock returns but we still need to learn more about this topic.</p>
<p>Why are we interested to explain and anticipate changes in stock returns? Remember the value of stocks are directly related with firm’s equity, and firm’s equity with firm size and performance. In finance and economics, we are interested that firms can grow and perform well because they represent not only a supply for goods and services but they also represent new job opportunities. The population in most countries is increasing so we need more and better job opportunities. As long as more families can get more and better job conditions they could (if other conditions hold) increase their living standards. Firms are also a source of innovation, research and knowledge so they play a very important role in the economy. Therefore, as long as we understand what drives stock returns can help us to understand the evolution of the whole economy and this is closely related with the people’s standards of living. At the end, we should care about the firm performance not because we are interested in having money machines, but because we should aim to transform this value increase into better living conditions for families.</p>
<p>Firms are not always good for the economy. Firms are run by individuals and individuals can be greedy sometimes. Firms can also make wrong decisions because they simply fail to conduct a correct analysis. Just before the US credit crunch 2007-2008 crisis, banks were interested in allocate sub-prime mortgages in order to transform them and sell them as <em>new</em> assets called asset back securities. This securitization process allowed banks to sell the credit risk to others in a not so transparent process and mechanism. Let me explain. Every mortgage represents an account payable for the bank because a family is expected to pay for that loan. Accounts payable are boring in the sense that you have to wait until you get paid, plus they are risky because families may default. By implementing a securitization, the bank can literally collect plenty of accounts payable or sub-prime mortgages and create one single new asset that can be sold. If you buy this asset you will have to pay the bank an amount of money today, in exchange you will get future payments for a number of years in the future. You might be interested in this deal because the future payments are attractive compared with the price of this new asset.</p>
<p>What happened then was that the borrowers default, sub-prime mortgages were not paid, asset back securities investors lost their money, and we fall into a global recession. This is relevant for us because credit rating agencies failed to assign a good estimate of the risk of asset back securities. In particular, they reported that these assets had a very high credit rating whereas in reality they were basically junk in the form of sub-prime mortgages. In some cases, they reported the same credit rating as bonds, and this is just crazy. This missvaluation (or overvaluation) of the asset back securities motivated people to invest in these assets as they believed they were a bargain (high return and low risk assets), but in reality, they were simply high return and very high risky assets. This is why we need to understand what drives asset returns. And this is also why we argue that firms are not always good for the economy.</p>
<p>Let’s come back to our main objective which are the stock returns drivers, and apply a simple approach to start. We know that there are certain stocks that behave similarly. Consider Mastercard and Visa. Visa and MasterCard are the two largest payment processing networks in the world, they do not issue cards directly to the public, as do Discover and American Express, but rather through member financial institutions. Therefore, it is easy to understand that these two firms belong to the same industry, and they are exposed to very similar risk factors at the same time. In principle, if these firms are similar, their respective stock returns might behave similar as well. We may argue that the change of the returns of one can be explained by the change of the returns of the other.</p>
<p>Let’s see how similar these two firms are by looking at their respective cumulative returns in a similar way as we did with FANG stocks. We first download the price data.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a><span class="co"># Download the price data.</span></span>
<span id="cb85-2"><a href="#cb85-2"></a>stock_prices_MA_V <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"MA"</span>, <span class="st">"V"</span>) <span class="sc">|&gt;</span></span>
<span id="cb85-3"><a href="#cb85-3"></a>    <span class="fu">tq_get</span>(<span class="at">get  =</span> <span class="st">"stock.prices"</span>, <span class="at">from =</span> <span class="st">"2015-01-01"</span>,</span>
<span id="cb85-4"><a href="#cb85-4"></a>           <span class="at">to   =</span> <span class="st">"2016-12-31"</span>) <span class="sc">|&gt;</span></span>
<span id="cb85-5"><a href="#cb85-5"></a>    <span class="fu">group_by</span>(symbol)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then transform prices into cumulative returns and plot them.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1"></a><span class="co"># Transform prices into log returns.</span></span>
<span id="cb86-2"><a href="#cb86-2"></a>stock_cumret_MA_V <span class="ot">&lt;-</span> stock_prices_MA_V <span class="sc">|&gt;</span></span>
<span id="cb86-3"><a href="#cb86-3"></a>    <span class="fu">tq_transmute</span>(adjusted,</span>
<span id="cb86-4"><a href="#cb86-4"></a>                 periodReturn,</span>
<span id="cb86-5"><a href="#cb86-5"></a>                 <span class="at">period =</span> <span class="st">"daily"</span>,</span>
<span id="cb86-6"><a href="#cb86-6"></a>                 <span class="at">type =</span> <span class="st">"log"</span>,</span>
<span id="cb86-7"><a href="#cb86-7"></a>                 <span class="at">col_rename =</span> <span class="st">"returns"</span>) <span class="sc">|&gt;</span></span>
<span id="cb86-8"><a href="#cb86-8"></a><span class="co"># Create the wealth index.</span></span>
<span id="cb86-9"><a href="#cb86-9"></a>    <span class="fu">mutate</span>(<span class="at">wealth.index =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">+</span> returns))</span>
<span id="cb86-10"><a href="#cb86-10"></a><span class="co"># Visualize the wealth index.</span></span>
<span id="cb86-11"><a href="#cb86-11"></a><span class="fu">ggplot</span>(stock_cumret_MA_V, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> wealth.index, <span class="at">color =</span> symbol)) <span class="sc">+</span></span>
<span id="cb86-12"><a href="#cb86-12"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb86-13"><a href="#cb86-13"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">"2015-01-01"</span>), <span class="at">y =</span> <span class="dv">100</span>), </span>
<span id="cb86-14"><a href="#cb86-14"></a>             <span class="at">size =</span> <span class="dv">4</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb86-15"><a href="#cb86-15"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"100 USD investment growth from 2015-01-01 to 2016-12-31."</span>) <span class="sc">+</span></span>
<span id="cb86-16"><a href="#cb86-16"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span> </span>
<span id="cb86-17"><a href="#cb86-17"></a>  <span class="fu">scale_color_tq</span>() <span class="sc">+</span></span>
<span id="cb86-18"><a href="#cb86-18"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-mavwi" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-mavwi-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.1: MA and V: wealth index.</figcaption>
</figure>
</div>
</div>
</div>
<p>Apparently, these stock returns are indeed closely related. Ups and downs are very similar in this time-series. These are the exact values:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a><span class="co"># Last values of the wealth index.</span></span>
<span id="cb87-2"><a href="#cb87-2"></a>stock_cumret_MA_V <span class="sc">|&gt;</span></span>
<span id="cb87-3"><a href="#cb87-3"></a>  <span class="fu">select</span>(<span class="sc">-</span>returns) <span class="sc">|&gt;</span></span>
<span id="cb87-4"><a href="#cb87-4"></a>  <span class="fu">spread</span>(symbol, wealth.index) <span class="sc">|&gt;</span></span>
<span id="cb87-5"><a href="#cb87-5"></a>  <span class="fu">tail</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  date          MA     V
  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt;
1 2016-12-22  118.  114.
2 2016-12-23  119.  114.
3 2016-12-27  119.  114.
4 2016-12-28  118.  114.
5 2016-12-29  118.  114.
6 2016-12-30  117.  114.</code></pre>
</div>
</div>
<p>The 100 USD investment growth is basically the same in both assets by the end of the investment period.</p>
<p>Let’s see the daily returns of both stocks in a scatter plot now. This allows us to confirm if both stock returns are related.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a><span class="co"># Show the return relationship.</span></span>
<span id="cb89-2"><a href="#cb89-2"></a>stock_ret_MA_V <span class="ot">&lt;-</span> stock_prices_MA_V <span class="sc">|&gt;</span></span>
<span id="cb89-3"><a href="#cb89-3"></a>    <span class="fu">tq_transmute</span>(<span class="at">select     =</span> adjusted,</span>
<span id="cb89-4"><a href="#cb89-4"></a>                 <span class="at">mutate_fun =</span> periodReturn,</span>
<span id="cb89-5"><a href="#cb89-5"></a>                 <span class="at">period     =</span> <span class="st">"daily"</span>,</span>
<span id="cb89-6"><a href="#cb89-6"></a>                 <span class="at">type       =</span> <span class="st">"log"</span>,</span>
<span id="cb89-7"><a href="#cb89-7"></a>                 <span class="at">col_rename =</span> <span class="st">"returns"</span>) </span>
<span id="cb89-8"><a href="#cb89-8"></a></span>
<span id="cb89-9"><a href="#cb89-9"></a><span class="fu">ggplot</span>(stock_ret_MA_V, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> returns, <span class="at">group =</span> symbol)) <span class="sc">+</span></span>
<span id="cb89-10"><a href="#cb89-10"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> symbol), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb89-11"><a href="#cb89-11"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Not very clear, right?"</span>) <span class="sc">+</span> </span>
<span id="cb89-12"><a href="#cb89-12"></a>  <span class="fu">theme_tq</span>()<span class="sc">+</span></span>
<span id="cb89-13"><a href="#cb89-13"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-vrosr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-vrosr-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.2: Visualizing relationship of stocks returns.</figcaption>
</figure>
</div>
</div>
</div>
<p>The line plot was not a good idea to show our main point which is to reveal whether these two stock returns are related. You cannot see anything clear here. Only ups and downs with no clear visual pattern. Let’s propose a different way to illustrate the relationship of stock returns.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1"></a><span class="co"># Show the return relationship.</span></span>
<span id="cb90-2"><a href="#cb90-2"></a>stock_ret_MA_V  <span class="sc">|&gt;</span></span>
<span id="cb90-3"><a href="#cb90-3"></a>  <span class="fu">spread</span>(<span class="at">key =</span> symbol, <span class="at">value =</span> returns) <span class="sc">|&gt;</span></span>
<span id="cb90-4"><a href="#cb90-4"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> V, <span class="at">y =</span> MA)) <span class="sc">+</span></span>
<span id="cb90-5"><a href="#cb90-5"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb90-6"><a href="#cb90-6"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span> </span>
<span id="cb90-7"><a href="#cb90-7"></a>  <span class="fu">theme_tq</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-vrosracv" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-vrosracv-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.3: Visualizing relationship of stocks returns, a clearer view.</figcaption>
</figure>
</div>
</div>
</div>
<p>Dropping the time (or the date) and plotting coordinates looks better. The scatter plot above suggests that if Visa stock returns are low, Mastercard stock returns are low as well. By the same token, if Visa sock returns are high, Mastercard stock returns are high as well. We have 504 points; every point represents a pair of daily returns of both firms. Stock returns are then positively related, and this relationship seems to be strong and linear. We can add one line to the above plot to summarize this linear relationship between the 504 stock return pairs.</p>
<p>Note that this straight line summarizes quite well the relationship between the stock returns. This is, most of the points lie very close to the straight line. The general equation of a straight line is <span class="math inline">\(y = a + bx\)</span>, the value <span class="math inline">\(a\)</span> is called intercept and <span class="math inline">\(b\)</span> is the line slope. The slope measures how steep the line is, the higher the slope the steeper the line. We care about the slope because it measures how related are <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>. In particular, a slope of zero means that there is no relationship between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, whereas a slope of 1 means that if <span class="math inline">\(x\)</span> increases 2, then we should expect <span class="math inline">\(y\)</span> increases by 2 as well. The slope is interesting because it is the magnitude of the relationship between <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>. The sign of <span class="math inline">\(b\)</span> reveals whether the relationship is positive or negative. According to the above plot, we can anticipate that the slope <span class="math inline">\(b\)</span> is positive and it should be close to 1.</p>
<p>In this case, the general model is <span class="math inline">\(MA_i = \alpha+\beta V_i\)</span>, where <span class="math inline">\(i=1,...,504\)</span> as we have 504 observations of <span class="math inline">\(MA\)</span> and <span class="math inline">\(V\)</span> stock returns. It is easy to estimate the values of <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> by conducting a simple regression analysis. The regression analysis basically finds out the values of <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> that fits better the observed relationship between <span class="math inline">\(MA\)</span> and <span class="math inline">\(V\)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a><span class="co"># Prepare the data.</span></span>
<span id="cb91-2"><a href="#cb91-2"></a>reg <span class="ot">&lt;-</span> stock_ret_MA_V <span class="sc">|&gt;</span></span>
<span id="cb91-3"><a href="#cb91-3"></a>  <span class="fu">spread</span>(<span class="at">key =</span> symbol, <span class="at">value =</span> returns)</span>
<span id="cb91-4"><a href="#cb91-4"></a><span class="co"># Estimate the model.</span></span>
<span id="cb91-5"><a href="#cb91-5"></a><span class="fu">lm</span>(MA <span class="sc">~</span> V, <span class="at">data =</span> reg) <span class="sc">|&gt;</span></span>
<span id="cb91-6"><a href="#cb91-6"></a><span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = MA ~ V, data = reg)

Residuals:
       Min         1Q     Median         3Q        Max 
-0.0269569 -0.0039657  0.0002147  0.0039656  0.0289462 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 0.0001130  0.0003097   0.365    0.715    
V           0.8133658  0.0226393  35.927   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.00695 on 502 degrees of freedom
Multiple R-squared:   0.72, Adjusted R-squared:  0.7194 
F-statistic:  1291 on 1 and 502 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>In general our model is <span class="math inline">\(MA_i = \alpha+\beta V_i\)</span>, and in particular we have our model estimation result as <span class="math inline">\(MA_i = 0.0001130+0.8133658 V_i\)</span>. Without going into details, our linear regression analysis suggests that a 1% return on <span class="math inline">\(V\)</span> is associated with a 0.8133658% return in <span class="math inline">\(MA\)</span>. This is a good fit of the observations.</p>
<p>Let’s evaluate one example.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a><span class="fu">filter</span>(reg, date <span class="sc">==</span> <span class="st">"2015-04-22"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  date           MA      V
  &lt;date&gt;      &lt;dbl&gt;  &lt;dbl&gt;
1 2015-04-22 0.0383 0.0399</code></pre>
</div>
</div>
<p>Consider the observation pair <span class="math inline">\(V=0.03989731\)</span>, <span class="math inline">\(MA=0.03833513\)</span>. According to our regression line, the value of <span class="math inline">\(MA\)</span> at <span class="math inline">\(V=0.03989731\)</span> should be <span class="math inline">\(MA = 0.0001130 + 0.03989731 \times 0.8133658 = 0.03256411\)</span>. The difference between the observed 3.833513% and the estimated 3.256411% is the estimation error. Note that the observed value is higher than the estimated value, this is the observation is slightly above the blue regression line.</p>
<p>Our results suggests that Visa represent a risk factor of Mastercard. This is because according to our model Mastercard return changes can be explained by changes in Visa returns. The relationship between this pair of stock returns according to beta is almost perfect as 0.8133658 is close to 1. We can also calculate the correlation of both stock returns. The correlation (or Pearson correlation) is a statistic that measures linear correlation between two variables. It has a value between +1 and −1. A value of +1 is total positive linear correlation, 0 is no linear correlation, and −1 is total negative linear correlation. The beta is similar but it could be higher than +1 or lower than −1.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a><span class="fu">cor</span>(reg<span class="sc">$</span>MA, reg<span class="sc">$</span>V)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8485192</code></pre>
</div>
</div>
<p>In this case, the correlation of Visa and Mastercard stock returns is 0.8485187. This correlation value is very close to 1, so these variables are strongly linear correlated. This is important because we can argue that these two stocks are very similar, if one increases the other increases and if one decreases the other decreases. This behaviour makes sense because as we said before these firms are exposed to the same (or very similar) risk factors.</p>
<p>Let’s visualize a 1:1 relationship just as a reference in the red line below.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a><span class="co"># Add a reference red line representing beta=1.</span></span>
<span id="cb97-2"><a href="#cb97-2"></a>stock_ret_MA_V  <span class="sc">|&gt;</span></span>
<span id="cb97-3"><a href="#cb97-3"></a>  <span class="fu">spread</span>(<span class="at">key =</span> symbol, <span class="at">value =</span> returns) <span class="sc">|&gt;</span></span>
<span id="cb97-4"><a href="#cb97-4"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> V, <span class="at">y =</span> MA)) <span class="sc">+</span></span>
<span id="cb97-5"><a href="#cb97-5"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb97-6"><a href="#cb97-6"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span> </span>
<span id="cb97-7"><a href="#cb97-7"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb97-8"><a href="#cb97-8"></a>  <span class="fu">theme_tq</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-vrosrotorir" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-vrosrotorir-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.4: Visualizing relationship of stocks returns, one to one reference in red.</figcaption>
</figure>
</div>
</div>
</div>
<p>The strength of this fit can be measured by the R-squared. The R-squared value can be interpreted as the variation of <span class="math inline">\(MA\)</span> explained by variations of <span class="math inline">\(V\)</span>. In particular, almost 72% of the variations of <span class="math inline">\(MA\)</span> is explained by variations in <span class="math inline">\(V\)</span>. The rest (about 28%) remains unexplained according to the model. This 28% could be explained by adding more risk factors to the asset pricing model, or proposing an alternative estimation method.</p>
<p>Our example assumed that <span class="math inline">\(MA\)</span> can be explained by <span class="math inline">\(V\)</span>. We have not introduced a formal model so we are free to relax this assumption and turn it around. What if we assume Visa depends on Mastercard? Note that the results are not so different.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1"></a><span class="co"># Estimate the model.</span></span>
<span id="cb98-2"><a href="#cb98-2"></a><span class="fu">lm</span>(V <span class="sc">~</span> MA, <span class="at">data =</span> reg) <span class="sc">|&gt;</span></span>
<span id="cb98-3"><a href="#cb98-3"></a>    <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = V ~ MA, data = reg)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.034372 -0.003965 -0.000032  0.003423  0.035420 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -1.104e-06  3.231e-04  -0.003    0.997    
MA           8.852e-01  2.464e-02  35.927   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.00725 on 502 degrees of freedom
Multiple R-squared:   0.72, Adjusted R-squared:  0.7194 
F-statistic:  1291 on 1 and 502 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Here, we estimate <span class="math inline">\(V_i = \alpha+\beta MA_i\)</span>, and in particular we have <span class="math inline">\(V_i = -1.104 \times 10^{6}+0.8852 MA_i\)</span>.</p>
</section>
<section id="single-index-model." class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="single-index-model."><span class="header-section-number">3.2</span> Single-index model.</h2>
<p>The relationship of the risk-return trade-off is the heart of equilibrium asset pricing theories and models. The asset pricing theories are fascinating as they allow us to go deeper in the understanding of the determinants of asset returns. Here, we will skip many aspects regarding the theory, derivation, assumptions and comparison of asset pricing models, theories and estimation approaches. Here, we motivate the main ideas underlying the asset pricing models, the underlying programming approach, and what can we learn from them.</p>
<p>What if we propose that the return of an individual asset is partially explained by the market return? This proposal is similar as if we assume that the education level of one individual depends on the education level of the whole country. Or the expectation of life of one individual depends on the average expectation of life of the whole country. This proposal seems reasonable although not perfect. The market return is an aggregation of all individual asset returns traded in the stock market. There are several ways we can estimate the market return. One of them is to calculate the return of a stock index like the S&amp;P500. The S&amp;P500, or simply the S&amp;P, is a stock market index that measures the stock performance of about 500 large companies listed on stock exchanges in the United States. It is one of the most commonly followed equity indexes, and many consider it to be one of the best representations of the US stock market.</p>
<p>Market indexes as the S&amp;P500 are important for several reasons. We have discussed that stock price evolution is a good way to track the performance of a single company. However, we are usually interested in evaluating the performance of all the companies in the market, not only one or two. Stock market indexes are formed by several firms or in some cases many participants known as constituents. There is a wide variety of stock market indexes, some are country specific, or based on industries and other firm characteristics. By looking at the price or index evolution of these indexes we can track what happens with the firms in an aggregate approach. Then, an index value change in a day show what happened with the firms in average in that specific day. If the S&amp;P500 increases in one day then we interpret this as if most of the firms that participate in the S&amp;P500 increased its value in that particular day.</p>
<p>Let’s conduct a regression analysis as before. Now the model is <span class="math inline">\(stock_{i,j} = \alpha_i + \beta_i SP500_j + \epsilon_i\)</span>, where sub-index <span class="math inline">\(i\)</span> represents a given stock, and <span class="math inline">\(j\)</span> the historical observations. Note that this model is very similar as the general equation of a straight line is <span class="math inline">\(y = a + bx\)</span>. The model <span class="math inline">\(stock_{i,j} = \alpha_i + \beta_i SP500_j + \epsilon_i\)</span> is basically the single-index-model. It is called single because we assume there is only one risk factor which in this case is the market return. There are other multi-factor models that adds more factors (like factor <em>F</em> for example) and they look like this: <span class="math inline">\(stock_{i,j} = \alpha_i + \beta_i SP500_j + \delta_i F_j + \epsilon_i\)</span>.</p>
<p>According to the single index model, the stock return is decomposed in three parts: a constant return <span class="math inline">\(\alpha_i\)</span>, a component proportional to the market index <span class="math inline">\(\beta_i SP500_j\)</span>, and a random and unpredictable component <span class="math inline">\(\epsilon_i\)</span>. The intercept term is the expected value of the component of security <span class="math inline">\(i\)</span>’s return that is independent of the market’s performance. The beta coefficient is specific for each security and measures the security’s sensitivity to the market. The random component represents the deviation of the return on the security from its expected value. The single-index model says that risks of individual securities arise from two sources: market or systematic risk，reflected in <span class="math inline">\(\beta_i SP500_j\)</span> and firm-specific risk，reflected in <span class="math inline">\(\epsilon_i\)</span>. This simple dichotomy may oversimplify factors of real world uncertainty. For example，it ignores industry events，which affect many firms within a single industry but do not influence the macroeconomy as a whole.</p>
<p>Let’s estimate the single-index model. Here, we have selected 10 stocks, <span class="math inline">\(i=1,...10\)</span>, and 72 monthly returns observations <span class="math inline">\(j=1,...,72\)</span>. Our main estimation objective is to find <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span> for these 10 stocks.</p>
<p>First, we download the corresponding 10 monthly stock returns.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1"></a><span class="co"># Download individual asset returns.</span></span>
<span id="cb100-2"><a href="#cb100-2"></a>R_stocks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"NEM"</span>, <span class="st">"AMCR"</span>, <span class="st">"CLX"</span>, <span class="st">"PEAK"</span>, <span class="st">"KR"</span>, <span class="st">"TXN"</span>, <span class="st">"F"</span>, <span class="st">"TXT"</span>, </span>
<span id="cb100-3"><a href="#cb100-3"></a>              <span class="st">"KLAC"</span>, <span class="st">"TEF"</span>) <span class="sc">|&gt;</span></span>
<span id="cb100-4"><a href="#cb100-4"></a>  <span class="fu">tq_get</span>(<span class="at">get  =</span> <span class="st">"stock.prices"</span>, <span class="at">from =</span> <span class="st">"2010-01-01"</span>, </span>
<span id="cb100-5"><a href="#cb100-5"></a>         <span class="at">to   =</span> <span class="st">"2015-12-31"</span>) <span class="sc">|&gt;</span></span>
<span id="cb100-6"><a href="#cb100-6"></a>  <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span> </span>
<span id="cb100-7"><a href="#cb100-7"></a>  <span class="fu">tq_transmute</span>(<span class="at">select     =</span> adjusted, </span>
<span id="cb100-8"><a href="#cb100-8"></a>               <span class="at">mutate_fun =</span> periodReturn, </span>
<span id="cb100-9"><a href="#cb100-9"></a>               <span class="at">period     =</span> <span class="st">"monthly"</span>, </span>
<span id="cb100-10"><a href="#cb100-10"></a>               <span class="at">col_rename =</span> <span class="st">"R_stocks"</span>)</span>
<span id="cb100-11"><a href="#cb100-11"></a>R_stocks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 692 × 3
# Groups:   symbol [10]
   symbol date       R_stocks
   &lt;chr&gt;  &lt;date&gt;        &lt;dbl&gt;
 1 NEM    2010-01-29  -0.115 
 2 NEM    2010-02-26   0.150 
 3 NEM    2010-03-31   0.0355
 4 NEM    2010-04-30   0.101 
 5 NEM    2010-05-28  -0.0403
 6 NEM    2010-06-30   0.149 
 7 NEM    2010-07-30  -0.0946
 8 NEM    2010-08-31   0.0970
 9 NEM    2010-09-30   0.0268
10 NEM    2010-10-29  -0.0310
# ℹ 682 more rows</code></pre>
</div>
</div>
<p>Then, we download the S&amp;P500 monthly returns, the symbol is ^GSPC.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1"></a><span class="co"># Download the market index return.</span></span>
<span id="cb102-2"><a href="#cb102-2"></a>R_market <span class="ot">&lt;-</span> <span class="st">"^GSPC"</span> <span class="sc">|&gt;</span></span>
<span id="cb102-3"><a href="#cb102-3"></a>  <span class="fu">tq_get</span>(<span class="at">get  =</span> <span class="st">"stock.prices"</span>, <span class="at">from =</span> <span class="st">"2010-01-01"</span>,</span>
<span id="cb102-4"><a href="#cb102-4"></a>         <span class="at">to   =</span> <span class="st">"2015-12-31"</span>) <span class="sc">|&gt;</span></span>
<span id="cb102-5"><a href="#cb102-5"></a>    <span class="fu">tq_transmute</span>(<span class="at">select     =</span> adjusted, </span>
<span id="cb102-6"><a href="#cb102-6"></a>                 <span class="at">mutate_fun =</span> periodReturn, </span>
<span id="cb102-7"><a href="#cb102-7"></a>                 <span class="at">period     =</span> <span class="st">"monthly"</span>, </span>
<span id="cb102-8"><a href="#cb102-8"></a>                 <span class="at">col_rename =</span> <span class="st">"R_market"</span>)</span>
<span id="cb102-9"><a href="#cb102-9"></a>R_market</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 72 × 2
   date       R_market
   &lt;date&gt;        &lt;dbl&gt;
 1 2010-01-29  -0.0522
 2 2010-02-26   0.0285
 3 2010-03-31   0.0588
 4 2010-04-30   0.0148
 5 2010-05-28  -0.0820
 6 2010-06-30  -0.0539
 7 2010-07-30   0.0688
 8 2010-08-31  -0.0474
 9 2010-09-30   0.0876
10 2010-10-29   0.0369
# ℹ 62 more rows</code></pre>
</div>
</div>
<p>Now, we join <tt><code>R_stocks</code></tt> and <tt><code>R_market</code></tt> in the same variable or R object. This is convenient in the estimation procedure.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1"></a><span class="co"># Prepare the database.</span></span>
<span id="cb104-2"><a href="#cb104-2"></a>R_stocks_market <span class="ot">&lt;-</span> <span class="fu">left_join</span>(R_stocks, R_market, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span> <span class="ot">=</span> <span class="st">"date"</span>))</span>
<span id="cb104-3"><a href="#cb104-3"></a>R_stocks_market</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 692 × 4
# Groups:   symbol [10]
   symbol date       R_stocks R_market
   &lt;chr&gt;  &lt;date&gt;        &lt;dbl&gt;    &lt;dbl&gt;
 1 NEM    2010-01-29  -0.115   -0.0522
 2 NEM    2010-02-26   0.150    0.0285
 3 NEM    2010-03-31   0.0355   0.0588
 4 NEM    2010-04-30   0.101    0.0148
 5 NEM    2010-05-28  -0.0403  -0.0820
 6 NEM    2010-06-30   0.149   -0.0539
 7 NEM    2010-07-30  -0.0946   0.0688
 8 NEM    2010-08-31   0.0970  -0.0474
 9 NEM    2010-09-30   0.0268   0.0876
10 NEM    2010-10-29  -0.0310   0.0369
# ℹ 682 more rows</code></pre>
</div>
</div>
<p>We can use the <tt><code>tq_performance()</code></tt> function to facilitate the regression analysis estimation.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1"></a><span class="co"># 10 models estimated at once.</span></span>
<span id="cb106-2"><a href="#cb106-2"></a>R_capm <span class="ot">&lt;-</span> R_stocks_market <span class="sc">|&gt;</span></span>
<span id="cb106-3"><a href="#cb106-3"></a>  <span class="fu">tq_performance</span>(<span class="at">Ra =</span> R_stocks, </span>
<span id="cb106-4"><a href="#cb106-4"></a>                 <span class="at">Rb =</span> R_market, </span>
<span id="cb106-5"><a href="#cb106-5"></a>                 <span class="at">performance_fun =</span> table.CAPM) <span class="sc">|&gt;</span></span>
<span id="cb106-6"><a href="#cb106-6"></a><span class="fu">select</span>(symbol, Alpha, Beta, <span class="st">`</span><span class="at">R-squared</span><span class="st">`</span>)</span>
<span id="cb106-7"><a href="#cb106-7"></a>R_capm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
# Groups:   symbol [10]
   symbol   Alpha  Beta `R-squared`
   &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;
 1 NEM    -0.0084 0.155      0.0032
 2 AMCR    0.0035 0.415      0.0748
 3 CLX     0.0097 0.434      0.195 
 4 PEAK    0.0052 0.448      0.0965
 5 KR      0.0165 0.713      0.215 
 6 TXN     0.0032 1.27       0.575 
 7 F      -0.0032 1.39       0.400 
 8 TXT     0.0009 1.64       0.431 
 9 KLAC    0.0024 1.74       0.541 
10 TEF    -0.0172 1.50       0.446 </code></pre>
</div>
</div>
<p>Here, we have the results for the single-index model estimation for the 10 stocks.</p>
<p>Please note how we arrange the stocks according to the beta. We have stocks <span class="math inline">\(\beta\)</span> from 0.15 to 1.74. We interpret this as the riskiness of the stock with respect to the market. The stock NEM has the lowest risk with respect to the market. In other words, stocks with low betas are less exposed to changes in the S&amp;P500 this is why we argue that are not risky with respect to the market. Stocks with low betas might be exposed to other risk factors, but not the market. On the other hand, stocks with high betas like TEF are highly exposed to changes in the S&amp;P500 this is why we argue that are risky with respect to the market. The beta of TEF is actually higher than 1, which means that TEF react more than proportional with respect to changes in the stock market.</p>
<p>We need a deeper econometric analysis to validate our interpretations. Here, we are not going to deal with a formal econometric interpretation but we can propose some arguments to better understand the stock behaviour. Alphas are all very close to zero. The R-squared is also relevant as it shows what proportion of changes in the stock returns are explained by changes in the stock market. Note that 57% of TXN stock return changes are explained by changes in the S&amp;P500.</p>
<p>We can illustrate the previous results in a graphical way.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1"></a>R_stocks_market<span class="sc">$</span>symbol <span class="ot">&lt;-</span> </span>
<span id="cb108-2"><a href="#cb108-2"></a>  <span class="fu">factor</span>(R_stocks_market<span class="sc">$</span>symbol, <span class="at">levels =</span></span>
<span id="cb108-3"><a href="#cb108-3"></a>           <span class="fu">unique</span>(R_stocks_market<span class="sc">$</span>symbol))</span>
<span id="cb108-4"><a href="#cb108-4"></a><span class="co"># Plot all results.</span></span>
<span id="cb108-5"><a href="#cb108-5"></a>R_stocks_market <span class="sc">|&gt;</span> </span>
<span id="cb108-6"><a href="#cb108-6"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> R_market, <span class="at">y =</span> R_stocks, <span class="at">color =</span> symbol)) <span class="sc">+</span> </span>
<span id="cb108-7"><a href="#cb108-7"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span> </span>
<span id="cb108-8"><a href="#cb108-8"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb108-9"><a href="#cb108-9"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>symbol, <span class="at">ncol =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb108-10"><a href="#cb108-10"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb108-11"><a href="#cb108-11"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> </span>
<span id="cb108-12"><a href="#cb108-12"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"SP500 return"</span>, <span class="at">y =</span> <span class="st">"Asset return"</span>) <span class="sc">+</span></span>
<span id="cb108-13"><a href="#cb108-13"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-rbaram" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-rbaram-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.5: Relationship between asset return and market.</figcaption>
</figure>
</div>
</div>
</div>
<p>The stocks are sorted in such a way that the slope is increasing. I added a black line which represents a <span class="math inline">\(\beta = 1\)</span> to illustrate the cases in which the stock is less risky than the market and riskier than the market. The <span class="math inline">\(y\)</span>-axis represents the asset returns and the <span class="math inline">\(x\)</span>-axis the S&amp;P500 returns.</p>
<p>We are interested in these results for a variety of reasons. Consider the following example. Imagine I am currently investing in the stock market and I anticipate a fall in the stock market. Some investors would prefer to sell their positions but imagine I need or want to stay for any reason. If so, then I might consider rearranging my portfolio investment to include more stocks with low betas (probably even negative betas). By doing so and if I was right with respect to the S&amp;P500, then my position would not be severely affected because my portfolio is now more independent to the evolution of the stock market. On the other hand, if I anticipate given my analysis that the stock market will rise, then I could rearrange my portfolio to include more stocks with high betas (even higher than 1). By doing so and if I was right with respect to the S&amp;P500, then my position would improve because my portfolio would generate more return, even more than the S&amp;P500 itself.</p>
<p>In practice, we have to conduct a series of formal statistical tests to rely on our estimated betas. In particular, we are interested to have a statistically significant estimator among other things. Things might become complicated when you know that there are many ways in which we can estimate betas. Even if we take a different historical dataset length, we can get different betas. Is we take a different market benchmark we can get different betas. Financial sites usually report betas of the stock, and sometimes it is difficult to find out what was the process of estimating the model. Then, these kinds of estimations have to be done by a professional in the area. My recommendation is to study asset pricing theory and relevant financial econometric techniques to propose these kind of investment recommendations. Our previous interpretation assumes we have correctly estimated betas.</p>
<p>The Capital Asset Pricing Model (CAPM) was created by William Sharpe in 1964, see <span class="citation" data-cites="sharpe1964capital">Sharpe (<a href="#ref-sharpe1964capital" role="doc-biblioref">1964</a>)</span>. He won the 1990 Nobel Prize in Economic Sciences, along with Harry Markowitz and Merton Miller, for developing models to assist with investment decision making like the CAPM. This model is similar to the single index model as the CAPM estimates the return of an asset based on the return of the market and the asset’s linear relationship to the return of the market. This linear relationship is the stock’s <span class="math inline">\(\beta\)</span> (beta) coefficient. The CAPM beta captures the linear relationship between the asset or portfolio and the market. This model is simple, but it can serve as a good base for the building of more complex models.</p>
<p>We can extend our analysis further. Given our 10 set of assets, we can calculate annualized returns and annualized Sharpe ratios (return per unit of risk).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1"></a><span class="co"># Calculate annualized returns.</span></span>
<span id="cb109-2"><a href="#cb109-2"></a>R_stocks_market <span class="sc">|&gt;</span></span>
<span id="cb109-3"><a href="#cb109-3"></a>    <span class="fu">tq_performance</span>(<span class="at">Ra =</span> R_stocks, <span class="at">Rb =</span> <span class="cn">NULL</span>, </span>
<span id="cb109-4"><a href="#cb109-4"></a>                   <span class="at">performance_fun =</span> table.AnnualizedReturns) <span class="sc">|&gt;</span></span>
<span id="cb109-5"><a href="#cb109-5"></a><span class="fu">arrange</span>(<span class="st">`</span><span class="at">AnnualizedSharpe(Rf=0%)</span><span class="st">`</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
# Groups:   symbol [10]
   symbol AnnualizedReturn `AnnualizedSharpe(Rf=0%)` AnnualizedStdDev
   &lt;fct&gt;             &lt;dbl&gt;                     &lt;dbl&gt;            &lt;dbl&gt;
 1 NEM             -0.139                     -0.385            0.361
 2 TEF             -0.0827                    -0.279            0.296
 3 F                0.0756                     0.262            0.289
 4 TXT              0.146                      0.445            0.329
 5 AMCR             0.0782                     0.489            0.16 
 6 PEAK             0.0983                     0.517            0.190
 7 KLAC             0.187                      0.598            0.312
 8 TXN              0.164                      0.745            0.220
 9 CLX              0.167                      1.29             0.129
10 KR               0.288                      1.42             0.203</code></pre>
</div>
</div>
<p>A stock beta is a measure of the individual asset return risk with respect to the market. The annualized Sharpe ratio above is a measure of the individual asset return per unit of risk. Let’s visualize the previous table.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1"></a><span class="co"># Calculate annualized returns.</span></span>
<span id="cb111-2"><a href="#cb111-2"></a>R_stocks_market_stats <span class="ot">&lt;-</span> R_stocks_market <span class="sc">|&gt;</span></span>
<span id="cb111-3"><a href="#cb111-3"></a>    <span class="fu">tq_performance</span>(<span class="at">Ra =</span> R_stocks, <span class="at">Rb =</span> <span class="cn">NULL</span>, </span>
<span id="cb111-4"><a href="#cb111-4"></a>                   <span class="at">performance_fun =</span> table.AnnualizedReturns) <span class="sc">|&gt;</span></span>
<span id="cb111-5"><a href="#cb111-5"></a><span class="co"># Mean variance plot.</span></span>
<span id="cb111-6"><a href="#cb111-6"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> AnnualizedStdDev, <span class="at">y =</span> AnnualizedReturn, <span class="at">color =</span> symbol)) <span class="sc">+</span></span>
<span id="cb111-7"><a href="#cb111-7"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb111-8"><a href="#cb111-8"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb111-9"><a href="#cb111-9"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="st">`</span><span class="at">AnnualizedSharpe(Rf=0%)</span><span class="st">`</span>, <span class="dv">3</span>))), </span>
<span id="cb111-10"><a href="#cb111-10"></a>            <span class="at">vjust =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb111-11"><a href="#cb111-11"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste0</span>(symbol)), </span>
<span id="cb111-12"><a href="#cb111-12"></a>            <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="sc">-</span><span class="fl">0.17</span>, <span class="fl">0.35</span>) <span class="sc">+</span></span>
<span id="cb111-13"><a href="#cb111-13"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Numerical values represent return per unit of risk."</span>,</span>
<span id="cb111-14"><a href="#cb111-14"></a>       <span class="at">x =</span> <span class="st">"Risk"</span>, <span class="at">y =</span> <span class="st">"Expected return"</span>) <span class="sc">+</span> </span>
<span id="cb111-15"><a href="#cb111-15"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span></span>
<span id="cb111-16"><a href="#cb111-16"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb111-17"><a href="#cb111-17"></a></span>
<span id="cb111-18"><a href="#cb111-18"></a>R_stocks_market_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-thtrthtr2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-thtrthtr2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.6: The higher the risk, the higher the return?</figcaption>
</figure>
</div>
</div>
</div>
<p>I added a straight line of 45 degrees so any asset above the red line means a return per unit of risk above 1. By the same token, any asset below the red line means a return per unit of risk below 1.</p>
<p>An alternative view to show the Sharpe ratio.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1"></a>R_stocks_market_stats <span class="ot">&lt;-</span> R_stocks_market <span class="sc">|&gt;</span></span>
<span id="cb112-2"><a href="#cb112-2"></a>    <span class="fu">tq_performance</span>(<span class="at">Ra =</span> R_stocks, <span class="at">Rb =</span> <span class="cn">NULL</span>, </span>
<span id="cb112-3"><a href="#cb112-3"></a>                   <span class="at">performance_fun =</span> table.AnnualizedReturns) <span class="sc">|&gt;</span></span>
<span id="cb112-4"><a href="#cb112-4"></a>  <span class="fu">rename</span>(<span class="st">"Sharpe"</span> <span class="ot">=</span> <span class="st">`</span><span class="at">AnnualizedSharpe(Rf=0%)</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb112-5"><a href="#cb112-5"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> symbol, <span class="at">y =</span> Sharpe, <span class="at">fill =</span> Sharpe)) <span class="sc">+</span></span>
<span id="cb112-6"><a href="#cb112-6"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb112-7"><a href="#cb112-7"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"red"</span>, <span class="at">high =</span> <span class="st">"blue"</span>)</span>
<span id="cb112-8"><a href="#cb112-8"></a></span>
<span id="cb112-9"><a href="#cb112-9"></a>R_stocks_market_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-asrf1s" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-asrf1s-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.7: Annualized Sharpe ratio for 10 stocks.</figcaption>
</figure>
</div>
</div>
</div>
<p>What if we use the values of betas and Sharpe ratios to form investment portfolios with these 10 assets? We call a portfolio to the new asset formed by several (smaller) investments in single assets. Let’s start with a visualization of monthly return of a naïve portfolio. A naïve portfolio is basically formed by a 10% investment in each of the 10 assets. Here, we do not invest more in higher stock betas or in higher Sharpe ratio stocks. It is simply an equally weighted portfolio.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1"></a><span class="co"># Weights.</span></span>
<span id="cb113-2"><a href="#cb113-2"></a>wts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>)</span>
<span id="cb113-3"><a href="#cb113-3"></a><span class="co"># Portfolio creation.</span></span>
<span id="cb113-4"><a href="#cb113-4"></a>portfolio_returns_monthly <span class="ot">&lt;-</span> R_stocks_market <span class="sc">|&gt;</span></span>
<span id="cb113-5"><a href="#cb113-5"></a>    <span class="fu">tq_portfolio</span>(<span class="at">assets_col  =</span> symbol, </span>
<span id="cb113-6"><a href="#cb113-6"></a>                 <span class="at">returns_col =</span> R_stocks, </span>
<span id="cb113-7"><a href="#cb113-7"></a>                 <span class="at">weights     =</span> wts, </span>
<span id="cb113-8"><a href="#cb113-8"></a>                 <span class="at">col_rename  =</span> <span class="st">"Ra"</span>)</span>
<span id="cb113-9"><a href="#cb113-9"></a>portfolio_returns_monthly <span class="sc">|&gt;</span></span>
<span id="cb113-10"><a href="#cb113-10"></a>  <span class="co"># Visualization.</span></span>
<span id="cb113-11"><a href="#cb113-11"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> Ra)) <span class="sc">+</span></span>
<span id="cb113-12"><a href="#cb113-12"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb113-13"><a href="#cb113-13"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"10% in each one of the 10 assets."</span>,</span>
<span id="cb113-14"><a href="#cb113-14"></a>       <span class="at">caption =</span> <span class="st">"Shows an above-zero trend meaning positive returns."</span>,</span>
<span id="cb113-15"><a href="#cb113-15"></a>       <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Monthly returns"</span>) <span class="sc">+</span></span>
<span id="cb113-16"><a href="#cb113-16"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb113-17"><a href="#cb113-17"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span> </span>
<span id="cb113-18"><a href="#cb113-18"></a>  <span class="fu">scale_color_tq</span>() <span class="sc">+</span></span>
<span id="cb113-19"><a href="#cb113-19"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ewpmr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-ewpmr-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.8: Equally weighted portfolio monthly returns.</figcaption>
</figure>
</div>
</div>
</div>
<p>A monthly returns plot is a good representation, but we normally show the evolution of an investment’s growth. In this case, we consider an initial investment of 10,000 USD.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1"></a><span class="co"># Cumulative returns.</span></span>
<span id="cb114-2"><a href="#cb114-2"></a>portfolio_growth_monthly <span class="ot">&lt;-</span> R_stocks_market <span class="sc">|&gt;</span></span>
<span id="cb114-3"><a href="#cb114-3"></a>    <span class="fu">tq_portfolio</span>(<span class="at">assets_col   =</span> symbol, </span>
<span id="cb114-4"><a href="#cb114-4"></a>                 <span class="at">returns_col  =</span> R_stocks, </span>
<span id="cb114-5"><a href="#cb114-5"></a>                 <span class="at">weights      =</span> wts, </span>
<span id="cb114-6"><a href="#cb114-6"></a>                 <span class="at">col_rename   =</span> <span class="st">"investment.growth"</span>,</span>
<span id="cb114-7"><a href="#cb114-7"></a>                 <span class="at">wealth.index =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb114-8"><a href="#cb114-8"></a>    <span class="fu">mutate</span>(<span class="at">investment.growth =</span> investment.growth <span class="sc">*</span> <span class="dv">10000</span>)</span>
<span id="cb114-9"><a href="#cb114-9"></a></span>
<span id="cb114-10"><a href="#cb114-10"></a>portfolio_growth_monthly <span class="sc">|&gt;</span></span>
<span id="cb114-11"><a href="#cb114-11"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> investment.growth)) <span class="sc">+</span></span>
<span id="cb114-12"><a href="#cb114-12"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb114-13"><a href="#cb114-13"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">"2010-01-01"</span>), <span class="at">y =</span> <span class="dv">10000</span>), </span>
<span id="cb114-14"><a href="#cb114-14"></a>             <span class="at">size =</span> <span class="dv">4</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb114-15"><a href="#cb114-15"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"10% in each one of the 10 assets."</span>, </span>
<span id="cb114-16"><a href="#cb114-16"></a>      <span class="at">caption =</span> <span class="st">"Now, we can really visualize performance!"</span>,</span>
<span id="cb114-17"><a href="#cb114-17"></a>      <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Portfolio value"</span>) <span class="sc">+</span></span>
<span id="cb114-18"><a href="#cb114-18"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb114-19"><a href="#cb114-19"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span></span>
<span id="cb114-20"><a href="#cb114-20"></a>  <span class="fu">scale_color_tq</span>() <span class="sc">+</span></span>
<span id="cb114-21"><a href="#cb114-21"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ewpgo1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-ewpgo1-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;3.9: Equally weighted portfolio growth of $10,000.</figcaption>
</figure>
</div>
</div>
</div>
<p>Looks OK. However, we are not sure if this is the best combination of assets. This is, what if the equally weighted portfolio is in fact the worst alternative? This is why we are interested in comparing this equally weighted portfolio with some other portfolios. In particular, a beta increasing portfolio and a Sharpe ratio increasing portfolio. These are basically incremental weights of 10%, 20%, 30% and 40% for the highest four betas and for the highest four Sharpe ratios.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1"></a><span class="co"># Calculate annualized returns.</span></span>
<span id="cb115-2"><a href="#cb115-2"></a>R_stocks_market <span class="sc">|&gt;</span></span>
<span id="cb115-3"><a href="#cb115-3"></a>  <span class="fu">tq_performance</span>(<span class="at">Ra =</span> R_stocks, <span class="at">Rb =</span> <span class="cn">NULL</span>, </span>
<span id="cb115-4"><a href="#cb115-4"></a>                   <span class="at">performance_fun =</span> table.AnnualizedReturns) <span class="sc">|&gt;</span></span>
<span id="cb115-5"><a href="#cb115-5"></a>  <span class="fu">arrange</span>(<span class="st">`</span><span class="at">AnnualizedSharpe(Rf=0%)</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb115-6"><a href="#cb115-6"></a>  <span class="fu">left_join</span>(R_capm, <span class="at">by =</span> <span class="st">'symbol'</span>)  <span class="sc">|&gt;</span></span>
<span id="cb115-7"><a href="#cb115-7"></a>  <span class="fu">select</span>(symbol, <span class="st">`</span><span class="at">AnnualizedSharpe(Rf=0%)</span><span class="st">`</span>, Beta) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
# Groups:   symbol [10]
   symbol `AnnualizedSharpe(Rf=0%)`  Beta
   &lt;chr&gt;                      &lt;dbl&gt; &lt;dbl&gt;
 1 NEM                       -0.385 0.155
 2 TEF                       -0.279 1.50 
 3 F                          0.262 1.39 
 4 TXT                        0.445 1.64 
 5 AMCR                       0.489 0.415
 6 PEAK                       0.517 0.448
 7 KLAC                       0.598 1.74 
 8 TXN                        0.745 1.27 
 9 CLX                        1.29  0.434
10 KR                         1.42  0.713</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1"></a><span class="co"># Three portfolios.</span></span>
<span id="cb117-2"><a href="#cb117-2"></a>weights <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb117-3"><a href="#cb117-3"></a>    <span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>, <span class="co"># equally weighted</span></span>
<span id="cb117-4"><a href="#cb117-4"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="co"># sr increasing</span></span>
<span id="cb117-5"><a href="#cb117-5"></a>    <span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.4</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span> <span class="co"># beta increasing</span></span>
<span id="cb117-6"><a href="#cb117-6"></a>)</span>
<span id="cb117-7"><a href="#cb117-7"></a></span>
<span id="cb117-8"><a href="#cb117-8"></a>stocks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"NEM"</span>, <span class="st">"TEF"</span>, <span class="st">"F"</span>, <span class="st">"TXT"</span>, <span class="st">"AMCR"</span>, <span class="st">"PEAK"</span>, </span>
<span id="cb117-9"><a href="#cb117-9"></a>            <span class="st">"KLAC"</span>, <span class="st">"TXN"</span>, <span class="st">"CLX"</span>, <span class="st">"KR"</span>)</span>
<span id="cb117-10"><a href="#cb117-10"></a>weights_table <span class="ot">&lt;-</span>  <span class="fu">tibble</span>(stocks) <span class="sc">|&gt;</span></span>
<span id="cb117-11"><a href="#cb117-11"></a>    <span class="fu">tq_repeat_df</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb117-12"><a href="#cb117-12"></a>    <span class="fu">bind_cols</span>(<span class="fu">tibble</span>(weights)) <span class="sc">|&gt;</span></span>
<span id="cb117-13"><a href="#cb117-13"></a>    <span class="fu">group_by</span>(portfolio)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>See the results.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1"></a><span class="co"># See the evolution of three portfolios.</span></span>
<span id="cb118-2"><a href="#cb118-2"></a>stock_returns_monthly_multi <span class="ot">&lt;-</span> R_stocks_market <span class="sc">|&gt;</span></span>
<span id="cb118-3"><a href="#cb118-3"></a>    <span class="fu">tq_repeat_df</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb118-4"><a href="#cb118-4"></a></span>
<span id="cb118-5"><a href="#cb118-5"></a>portfolio_growth_monthly_multi <span class="ot">&lt;-</span> stock_returns_monthly_multi <span class="sc">|&gt;</span></span>
<span id="cb118-6"><a href="#cb118-6"></a>    <span class="fu">tq_portfolio</span>(<span class="at">assets_col   =</span> symbol, </span>
<span id="cb118-7"><a href="#cb118-7"></a>                 <span class="at">returns_col  =</span> R_stocks, </span>
<span id="cb118-8"><a href="#cb118-8"></a>                 <span class="at">weights      =</span> weights_table, </span>
<span id="cb118-9"><a href="#cb118-9"></a>                 <span class="at">col_rename   =</span> <span class="st">"investment.growth"</span>,</span>
<span id="cb118-10"><a href="#cb118-10"></a>                 <span class="at">wealth.index =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb118-11"><a href="#cb118-11"></a>    <span class="fu">mutate</span>(<span class="at">investment.growth =</span> investment.growth <span class="sc">*</span> <span class="dv">10000</span>)</span>
<span id="cb118-12"><a href="#cb118-12"></a>portfolio_growth_monthly_multi <span class="sc">|&gt;</span></span>
<span id="cb118-13"><a href="#cb118-13"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> investment.growth, <span class="at">color =</span> <span class="fu">factor</span>(portfolio))) <span class="sc">+</span></span>
<span id="cb118-14"><a href="#cb118-14"></a>    <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb118-15"><a href="#cb118-15"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.Date</span>(<span class="st">"2010-01-01"</span>), <span class="at">y =</span> <span class="dv">10000</span>), </span>
<span id="cb118-16"><a href="#cb118-16"></a>             <span class="at">size =</span> <span class="dv">4</span>, <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb118-17"><a href="#cb118-17"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Portfolio growth of $10,000."</span>,</span>
<span id="cb118-18"><a href="#cb118-18"></a>         <span class="at">subtitle =</span> <span class="st">"1: Equally weighted; 2: Sharpe ratio; 3: Beta"</span>,</span>
<span id="cb118-19"><a href="#cb118-19"></a>         <span class="at">caption =</span> <span class="st">"Portfolio 2 is a standout!"</span>,</span>
<span id="cb118-20"><a href="#cb118-20"></a>         <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Portfolio value"</span>,</span>
<span id="cb118-21"><a href="#cb118-21"></a>         <span class="at">color =</span> <span class="st">"Portfolio"</span>) <span class="sc">+</span></span>
<span id="cb118-22"><a href="#cb118-22"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>) <span class="sc">+</span></span>
<span id="cb118-23"><a href="#cb118-23"></a>    <span class="fu">theme_tq</span>() <span class="sc">+</span> <span class="fu">scale_color_tq</span>() <span class="sc">+</span></span>
<span id="cb118-24"><a href="#cb118-24"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-155-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this case the increasing Sharpe ratio portfolio is the best one. In particular, the portfolio is: 10% in KLAC, 20% in TXN, 30% in CLX, 40% in KR, and 0% in the rest.</p>
<p>The next section deals with the actual investment problem. In which assets should we invest? How much should we invest in each asset? Those questions can be addressed by learning asset allocation or portfolio selection techniques.</p>
<div style="page-break-after: always;"></div>
</section>
</section>
<section id="asset-allocation." class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Asset allocation.</h1>
<p>In finance, we are expected to take good financing and investment decisions. Asset allocation and portfolio theory are areas that show how we can take optimal investment decisions. In general, optimization is the act of achieving the best possible result under given circumstances. In our context, the best possible result is the highest return given a risk level, or alternatively the lowest risk given a return level. The <em>given circumstances</em> refer to a set of restrictions or constraints that we can face in the market. These restrictions are in the form of a maximum level of one asset in a portfolio, constraints about short sales, etc. Computers can solve complex optimization problems so it makes sense to use R and conduct asset allocation and tasks and estimate portfolio optimization models.</p>
<p>In principle, we all know that the popular wisdom suggests <em>not to put all the eggs in the same basket</em>. This suggestion makes sense as we should diversify as diversification is a way to manage the risk of losing all the eggs if something bad happens. For example, imagine I invest in two firms, one that sells ice cream and another that sells hot chocolate. Assume that as an exchange of my investment, I get some returns based on these firms’ sales. My diversification in these two firms seems reasonable as the weather (relevant risk factor) affects the sales of these two companies in an opposite way. In particular, when it is hot, sales increases in the ice cream shop and decreases in the hot chocolate shop; and when it is cold, sales increases in the hot chocolate shop and decreases in the ice cream shop. Then, my revenues will be fairly constant every year, and this is desirable as I reduce the volatility of my revenues, they become less risky, the standard deviation of my revenues is small. You may remember our previous discussion about the correlation of Mastercard and Visa, the correlation of these firms’ stock returns is 0.8480487 and we argue that this mean that they not only share the same risk factors, but they also react almost the same to changes in these risk factors, and this is why they behave similar. In the ice cream and hot chocolate shop example, we could guess that the sales’ correlation of both shops have a strong negative correlation let’s say −0.9. This means that the sales of both shops behave opposite and they are affected differently by the risk factor called weather.</p>
<p>If the popular wisdom suggests <em>not to put all the eggs in the same basket</em>, then, the interesting question is, how many eggs should we put in each basket? This is the equivalent to an investment recommendation in the form of how much to invest in each individual asset. We call portfolio to the new asset formed by several and smaller investments in single assets. And we call a portfolio weight to the percentage invested in single assets. Asset allocation models allow us to estimate these optimal portfolio weights. Let’s see an extreme example first. Imagine my current investment is 1% in the ice cream shop and 99% in the hot chocolate shop. This does not look like a good idea because these portfolio weights make the portfolio highly vulnerable to hot weather. After implementing an asset allocation optimization, the portfolio weights could be 60% of my money invested in the ice cream shop and 40% in the hot chocolate shop.</p>
<section id="the-single-period-problem." class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="the-single-period-problem."><span class="header-section-number">4.1</span> The single-period problem.</h2>
<p>The single-period problem is the simplest framework to implement asset allocation models. Here, we assume that the investor has some historical information about the assets in <span class="math inline">\(t=0\)</span> (today), she makes an investment decision today, and she expects a return in <span class="math inline">\(t=1\)</span>, end of story.</p>
<p>Let’s see how we should distribute the 100% of available money to invest in four stocks using the <tt><code>PortfolioAnalytics</code></tt> R package. We need data to start. For convenience, we use the monthly returns of the <tt><code>FANG</code></tt> database.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1"></a>FANG_monthly_returns <span class="ot">&lt;-</span> FANG <span class="sc">|&gt;</span></span>
<span id="cb119-2"><a href="#cb119-2"></a>    <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span></span>
<span id="cb119-3"><a href="#cb119-3"></a>    <span class="fu">tq_transmute</span>(<span class="at">select     =</span> adjusted,</span>
<span id="cb119-4"><a href="#cb119-4"></a>                 <span class="at">mutate_fun =</span> periodReturn,</span>
<span id="cb119-5"><a href="#cb119-5"></a>                 <span class="at">period     =</span> <span class="st">"monthly"</span>,</span>
<span id="cb119-6"><a href="#cb119-6"></a>                 <span class="at">type       =</span> <span class="st">"arithmetic"</span>)</span>
<span id="cb119-7"><a href="#cb119-7"></a></span>
<span id="cb119-8"><a href="#cb119-8"></a>FANG_monthly_returns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 192 × 3
# Groups:   symbol [4]
   symbol date       monthly.returns
   &lt;chr&gt;  &lt;date&gt;               &lt;dbl&gt;
 1 FB     2013-01-31        0.106   
 2 FB     2013-02-28       -0.120   
 3 FB     2013-03-28       -0.0613  
 4 FB     2013-04-30        0.0856  
 5 FB     2013-05-31       -0.123   
 6 FB     2013-06-28        0.0218  
 7 FB     2013-07-31        0.479   
 8 FB     2013-08-30        0.122   
 9 FB     2013-09-30        0.217   
10 FB     2013-10-31       -0.000398
# ℹ 182 more rows</code></pre>
</div>
</div>
<p>The format of <tt><code>FANG_monthly_returns</code></tt> is not compatible with the <tt><code>PortfolioAnalytics</code></tt> package as the data is currently tidy. So, we have to transform the way our database looks. Originally, we have a column called <tt><code>symbol</code></tt> and we need each stock to have their corresponding name in different columns. We can implement this change easily.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1"></a>fang <span class="ot">&lt;-</span> FANG_monthly_returns <span class="sc">|&gt;</span> </span>
<span id="cb121-2"><a href="#cb121-2"></a>  <span class="fu">tbl_xts</span>(<span class="at">spread_by =</span> <span class="st">"symbol"</span>)</span>
<span id="cb121-3"><a href="#cb121-3"></a></span>
<span id="cb121-4"><a href="#cb121-4"></a><span class="fu">head</span>(fang)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                    FB         AMZN        NFLX        GOOG
2013-01-31  0.10642857  0.031829319  0.79589177  0.04485307
2013-02-28 -0.12040026 -0.004632810  0.13822318  0.06022315
2013-03-28 -0.06128440  0.008400504  0.00638028 -0.00874938
2013-04-30  0.08561376 -0.047581495  0.14153635  0.03825280
2013-05-31 -0.12315448  0.060635964  0.04711437  0.05657498
2013-06-28  0.02176587  0.031537851 -0.06700557  0.01050246</code></pre>
</div>
</div>
<p>As you can confirm, the <tt><code>FANG</code></tt> database is the same as we only changed the format. Following our discussion about the correlation, we calculate the correlation matrix for these 4 stocks.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1"></a><span class="fu">cor</span>(fang)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            FB      AMZN      NFLX      GOOG
FB   1.0000000 0.1846197 0.2182079 0.2468989
AMZN 0.1846197 1.0000000 0.3118020 0.6171376
NFLX 0.2182079 0.3118020 1.0000000 0.3586214
GOOG 0.2468989 0.6171376 0.3586214 1.0000000</code></pre>
</div>
</div>
<p>The lowest correlation is between FB and AMZN (0.1846197). This means that both firms exhibit a weak linear relationship. On the other hand, we have GOOG and AMZN with a correlation of 0.6171376, which suggest a stronger linear relationship between these stock returns. In principle, the lower the correlation of our assets, the greater the diversification possibilities when forming a portfolio. Remember the ice cream and the hot chocolate shop example, we assumed a correlation of −0.9 and we were supposed to decrease the volatility of our sales. In practice, it is not very easy to find negative correlated assets. However, we can achieve diversification gains as long as the correlation value is less than +1.</p>
<p>Let’s continue with our main objective. We are interested in an investment recommendation (how much to invest in each of the four assets).</p>
<p>We first define a portfolio specification with the help of <tt><code>portfolio.spec()</code></tt> function.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1"></a><span class="co"># Create the portfolio specification</span></span>
<span id="cb125-2"><a href="#cb125-2"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">portfolio.spec</span>(<span class="fu">colnames</span>(fang))</span>
<span id="cb125-3"><a href="#cb125-3"></a>port_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>**************************************************
PortfolioAnalytics Portfolio Specification 
**************************************************

Call:
portfolio.spec(assets = colnames(fang))

Number of assets: 4 
Asset Names
[1] "FB"   "AMZN" "NFLX" "GOOG"</code></pre>
</div>
</div>
<p>Given the portfolio specification, we are interested in four assets. Now, add a full investment constraint such that the weights sum to 1. In practical terms, a sum exactly equal to 1 is too restrictive for the optimization, so we allow weights to sum between 0.99 and 1.01. We use the <tt><code>add.constraint()</code></tt> function.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">add.constraint</span>(<span class="at">portfolio =</span> port_spec, <span class="at">type =</span> <span class="st">"weight_sum"</span>,</span>
<span id="cb127-2"><a href="#cb127-2"></a>                            <span class="at">min_sum =</span> <span class="fl">0.99</span>, <span class="at">max_sum =</span> <span class="fl">1.01</span>)</span>
<span id="cb127-3"><a href="#cb127-3"></a>port_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>**************************************************
PortfolioAnalytics Portfolio Specification 
**************************************************

Call:
portfolio.spec(assets = colnames(fang))

Number of assets: 4 
Asset Names
[1] "FB"   "AMZN" "NFLX" "GOOG"

Constraints
Enabled constraint types
        - weight_sum </code></pre>
</div>
</div>
<p>Add a box constraint such that the portfolio optimal weights are between 0 and 1. This is equivalent as a <em>long only</em> constraint.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">add.constraint</span>(<span class="at">portfolio =</span> port_spec, <span class="at">type =</span> <span class="st">"box"</span>, </span>
<span id="cb129-2"><a href="#cb129-2"></a>                            <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb129-3"><a href="#cb129-3"></a>port_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>**************************************************
PortfolioAnalytics Portfolio Specification 
**************************************************

Call:
portfolio.spec(assets = colnames(fang))

Number of assets: 4 
Asset Names
[1] "FB"   "AMZN" "NFLX" "GOOG"

Constraints
Enabled constraint types
        - weight_sum 
        - box (long only) </code></pre>
</div>
</div>
<p>We are interested in risk and return.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1"></a><span class="co"># Add an objective to minimize portfolio standard deviation</span></span>
<span id="cb131-2"><a href="#cb131-2"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">add.objective</span>(<span class="at">portfolio =</span> port_spec,</span>
<span id="cb131-3"><a href="#cb131-3"></a>                           <span class="at">type =</span> <span class="st">"risk"</span>,</span>
<span id="cb131-4"><a href="#cb131-4"></a>                           <span class="at">name =</span> <span class="st">"StdDev"</span>)</span>
<span id="cb131-5"><a href="#cb131-5"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">add.objective</span>(<span class="at">portfolio =</span> port_spec,</span>
<span id="cb131-6"><a href="#cb131-6"></a>                           <span class="at">type =</span> <span class="st">"return"</span>,</span>
<span id="cb131-7"><a href="#cb131-7"></a>                           <span class="at">name =</span> <span class="st">"mean"</span>)</span>
<span id="cb131-8"><a href="#cb131-8"></a>port_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>**************************************************
PortfolioAnalytics Portfolio Specification 
**************************************************

Call:
portfolio.spec(assets = colnames(fang))

Number of assets: 4 
Asset Names
[1] "FB"   "AMZN" "NFLX" "GOOG"

Constraints
Enabled constraint types
        - weight_sum 
        - box (long only) 

Objectives:
Enabled objective names
        - StdDev 
        - mean </code></pre>
</div>
</div>
<p>The portfolio specification indicates that we have four assets available, these are: FB, AMZN, NFLX and GOOG. Constraints indicates that we are expected to spend 100% of the funds available, or very close to that. The constraint long refers that individual portfolio weights have to be positive.</p>
<p>The alternative of the box constraint is to allow the model to deliver negative portfolio weights. Negative portfolio weights represent short sales. Short selling is an investment strategy that speculates on the decline in a stock. Sometimes short selling is not allowed so the box constraint will deliver only positive portfolio weights.</p>
<p>The <tt><code>optimize.portfolio()</code></tt> function allows us to solve our portfolio problem by taking a variety of methods, constraints and objectives. Let’s run two of them: random and ROI, and then we can discuss their differences.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1"></a><span class="co"># Solve the optimization problem.</span></span>
<span id="cb133-2"><a href="#cb133-2"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb133-3"><a href="#cb133-3"></a>opt_rand <span class="ot">&lt;-</span> <span class="fu">optimize.portfolio</span>(fang, <span class="at">portfolio =</span> port_spec, </span>
<span id="cb133-4"><a href="#cb133-4"></a>                               <span class="at">optimize_method =</span> <span class="st">"random"</span>, <span class="at">trace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-5"><a href="#cb133-5"></a>opt_roi <span class="ot">&lt;-</span> <span class="fu">optimize.portfolio</span>(fang, <span class="at">portfolio =</span> port_spec, </span>
<span id="cb133-6"><a href="#cb133-6"></a>                              <span class="at">optimize_method =</span> <span class="st">"ROI"</span>, <span class="at">trace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-7"><a href="#cb133-7"></a><span class="co"># Show optimization results.</span></span>
<span id="cb133-8"><a href="#cb133-8"></a>opt_rand</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>***********************************
PortfolioAnalytics Optimization
***********************************

Call:
optimize.portfolio(R = fang, portfolio = port_spec, optimize_method = "random", 
    trace = TRUE)

Optimal Weights:
   FB  AMZN  NFLX  GOOG 
0.282 0.162 0.074 0.472 

Objective Measures:
 StdDev 
0.05808 


   mean 
0.02646 </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1"></a>opt_roi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>***********************************
PortfolioAnalytics Optimization
***********************************

Call:
optimize.portfolio(R = fang, portfolio = port_spec, optimize_method = "ROI", 
    trace = TRUE)

Optimal Weights:
    FB   AMZN   NFLX   GOOG 
0.3907 0.0000 0.6193 0.0000 

Objective Measure:
mean 
0.05 


StdDev 
0.1178 </code></pre>
</div>
</div>
<p>The output above shows the portfolio weights, return and risk of the two optimal portfolios. Before showing the results of this optimization in a plot, let’s look at the initial situation. In particular, the individual assets before considering any portfolio.</p>
<p>First, the relevant <tt><code>FANG</code></tt> data.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1"></a>FANG_monthly_returns <span class="ot">&lt;-</span> FANG <span class="sc">|&gt;</span></span>
<span id="cb137-2"><a href="#cb137-2"></a>    <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span></span>
<span id="cb137-3"><a href="#cb137-3"></a>    <span class="fu">tq_transmute</span>(<span class="at">select     =</span> adjusted,</span>
<span id="cb137-4"><a href="#cb137-4"></a>                 <span class="at">mutate_fun =</span> periodReturn,</span>
<span id="cb137-5"><a href="#cb137-5"></a>                 <span class="at">period     =</span> <span class="st">"monthly"</span>,</span>
<span id="cb137-6"><a href="#cb137-6"></a>                 <span class="at">type       =</span> <span class="st">"arithmetic"</span>)</span>
<span id="cb137-7"><a href="#cb137-7"></a></span>
<span id="cb137-8"><a href="#cb137-8"></a>FANG_stats <span class="ot">&lt;-</span> FANG_monthly_returns <span class="sc">|&gt;</span></span>
<span id="cb137-9"><a href="#cb137-9"></a><span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(monthly.returns), </span>
<span id="cb137-10"><a href="#cb137-10"></a>          <span class="at">sd =</span> <span class="fu">sd</span>(monthly.returns), </span>
<span id="cb137-11"><a href="#cb137-11"></a>          <span class="at">sr =</span> mean<span class="sc">/</span>sd)</span>
<span id="cb137-12"><a href="#cb137-12"></a></span>
<span id="cb137-13"><a href="#cb137-13"></a>FANG_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
  symbol   mean     sd    sr
  &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 AMZN   0.0257 0.0817 0.314
2 FB     0.0341 0.0989 0.345
3 GOOG   0.0176 0.0594 0.296
4 NFLX   0.0592 0.167  0.355</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1"></a><span class="fu">ggplot</span>(FANG_stats, <span class="fu">aes</span>(<span class="at">x =</span> sd, <span class="at">y =</span> mean, <span class="at">color =</span> symbol)) <span class="sc">+</span></span>
<span id="cb139-2"><a href="#cb139-2"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb139-3"><a href="#cb139-3"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste0</span>(symbol)), </span>
<span id="cb139-4"><a href="#cb139-4"></a>  <span class="at">vjust =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb139-5"><a href="#cb139-5"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Risk"</span>, <span class="at">y =</span> <span class="st">"Return"</span>) <span class="sc">+</span> </span>
<span id="cb139-6"><a href="#cb139-6"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.06</span>), </span>
<span id="cb139-7"><a href="#cb139-7"></a>                     <span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb139-8"><a href="#cb139-8"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb139-9"><a href="#cb139-9"></a>  <span class="fu">theme_tq</span>() <span class="sc">+</span></span>
<span id="cb139-10"><a href="#cb139-10"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ftfia" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-ftfia-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.1: FANG, the four individual assets.</figcaption>
</figure>
</div>
</div>
</div>
<p>Do you remember this plot above from previous sections? This is basically the four individual assets in the mean-variance space. The proposal of asset allocation is that instead of choosing one individual asset to invest in, we can do better by creating a portfolio. As we argue before, the role of the optimization process is precisely to determine which allocation is the most efficient.</p>
<p>For example, I do not think you will be happy with a portfolio whose return is 0.035 (3.5% monthly return) and a risk of 0.15 (15% standard deviation). This is because you could do better than that. For example, Facebook has a similar return with a 10% risk. But what if I propose a portfolio with a return of 4% and a risk of 5%? That would be great compared with the individual assets alternatives as it is a 0.8 return per unit of risk.</p>
<p>The random technique (Random Portfolios Optimization) evaluates many investment recommendation alternatives, each one is one portfolio. In principle, the technique should recommend a portfolio which leads to a more attractive return per unit of risk alternative than investing in individual assets.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1"></a><span class="co"># Plot results.</span></span>
<span id="cb140-2"><a href="#cb140-2"></a><span class="fu">chart.RiskReward</span>(opt_rand, <span class="at">risk.col =</span> <span class="st">"StdDev"</span>, </span>
<span id="cb140-3"><a href="#cb140-3"></a>                 <span class="at">return.col =</span> <span class="st">"mean"</span>, <span class="at">chart.assets =</span> <span class="cn">TRUE</span>, </span>
<span id="cb140-4"><a href="#cb140-4"></a>                 <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.10</span>))</span>
<span id="cb140-5"><a href="#cb140-5"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fl">0.05941703</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb140-6"><a href="#cb140-6"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="fl">0.02566966</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb140-7"><a href="#cb140-7"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"opt_rand"</span>, <span class="st">"equally_weighted"</span>),</span>
<span id="cb140-8"><a href="#cb140-8"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"orange"</span>), <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-frmop" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-frmop-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.2: FANG, random method optimal portfolio.</figcaption>
</figure>
</div>
</div>
</div>
<p>According to our portfolio specification and assets, gray circles represent feasible portfolios in the sense that they are possible combinations given the individual assets. Note that there are some available portfolios with a lower risk than GOOG. In fact, the algorithm suggests the blue portfolio as the optimal portfolio. This blue portfolio is attractive because it has the same risk than GOOG, but it has higher expected return. Moreover, our optimal blue portfolio has a similar return as AMZN, but with less risk. So, apparently the blue alternative is an attractive investment recommendation. Note that the gray portfolios form a kind of frontier in this mean-variance plot. This frontier suggests that it is not possible to invest in a portfolio at the left of this frontier. The optimal portfolio lies just in the frontier.</p>
<p>See the blue optimal portfolio again. We would prefer any other portfolio located in the top (higher return) or at the left (lower risk), but that is impossible given the data. On the other hand, it is possible to achieve a portfolio located below (low return) or at the right (high risk), but that is not optimal. This is why optimal portfolios are those that lie in the frontier, those are the portfolios located in the extreme high and left of this mean-variance plot.</p>
<p>Then, what can we do to invest in the blue optimal portfolio?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1"></a><span class="fu">chart.Weights</span>(opt_rand)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-frmow" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-frmow-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.3: FANG, random method optimal weights.</figcaption>
</figure>
</div>
</div>
</div>
<p>According to the <tt><code>opt_rand</code></tt> portfolio, we have to invest:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1"></a><span class="fu">extractWeights</span>(opt_rand)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   FB  AMZN  NFLX  GOOG 
0.282 0.162 0.074 0.472 </code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1"></a>opt_rand_mean <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">extractObjectiveMeasures</span>(opt_rand)<span class="sc">$</span>mean)</span>
<span id="cb144-2"><a href="#cb144-2"></a>opt_rand_sd <span class="ot">&lt;-</span> </span>
<span id="cb144-3"><a href="#cb144-3"></a>  <span class="fu">as.numeric</span>(<span class="fu">extractObjectiveMeasures</span>(opt_rand)<span class="sc">$</span>StdDev[<span class="dv">1</span>,<span class="dv">1</span>])</span>
<span id="cb144-4"><a href="#cb144-4"></a>opt_rand_sr <span class="ot">&lt;-</span> opt_rand_mean<span class="sc">/</span>opt_rand_sd</span>
<span id="cb144-5"><a href="#cb144-5"></a></span>
<span id="cb144-6"><a href="#cb144-6"></a>opt_rand_summary <span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">mean =</span> opt_rand_mean, </span>
<span id="cb144-7"><a href="#cb144-7"></a>                              <span class="at">sd =</span> opt_rand_sd, <span class="at">sr =</span> opt_rand_sr)</span>
<span id="cb144-8"><a href="#cb144-8"></a><span class="fu">row.names</span>(opt_rand_summary) <span class="ot">&lt;-</span> <span class="st">"opt_rand"</span></span>
<span id="cb144-9"><a href="#cb144-9"></a></span>
<span id="cb144-10"><a href="#cb144-10"></a>FANG_stats <span class="sc">|&gt;</span></span>
<span id="cb144-11"><a href="#cb144-11"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_rand"</span>, opt_rand_summary) <span class="sc">|&gt;</span></span>
<span id="cb144-12"><a href="#cb144-12"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>sr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
  symbol     mean     sd    sr
  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 opt_rand 0.0265 0.0581 0.456
2 NFLX     0.0592 0.167  0.355
3 FB       0.0341 0.0989 0.345
4 AMZN     0.0257 0.0817 0.314
5 GOOG     0.0176 0.0594 0.296</code></pre>
</div>
</div>
<p>The optimal portfolio <tt><code>opt_rand</code></tt> has a 0.4555797 return per unit of risk. This is clearly a better alternative compared with investing in individual assets as we show below.</p>
<p>A second criterion is to optimize according to ROI (R Optimization Infrastructure for linear and quadratic programming solvers).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1"></a><span class="co"># Plot results.</span></span>
<span id="cb146-2"><a href="#cb146-2"></a><span class="fu">chart.RiskReward</span>(opt_roi, <span class="at">risk.col =</span> <span class="st">"StdDev"</span>, </span>
<span id="cb146-3"><a href="#cb146-3"></a>                 <span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.18</span>),</span>
<span id="cb146-4"><a href="#cb146-4"></a>                 <span class="at">return.col =</span> <span class="st">"mean"</span>, <span class="at">rp =</span> <span class="cn">TRUE</span>, <span class="at">chart.assets =</span> <span class="cn">TRUE</span>)</span>
<span id="cb146-5"><a href="#cb146-5"></a><span class="fu">points</span>(<span class="fl">0.05807856</span>, <span class="fl">0.02645942</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">1.5</span>, <span class="at">col =</span> <span class="st">"black"</span>)</span>
<span id="cb146-6"><a href="#cb146-6"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"ROI"</span>, <span class="st">"opt_rand"</span>),</span>
<span id="cb146-7"><a href="#cb146-7"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"black"</span>), <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-frmop2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-frmop2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.4: FANG, ROI method optimal portfolio.</figcaption>
</figure>
</div>
</div>
</div>
<p>A different optimization criterion leads to a different optimal portfolio. However, they are both optimal as they are in the efficient frontier.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1"></a><span class="fu">chart.Weights</span>(opt_roi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-frmow2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-frmow2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.5: FANG, ROI method optimal weights.</figcaption>
</figure>
</div>
</div>
</div>
<p>According to the <tt><code>opt_roi</code></tt> portfolio, we have to invest:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1"></a><span class="fu">extractWeights</span>(opt_roi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          FB         AMZN         NFLX         GOOG 
3.906783e-01 0.000000e+00 6.193217e-01 5.610126e-17 </code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1"></a>opt_roi_mean <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">extractObjectiveMeasures</span>(opt_roi)<span class="sc">$</span>mean)</span>
<span id="cb150-2"><a href="#cb150-2"></a>opt_roi_sd <span class="ot">&lt;-</span> </span>
<span id="cb150-3"><a href="#cb150-3"></a>  <span class="fu">as.numeric</span>(<span class="fu">extractObjectiveMeasures</span>(opt_roi)<span class="sc">$</span>StdDev)</span>
<span id="cb150-4"><a href="#cb150-4"></a>opt_roi_sr <span class="ot">&lt;-</span> opt_roi_mean<span class="sc">/</span>opt_roi_sd</span>
<span id="cb150-5"><a href="#cb150-5"></a></span>
<span id="cb150-6"><a href="#cb150-6"></a>opt_roi_summary <span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">mean =</span> opt_roi_mean, </span>
<span id="cb150-7"><a href="#cb150-7"></a>                              <span class="at">sd =</span> opt_roi_sd, <span class="at">sr =</span> opt_roi_sr)</span>
<span id="cb150-8"><a href="#cb150-8"></a><span class="fu">row.names</span>(opt_roi_summary) <span class="ot">&lt;-</span> <span class="st">"opt_roi"</span></span>
<span id="cb150-9"><a href="#cb150-9"></a></span>
<span id="cb150-10"><a href="#cb150-10"></a>FANG_stats <span class="sc">|&gt;</span></span>
<span id="cb150-11"><a href="#cb150-11"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_rand"</span>, opt_rand_summary) <span class="sc">|&gt;</span></span>
<span id="cb150-12"><a href="#cb150-12"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_roi"</span>, opt_roi_summary) <span class="sc">|&gt;</span></span>
<span id="cb150-13"><a href="#cb150-13"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>sr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  symbol     mean     sd    sr
  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 opt_rand 0.0265 0.0581 0.456
2 opt_roi  0.0500 0.118  0.424
3 NFLX     0.0592 0.167  0.355
4 FB       0.0341 0.0989 0.345
5 AMZN     0.0257 0.0817 0.314
6 GOOG     0.0176 0.0594 0.296</code></pre>
</div>
</div>
<p>The optimal portfolio <tt><code>opt_roi</code></tt> has a 0.4244362 return per unit of risk. This is higher than the individual assets but lower than the <tt><code>opt_rand</code></tt> portfolio. According to the return per unit of risk, we should choose the <tt><code>opt_rand</code></tt> portfolio because it has a 0.4555797 return per unit of risk. The optimization process succeeds at proposing a better investment strategy compared with the individual assets. In practice, if you were interested to form a diversified portfolio, you could implement an analysis like this one, with some more extensive tests, but very similar to this analysis. As an individual, you could contact your broker or your financial institution at <span class="math inline">\(t=0\)</span> to ask them to invest your money according to the c portfolio: 28.2% in FB, 16.2% in AMZN, 7.4% in NFLX, and 47.2% in GOOG, and you should expect to get the <tt><code>opt_rand</code></tt> portfolio risky return at <span class="math inline">\(t=1\)</span>.</p>
<p>The orange portfolio is also interesting as it represents an equally weighted portfolio. This is, 25% in each individual asset. We usually take this as a benchmark portfolio. You do not have to implement any optimization process to find out the 25% as it is basically <span class="math inline">\(1/4\)</span> or 1 over the number of assets. Interestingly, this equally weighted portfolio is close to being optimal but if you look closer, it is not optimal.</p>
<p>Let’s take a closer look at the naïve portfolio. We have to define a new portfolio specification <tt><code>port_naive</code></tt> as we want to make sure the weights of the naïve portfolio are exactly 0.25.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1"></a>port_naive <span class="ot">&lt;-</span> <span class="fu">portfolio.spec</span>(<span class="fu">colnames</span>(fang))</span>
<span id="cb152-2"><a href="#cb152-2"></a>port_naive <span class="ot">&lt;-</span> <span class="fu">add.constraint</span>(<span class="at">portfolio =</span> port_naive, </span>
<span id="cb152-3"><a href="#cb152-3"></a>                             <span class="at">type =</span> <span class="st">"full_investment"</span>)</span>
<span id="cb152-4"><a href="#cb152-4"></a>port_naive <span class="ot">&lt;-</span> <span class="fu">add.constraint</span>(<span class="at">portfolio =</span> port_naive, </span>
<span id="cb152-5"><a href="#cb152-5"></a>                             <span class="at">type =</span> <span class="st">"long_only"</span>)</span>
<span id="cb152-6"><a href="#cb152-6"></a>port_naive <span class="ot">&lt;-</span> <span class="fu">add.objective</span>(<span class="at">portfolio =</span> port_naive,</span>
<span id="cb152-7"><a href="#cb152-7"></a>                           <span class="at">type =</span> <span class="st">"risk"</span>,</span>
<span id="cb152-8"><a href="#cb152-8"></a>                           <span class="at">name =</span> <span class="st">"StdDev"</span>)</span>
<span id="cb152-9"><a href="#cb152-9"></a>port_naive <span class="ot">&lt;-</span> <span class="fu">add.objective</span>(<span class="at">portfolio =</span> port_naive,</span>
<span id="cb152-10"><a href="#cb152-10"></a>                           <span class="at">type =</span> <span class="st">"return"</span>,</span>
<span id="cb152-11"><a href="#cb152-11"></a>                           <span class="at">name =</span> <span class="st">"mean"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now, compare the naïve portfolio with the rest.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1"></a>opt_naive <span class="ot">&lt;-</span> <span class="fu">equal.weight</span>(fang, <span class="at">portfolio =</span> port_naive)</span>
<span id="cb153-2"><a href="#cb153-2"></a>opt_naive_mean <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">extractObjectiveMeasures</span>(opt_naive)<span class="sc">$</span>mean)</span>
<span id="cb153-3"><a href="#cb153-3"></a>opt_naive_sd <span class="ot">&lt;-</span> </span>
<span id="cb153-4"><a href="#cb153-4"></a>  <span class="fu">as.numeric</span>(<span class="fu">extractObjectiveMeasures</span>(opt_naive)<span class="sc">$</span>StdDev)</span>
<span id="cb153-5"><a href="#cb153-5"></a>opt_naive_sr <span class="ot">&lt;-</span> opt_naive_mean<span class="sc">/</span>opt_naive_sd</span>
<span id="cb153-6"><a href="#cb153-6"></a>opt_naive_summary <span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">mean =</span> opt_naive_mean, </span>
<span id="cb153-7"><a href="#cb153-7"></a>                              <span class="at">sd =</span> opt_naive_sd, <span class="at">sr =</span> opt_naive_sr)</span>
<span id="cb153-8"><a href="#cb153-8"></a><span class="fu">row.names</span>(opt_naive_summary) <span class="ot">&lt;-</span> <span class="st">"opt_naive"</span></span>
<span id="cb153-9"><a href="#cb153-9"></a></span>
<span id="cb153-10"><a href="#cb153-10"></a>FANG_stats <span class="sc">|&gt;</span></span>
<span id="cb153-11"><a href="#cb153-11"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_rand"</span>, opt_rand_summary) <span class="sc">|&gt;</span></span>
<span id="cb153-12"><a href="#cb153-12"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_roi"</span>, opt_roi_summary) <span class="sc">|&gt;</span></span>
<span id="cb153-13"><a href="#cb153-13"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_naive"</span>, opt_naive_summary) <span class="sc">|&gt;</span></span>
<span id="cb153-14"><a href="#cb153-14"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>sr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 4
  symbol      mean     sd    sr
  &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 opt_naive 0.0341 0.0718 0.476
2 opt_rand  0.0265 0.0581 0.456
3 opt_roi   0.0500 0.118  0.424
4 NFLX      0.0592 0.167  0.355
5 FB        0.0341 0.0989 0.345
6 AMZN      0.0257 0.0817 0.314
7 GOOG      0.0176 0.0594 0.296</code></pre>
</div>
</div>
<p>It may be disappointing to find out that the naïve portfolio <tt><code>port_naive</code></tt> has the higher Sharpe ratio including the optimal alternatives. We can add a target return constraint to the optimization problem so we can find out an optimal portfolio that targets the naïve portfolio expected return.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1"></a>port_spec2 <span class="ot">&lt;-</span> <span class="fu">add.constraint</span>(<span class="at">portfolio =</span> port_spec, <span class="at">type =</span> <span class="st">"return"</span>, </span>
<span id="cb155-2"><a href="#cb155-2"></a>                             <span class="at">return_target =</span> <span class="fl">0.03414333</span>)</span>
<span id="cb155-3"><a href="#cb155-3"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb155-4"><a href="#cb155-4"></a>opt_roi2 <span class="ot">&lt;-</span> <span class="fu">optimize.portfolio</span>(fang, <span class="at">portfolio =</span> port_spec2,</span>
<span id="cb155-5"><a href="#cb155-5"></a>                               <span class="at">optimize_method =</span> <span class="st">"ROI"</span>, <span class="at">maxSR =</span> <span class="cn">TRUE</span>,</span>
<span id="cb155-6"><a href="#cb155-6"></a>                               <span class="at">rf =</span> <span class="dv">0</span>, <span class="at">trace =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1"></a><span class="fu">chart.Weights</span>(opt_roi2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-frmowtttnper" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-frmowtttnper-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.6: FANG, ROI method optimal weights that targets the naïve portfolio expected return.</figcaption>
</figure>
</div>
</div>
</div>
<p>According to the <tt><code>opt_roi2</code></tt> portfolio, we have to invest:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1"></a><span class="fu">extractWeights</span>(opt_roi2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       FB      AMZN      NFLX      GOOG 
0.3755684 0.2987422 0.2049933 0.1203416 </code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1"></a><span class="co"># Plot results.</span></span>
<span id="cb159-2"><a href="#cb159-2"></a><span class="fu">chart.RiskReward</span>(opt_roi2, <span class="at">risk.col =</span> <span class="st">"StdDev"</span>,</span>
<span id="cb159-3"><a href="#cb159-3"></a><span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">0.07</span>, <span class="fl">0.073</span>),</span>
<span id="cb159-4"><a href="#cb159-4"></a><span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.032</span>, <span class="fl">0.036</span>),</span>
<span id="cb159-5"><a href="#cb159-5"></a><span class="at">return.col =</span> <span class="st">"mean"</span>, <span class="at">chart.assets =</span> <span class="cn">TRUE</span>, <span class="at">cex =</span> <span class="dv">2</span>)</span>
<span id="cb159-6"><a href="#cb159-6"></a><span class="fu">points</span>(<span class="fl">0.07176544</span>, <span class="fl">0.03414333</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"orange"</span>, <span class="at">cex =</span> <span class="dv">2</span>)</span>
<span id="cb159-7"><a href="#cb159-7"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"opt_roi"</span>, <span class="st">"equally_weighted"</span>),</span>
<span id="cb159-8"><a href="#cb159-8"></a><span class="at">col =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"orange"</span>), <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-frmtttnper" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-frmtttnper-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.7: FANG, ROI method that targets the naïve portfolio expected return.</figcaption>
</figure>
</div>
</div>
</div>
<p>Now, compare the <tt><code>opt_roi2</code></tt> portfolio with the rest.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1"></a>opt_roi2_mean <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">extractObjectiveMeasures</span>(opt_roi2)<span class="sc">$</span>mean)</span>
<span id="cb160-2"><a href="#cb160-2"></a>opt_roi2_sd <span class="ot">&lt;-</span> </span>
<span id="cb160-3"><a href="#cb160-3"></a>  <span class="fu">as.numeric</span>(<span class="fu">extractObjectiveMeasures</span>(opt_roi2)<span class="sc">$</span>StdDev)</span>
<span id="cb160-4"><a href="#cb160-4"></a>opt_roi2_sr <span class="ot">&lt;-</span> opt_roi2_mean<span class="sc">/</span>opt_roi2_sd</span>
<span id="cb160-5"><a href="#cb160-5"></a>opt_roi2_summary <span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">mean =</span> opt_roi2_mean, </span>
<span id="cb160-6"><a href="#cb160-6"></a>                              <span class="at">sd =</span> opt_roi2_sd, <span class="at">sr =</span> opt_roi2_sr)</span>
<span id="cb160-7"><a href="#cb160-7"></a><span class="fu">row.names</span>(opt_roi2_summary) <span class="ot">&lt;-</span> <span class="st">"opt_roi2"</span></span>
<span id="cb160-8"><a href="#cb160-8"></a></span>
<span id="cb160-9"><a href="#cb160-9"></a>FANG_stats <span class="sc">|&gt;</span></span>
<span id="cb160-10"><a href="#cb160-10"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_rand"</span>, opt_rand_summary) <span class="sc">|&gt;</span></span>
<span id="cb160-11"><a href="#cb160-11"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_roi"</span>, opt_roi_summary) <span class="sc">|&gt;</span></span>
<span id="cb160-12"><a href="#cb160-12"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_naive"</span>, opt_naive_summary) <span class="sc">|&gt;</span></span>
<span id="cb160-13"><a href="#cb160-13"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_roi2"</span>, opt_roi2_summary) <span class="sc">|&gt;</span></span>
<span id="cb160-14"><a href="#cb160-14"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>sr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 4
  symbol      mean     sd    sr
  &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 opt_roi2  0.0347 0.0716 0.485
2 opt_naive 0.0341 0.0718 0.476
3 opt_rand  0.0265 0.0581 0.456
4 opt_roi   0.0500 0.118  0.424
5 NFLX      0.0592 0.167  0.355
6 FB        0.0341 0.0989 0.345
7 AMZN      0.0257 0.0817 0.314
8 GOOG      0.0176 0.0594 0.296</code></pre>
</div>
</div>
<p>The expected return in <span class="math inline">\(t=0\)</span> of the <tt><code>opt_rand</code></tt> portfolio is 0.02645942. The value of 0.02606294 is simply the sum of the <tt><code>opt_rand</code></tt> portfolio weights multiplied by the individual asset returns. But, what will be your realized return at <span class="math inline">\(t=1\)</span>? Let’s simulate the future <span class="math inline">\(t=1\)</span> to find out.</p>
<p>In this case, we invest in <span class="math inline">\(t=0\)</span> or 2016-12-30 and the future is <span class="math inline">\(t=1\)</span> or 2017-01-31. There are many ways to conduct the simulation. Let’s keep it simple and use the historical mean and standard deviation information we have.</p>
<p>Let’s simulate 1,000 observations of each individual asset and portfolios. We assume that the assets behave as a normal with mean and standard deviation as we show in the table above. This approach can be interpreted as if we were simulating 1,000 alternative values for 2017-01-31. By doing this, we could have a sense about what will be the most likely value at <span class="math inline">\(t=1\)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1"></a><span class="co"># Number of simulations.</span></span>
<span id="cb162-2"><a href="#cb162-2"></a>sim <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb162-3"><a href="#cb162-3"></a><span class="fu">set.seed</span> (<span class="dv">7</span>)</span>
<span id="cb162-4"><a href="#cb162-4"></a><span class="co"># Simulation per stock and portfolio.</span></span>
<span id="cb162-5"><a href="#cb162-5"></a>s_AMZN <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(sim, <span class="fl">0.02566966</span>, <span class="fl">0.08172605</span>)</span>
<span id="cb162-6"><a href="#cb162-6"></a>s_FB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(sim, <span class="fl">0.03412852</span>, <span class="fl">0.09894324</span>)</span>
<span id="cb162-7"><a href="#cb162-7"></a>s_GOOG <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(sim, <span class="fl">0.01757620</span>, <span class="fl">0.05941703</span>)</span>
<span id="cb162-8"><a href="#cb162-8"></a>s_NFLX <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(sim, <span class="fl">0.05919893</span>, <span class="fl">0.16656346</span>)</span>
<span id="cb162-9"><a href="#cb162-9"></a>s_ran <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(sim, opt_rand<span class="sc">$</span>opt_values<span class="sc">$</span>mean, opt_rand<span class="sc">$</span>opt_values<span class="sc">$</span>StdDev)</span>
<span id="cb162-10"><a href="#cb162-10"></a>s_roi <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(sim, opt_roi<span class="sc">$</span>opt_values<span class="sc">$</span>mean, opt_roi<span class="sc">$</span>opt_values<span class="sc">$</span>StdDev)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The simulation is done. Now let’s visualize the results in a boxplot. Boxplots show the distribution of the data in a data set. It divides the data set into three quartiles. This graph represents the minimum, maximum, median, first quartile and third quartile in the data set.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1"></a><span class="co"># The boxplot.</span></span>
<span id="cb163-2"><a href="#cb163-2"></a>b <span class="ot">=</span> <span class="fu">cbind</span>(s_FB, s_AMZN, s_NFLX, s_GOOG, s_ran, s_roi)</span>
<span id="cb163-3"><a href="#cb163-3"></a><span class="fu">boxplot</span>(b, <span class="at">las =</span> <span class="dv">2</span>)</span>
<span id="cb163-4"><a href="#cb163-4"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fsroia" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fsroia-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.8: FANG, simulated returns of investment alternatives.</figcaption>
</figure>
</div>
</div>
</div>
<p>Note that the <tt><code>opt_rand</code></tt> portfolio is well diversified and <tt><code>opt_roi</code></tt> is more risky. This plot reveals a glimpse to the future assuming that the assets follow a normal distribution. This assumption is not as bad and it is useful to simplify the analysis. Are we satisfied with this glimpse to the future? Sometimes it is the best you can have at <span class="math inline">\(t=0\)</span>. In this case, we fortunately know what really happened with these stocks on 2017-01-31. Let’s evaluate the returns that really happened at <span class="math inline">\(t=1\)</span> for the individual and portfolios.</p>
<p>First, we need the 2017-01-31 actual or realized returns. We need to download the data as the <tt><code>FANG</code></tt> database ends at 2016-12-30.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1"></a><span class="co"># Download the 2017-01-31 individual asset returns.</span></span>
<span id="cb164-2"><a href="#cb164-2"></a>r_stocks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"META"</span>, <span class="st">"AMZN"</span>, <span class="st">"NFLX"</span>, <span class="st">"GOOG"</span>) <span class="sc">|&gt;</span></span>
<span id="cb164-3"><a href="#cb164-3"></a>  <span class="fu">tq_get</span>(<span class="at">get  =</span> <span class="st">"stock.prices"</span>, <span class="at">from =</span> <span class="st">"2016-12-31"</span>, </span>
<span id="cb164-4"><a href="#cb164-4"></a>         <span class="at">to   =</span> <span class="st">"2017-01-31"</span>) <span class="sc">|&gt;</span></span>
<span id="cb164-5"><a href="#cb164-5"></a>  <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span> </span>
<span id="cb164-6"><a href="#cb164-6"></a>  <span class="fu">tq_transmute</span>(<span class="at">select     =</span> adjusted, </span>
<span id="cb164-7"><a href="#cb164-7"></a>               <span class="at">mutate_fun =</span> periodReturn, </span>
<span id="cb164-8"><a href="#cb164-8"></a>               <span class="at">period     =</span> <span class="st">"monthly"</span>, </span>
<span id="cb164-9"><a href="#cb164-9"></a>               <span class="at">col_rename =</span> <span class="st">"R_stocks"</span>) <span class="sc">|&gt;</span></span>
<span id="cb164-10"><a href="#cb164-10"></a>  <span class="fu">tbl_xts</span>(<span class="at">spread_by =</span> <span class="st">"symbol"</span>)</span>
<span id="cb164-11"><a href="#cb164-11"></a></span>
<span id="cb164-12"><a href="#cb164-12"></a>r_stocks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                META     AMZN      NFLX       GOOG
2017-01-30 0.1208283 0.101782 0.1076947 0.02058163</code></pre>
</div>
</div>
<p>These are the realized monthly returns at <span class="math inline">\(t=1\)</span>. Please note that we have not introduced these returns before. Our model and portfolios ignores these returns. Now, we need to evaluate the realized return of both optimal portfolios. This is done by adding the multiplication of weights and individual realized returns. This approach is commonly known as out-of-sample evaluation.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1"></a><span class="co"># Calculate realized portfolio returns.</span></span>
<span id="cb166-2"><a href="#cb166-2"></a>realized_ret <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">opt_rand =</span> <span class="fu">sum</span>(opt_rand<span class="sc">$</span>weights <span class="sc">*</span> r_stocks),</span>
<span id="cb166-3"><a href="#cb166-3"></a>                  <span class="at">opt_roi =</span> <span class="fu">sum</span>(opt_roi<span class="sc">$</span>weights <span class="sc">*</span> r_stocks))</span>
<span id="cb166-4"><a href="#cb166-4"></a></span>
<span id="cb166-5"><a href="#cb166-5"></a>expected_ret <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">opt_rand =</span> opt_rand<span class="sc">$</span>opt_values<span class="sc">$</span>mean,</span>
<span id="cb166-6"><a href="#cb166-6"></a>                  <span class="at">opt_roi =</span> opt_roi<span class="sc">$</span>opt_values<span class="sc">$</span>mean)</span>
<span id="cb166-7"><a href="#cb166-7"></a></span>
<span id="cb166-8"><a href="#cb166-8"></a><span class="fu">data.frame</span>(<span class="fu">cbind</span>(realized_ret, expected_ret))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         realized_ret expected_ret
opt_rand   0.06824621   0.02645942
opt_roi    0.11390269   0.04999645</code></pre>
</div>
</div>
<p>In sum, the expected monthly return in <span class="math inline">\(t=0\)</span> of <tt><code>opt_rand</code></tt> portfolio is 0.02606294, and the realized monthly return in <span class="math inline">\(t=1\)</span> is 0.06958923. Not bad. The expected monthly return in <span class="math inline">\(t=0\)</span> of <tt><code>opt_roi</code></tt> is 0.04999645, and the realized monthly return in <span class="math inline">\(t=1\)</span> is 0.11390269.</p>
<p>Let’s see the whole thing now. This is, the distribution of the simulation and the realized returns in red.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1"></a><span class="co"># The simulation.</span></span>
<span id="cb168-2"><a href="#cb168-2"></a><span class="fu">boxplot</span>(b, <span class="at">las =</span> <span class="dv">2</span>)</span>
<span id="cb168-3"><a href="#cb168-3"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb168-4"><a href="#cb168-4"></a><span class="co"># The realized returns in red.</span></span>
<span id="cb168-5"><a href="#cb168-5"></a><span class="fu">points</span>(<span class="dv">1</span>, <span class="fl">0.1208283</span>,  <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="dv">2</span>)</span>
<span id="cb168-6"><a href="#cb168-6"></a><span class="fu">points</span>(<span class="dv">2</span>, <span class="fl">0.101782</span>,   <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="dv">2</span>)</span>
<span id="cb168-7"><a href="#cb168-7"></a><span class="fu">points</span>(<span class="dv">3</span>, <span class="fl">0.1076947</span>,  <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="dv">2</span>)</span>
<span id="cb168-8"><a href="#cb168-8"></a><span class="fu">points</span>(<span class="dv">4</span>, <span class="fl">0.02058163</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="dv">2</span>)</span>
<span id="cb168-9"><a href="#cb168-9"></a><span class="fu">points</span>(<span class="dv">5</span>, <span class="fu">sum</span>(opt_rand<span class="sc">$</span>weights <span class="sc">*</span> r_stocks), <span class="at">col =</span> <span class="st">"red"</span>, </span>
<span id="cb168-10"><a href="#cb168-10"></a>       <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="dv">2</span>)</span>
<span id="cb168-11"><a href="#cb168-11"></a><span class="fu">points</span>(<span class="dv">6</span>, <span class="fu">sum</span>(opt_roi<span class="sc">$</span>weights <span class="sc">*</span> r_stocks),  <span class="at">col =</span> <span class="st">"red"</span>, </span>
<span id="cb168-12"><a href="#cb168-12"></a>       <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fsroiawrhb2ir" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fsroiawrhb2ir-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.9: FANG, simulated returns of investment alternatives. What really happened by 2017-01-30 in red.</figcaption>
</figure>
</div>
</div>
</div>
<p>The realized returns can be quite different from the promised or expected returns. This difference depends on the method, the model, the database length, the ability of the portfolio designer, and also depends on a random component. In our <tt><code>FANG</code></tt> example, the optimal investment recommendations were good alternatives.</p>
<p>It is tempting to calculate an optimal portfolio based on our previous CAPM example. Let’s do it here just to show how easy is it to replicate the analysis with a different database, which is the beauty of reproducibility as I basically did a copy paste of the previous code.</p>
<p>The data.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1"></a><span class="co"># Download individual asset returns.</span></span>
<span id="cb169-2"><a href="#cb169-2"></a>R_stocks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"NEM"</span>, <span class="st">"AMCR"</span>, <span class="st">"CLX"</span>, <span class="st">"PEAK"</span>, <span class="st">"KR"</span>, <span class="st">"TXN"</span>, <span class="st">"F"</span>, <span class="st">"TXT"</span>, </span>
<span id="cb169-3"><a href="#cb169-3"></a>              <span class="st">"KLAC"</span>, <span class="st">"TEF"</span>) <span class="sc">|&gt;</span></span>
<span id="cb169-4"><a href="#cb169-4"></a>  <span class="fu">tq_get</span>(<span class="at">get  =</span> <span class="st">"stock.prices"</span>, <span class="at">from =</span> <span class="st">"2010-01-01"</span>, </span>
<span id="cb169-5"><a href="#cb169-5"></a>         <span class="at">to   =</span> <span class="st">"2015-12-31"</span>) <span class="sc">|&gt;</span></span>
<span id="cb169-6"><a href="#cb169-6"></a>  <span class="fu">group_by</span>(symbol) <span class="sc">|&gt;</span> </span>
<span id="cb169-7"><a href="#cb169-7"></a>  <span class="fu">tq_transmute</span>(<span class="at">select     =</span> adjusted, </span>
<span id="cb169-8"><a href="#cb169-8"></a>               <span class="at">mutate_fun =</span> periodReturn, </span>
<span id="cb169-9"><a href="#cb169-9"></a>               <span class="at">period     =</span> <span class="st">"monthly"</span>, </span>
<span id="cb169-10"><a href="#cb169-10"></a>               <span class="at">col_rename =</span> <span class="st">"R_stocks"</span>)</span>
<span id="cb169-11"><a href="#cb169-11"></a>R_stocks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 692 × 3
# Groups:   symbol [10]
   symbol date       R_stocks
   &lt;chr&gt;  &lt;date&gt;        &lt;dbl&gt;
 1 NEM    2010-01-29  -0.115 
 2 NEM    2010-02-26   0.150 
 3 NEM    2010-03-31   0.0355
 4 NEM    2010-04-30   0.101 
 5 NEM    2010-05-28  -0.0403
 6 NEM    2010-06-30   0.149 
 7 NEM    2010-07-30  -0.0946
 8 NEM    2010-08-31   0.0970
 9 NEM    2010-09-30   0.0268
10 NEM    2010-10-29  -0.0310
# ℹ 682 more rows</code></pre>
</div>
</div>
<p>The portfolio specification.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1"></a>capm_stocks <span class="ot">&lt;-</span> R_stocks <span class="sc">|&gt;</span> </span>
<span id="cb171-2"><a href="#cb171-2"></a>  <span class="fu">tbl_xts</span>(<span class="at">spread_by =</span> <span class="st">"symbol"</span>) <span class="sc">|&gt;</span></span>
<span id="cb171-3"><a href="#cb171-3"></a>  <span class="fu">na.fill</span>(<span class="at">fill =</span> <span class="fl">0.00</span>)</span>
<span id="cb171-4"><a href="#cb171-4"></a></span>
<span id="cb171-5"><a href="#cb171-5"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">portfolio.spec</span>(<span class="fu">colnames</span>(capm_stocks))</span>
<span id="cb171-6"><a href="#cb171-6"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">add.constraint</span>(<span class="at">portfolio =</span> port_spec, <span class="at">type =</span> <span class="st">"weight_sum"</span>,</span>
<span id="cb171-7"><a href="#cb171-7"></a>                            <span class="at">min_sum =</span> <span class="fl">0.99</span>, <span class="at">max_sum =</span> <span class="fl">1.01</span>)</span>
<span id="cb171-8"><a href="#cb171-8"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">add.constraint</span>(<span class="at">portfolio =</span> port_spec, <span class="at">type =</span> <span class="st">"box"</span>, </span>
<span id="cb171-9"><a href="#cb171-9"></a>                            <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb171-10"><a href="#cb171-10"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">add.objective</span>(<span class="at">portfolio =</span> port_spec,</span>
<span id="cb171-11"><a href="#cb171-11"></a>                           <span class="at">type =</span> <span class="st">"risk"</span>,</span>
<span id="cb171-12"><a href="#cb171-12"></a>                           <span class="at">name =</span> <span class="st">"StdDev"</span>)</span>
<span id="cb171-13"><a href="#cb171-13"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">add.objective</span>(<span class="at">portfolio =</span> port_spec,</span>
<span id="cb171-14"><a href="#cb171-14"></a>                           <span class="at">type =</span> <span class="st">"return"</span>,</span>
<span id="cb171-15"><a href="#cb171-15"></a>                           <span class="at">name =</span> <span class="st">"mean"</span>)</span>
<span id="cb171-16"><a href="#cb171-16"></a>port_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>**************************************************
PortfolioAnalytics Portfolio Specification 
**************************************************

Call:
portfolio.spec(assets = colnames(capm_stocks))

Number of assets: 10 
Asset Names
 [1] "NEM"  "AMCR" "CLX"  "PEAK" "KR"   "TXN"  "F"    "TXT"  "KLAC" "TEF" 

Constraints
Enabled constraint types
        - weight_sum 
        - box (long only) 

Objectives:
Enabled objective names
        - StdDev 
        - mean </code></pre>
</div>
</div>
<p>The random method.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb173-2"><a href="#cb173-2"></a>opt_rand <span class="ot">&lt;-</span> <span class="fu">optimize.portfolio</span>(capm_stocks, <span class="at">portfolio =</span> port_spec,</span>
<span id="cb173-3"><a href="#cb173-3"></a>                          <span class="at">optimize_method =</span> <span class="st">"random"</span>, <span class="at">trace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb173-4"><a href="#cb173-4"></a><span class="fu">chart.RiskReward</span>(opt_rand, <span class="at">risk.col =</span> <span class="st">"StdDev"</span>, </span>
<span id="cb173-5"><a href="#cb173-5"></a>                 <span class="at">return.col =</span> <span class="st">"mean"</span>, <span class="at">chart.assets =</span> <span class="cn">TRUE</span>)</span>
<span id="cb173-6"><a href="#cb173-6"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"opt_rand"</span>, <span class="st">"equally_weighted"</span>),</span>
<span id="cb173-7"><a href="#cb173-7"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"orange"</span>), <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb173-8"><a href="#cb173-8"></a><span class="fu">abline</span>(<span class="dv">0</span>, opt_rand<span class="sc">$</span>objective_measures<span class="sc">$</span>mean <span class="sc">/</span></span>
<span id="cb173-9"><a href="#cb173-9"></a>         opt_rand<span class="sc">$</span>objective_measures<span class="sc">$</span>StdDev, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-tarmop" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-tarmop-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.10: 10-assets, random method optimal portfolio.</figcaption>
</figure>
</div>
</div>
</div>
<p>Here, the slope of the red line corresponds to the optimal portfolio return per unit of risk. This means that the optimal portfolio has a similar return per unit of risk compared with KR. Note how the rest of the assets have a lower return per unit of risk.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1"></a><span class="fu">extractWeights</span>(opt_rand)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  NEM  AMCR   CLX  PEAK    KR   TXN     F   TXT  KLAC   TEF 
0.110 0.264 0.472 0.008 0.150 0.000 0.000 0.000 0.000 0.000 </code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1"></a><span class="fu">chart.Weights</span>(opt_rand)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-tarmopw" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-tarmopw-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.11: 10-assets, random method optimal weights.</figcaption>
</figure>
</div>
</div>
</div>
<p>Finally the ROI method.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1"></a>opt_roi <span class="ot">&lt;-</span> <span class="fu">optimize.portfolio</span>(capm_stocks, <span class="at">portfolio =</span> port_spec,</span>
<span id="cb177-2"><a href="#cb177-2"></a>                          <span class="at">optimize_method =</span> <span class="st">"ROI"</span>, <span class="at">trace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb177-3"><a href="#cb177-3"></a><span class="fu">chart.RiskReward</span>(opt_roi, <span class="at">risk.col =</span> <span class="st">"StdDev"</span>, </span>
<span id="cb177-4"><a href="#cb177-4"></a>                 <span class="at">return.col =</span> <span class="st">"mean"</span>, <span class="at">rp =</span> <span class="cn">TRUE</span>, <span class="at">chart.assets =</span> <span class="cn">TRUE</span>)</span>
<span id="cb177-5"><a href="#cb177-5"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"opt_roi"</span>),</span>
<span id="cb177-6"><a href="#cb177-6"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"blue"</span>), <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb177-7"><a href="#cb177-7"></a><span class="fu">abline</span>(<span class="dv">0</span>, opt_roi<span class="sc">$</span>objective_measures<span class="sc">$</span>mean <span class="sc">/</span></span>
<span id="cb177-8"><a href="#cb177-8"></a>         opt_roi<span class="sc">$</span>objective_measures<span class="sc">$</span>StdDev, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-tarmop2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-tarmop2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.12: 10-assets, ROI method optimal portfolio.</figcaption>
</figure>
</div>
</div>
</div>
<p>This is basically 100% in KR.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1"></a><span class="fu">extractWeights</span>(opt_roi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          NEM          AMCR           CLX          PEAK            KR 
 2.678417e-17  1.977324e-16  1.477513e-17  3.972548e-17  1.000000e+00 
          TXN             F           TXT          KLAC           TEF 
 1.163355e-16 -3.057955e-17  0.000000e+00  1.000000e-02  1.041718e-17 </code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1"></a><span class="fu">chart.Weights</span>(opt_roi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-tarmow2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-tarmow2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.13: 10-assets, ROI method optimal weights.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="diversification." class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="diversification."><span class="header-section-number">4.2</span> Diversification.</h2>
<p>In finance, diversification is the process of allocating capital (or creating a portfolio) in a way that reduces the exposure to any one particular asset or risk factor. We usually recommend to invest in a variety of assets to achieve an overall risk reduction of our portfolio. However, if those assets are as correlated as Visa and Mastercard (as discussed before), then our diversification efforts would not be so effective. In this section, we propose an experiment to illustrate the role of diversification in asset allocation. The experiment is to artificially generate two assets and add them to the <tt><code>FANG</code></tt> database, so we end up with 6 assets. The special characteristic of these two new assets <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> is that they both have a very extreme negative correlation value. Once we add these two assets, we will repeat the portfolio optimization and see if we could do better than before.</p>
<p>First, let’s generate these two assets returns. Note that these two new assets <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> do not exist in the real world, we are artificially generating them by implementing a simulation technique.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb181-2"><a href="#cb181-2"></a>data <span class="ot">=</span> <span class="fu">mvrnorm</span>(<span class="at">n =</span> <span class="dv">48</span>, <span class="at">mu =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.5</span>), </span>
<span id="cb181-3"><a href="#cb181-3"></a>               <span class="at">Sigma =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="fl">1.4</span>, <span class="sc">-</span><span class="fl">1.4</span>, <span class="dv">2</span>), <span class="at">nrow =</span> <span class="dv">2</span>), </span>
<span id="cb181-4"><a href="#cb181-4"></a>               <span class="at">empirical =</span> <span class="cn">TRUE</span>)<span class="sc">/</span><span class="dv">10</span></span>
<span id="cb181-5"><a href="#cb181-5"></a>xy <span class="ot">=</span> <span class="fu">as.data.frame</span>(data)</span>
<span id="cb181-6"><a href="#cb181-6"></a>X <span class="ot">=</span> xy<span class="sc">$</span>V1</span>
<span id="cb181-7"><a href="#cb181-7"></a>Y <span class="ot">=</span> xy<span class="sc">$</span>V2</span>
<span id="cb181-8"><a href="#cb181-8"></a><span class="co"># Add X and Y to the fang database.</span></span>
<span id="cb181-9"><a href="#cb181-9"></a>fang_xy <span class="ot">&lt;-</span> fang</span>
<span id="cb181-10"><a href="#cb181-10"></a>fang_xy<span class="sc">$</span>X <span class="ot">&lt;-</span> X</span>
<span id="cb181-11"><a href="#cb181-11"></a>fang_xy<span class="sc">$</span>Y <span class="ot">&lt;-</span> Y</span>
<span id="cb181-12"><a href="#cb181-12"></a><span class="fu">head</span>(fang_xy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                    FB         AMZN        NFLX        GOOG          X
2013-01-31  0.10642857  0.031829319  0.79589177  0.04485307 0.08235099
2013-02-28 -0.12040026 -0.004632810  0.13822318  0.06022315 0.11219977
2013-03-28 -0.06128440  0.008400504  0.00638028 -0.00874938 0.15700719
2013-04-30  0.08561376 -0.047581495  0.14153635  0.03825280 0.09411057
2013-05-31 -0.12315448  0.060635964  0.04711437  0.05657498 0.07357672
2013-06-28  0.02176587  0.031537851 -0.06700557  0.01050246 0.01481500
                     Y
2013-01-31 -0.04241279
2013-02-28 -0.05184889
2013-03-28 -0.16791336
2013-04-30 -0.04495379
2013-05-31 -0.05019958
2013-06-28  0.04137669</code></pre>
</div>
</div>
<p>Let’s now verify that these two new assets are negatively correlated.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1"></a><span class="fu">cor</span>(fang_xy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              FB        AMZN        NFLX       GOOG           X           Y
FB    1.00000000  0.18461970  0.21820791  0.2468989  0.03779375 -0.04276241
AMZN  0.18461970  1.00000000  0.31180203  0.6171376  0.04877402 -0.05611269
NFLX  0.21820791  0.31180203  1.00000000  0.3586214  0.06772682 -0.05943567
GOOG  0.24689886  0.61713764  0.35862138  1.0000000  0.20682201 -0.19110508
X     0.03779375  0.04877402  0.06772682  0.2068220  1.00000000 -0.98994949
Y    -0.04276241 -0.05611269 -0.05943567 -0.1911051 -0.98994949  1.00000000</code></pre>
</div>
</div>
<p>The correlation of <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> is −0.98994949, this is very close to −1, so they are strongly negatively correlated. This is just what we wanted. In fact, the correlation of these two new assets and the rest are also negative. In principle, we should expect a new optimal portfolio with a greater return per unit of risk.</p>
<p>Some may argue that investing in two inversely correlated assets would lead to a zero expected return. This is not the case as shown below.</p>
<p>Let’s create a sequence of <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> portfolio weights.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1"></a>w_x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.01</span>)</span>
<span id="cb185-2"><a href="#cb185-2"></a>w_y <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> w_x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then, the two assets portfolio expected return and risk.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1"></a>ret_xy <span class="ot">&lt;-</span> w_x <span class="sc">*</span> <span class="fu">mean</span>(fang_xy<span class="sc">$</span>X) <span class="sc">+</span> w_y <span class="sc">*</span> <span class="fu">mean</span>(fang_xy<span class="sc">$</span>Y)</span>
<span id="cb186-2"><a href="#cb186-2"></a>sd_xy <span class="ot">&lt;-</span> (w_x<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">sd</span>(fang_xy<span class="sc">$</span>X)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb186-3"><a href="#cb186-3"></a>          w_y<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">sd</span>(fang_xy<span class="sc">$</span>Y)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb186-4"><a href="#cb186-4"></a>          <span class="dv">2</span> <span class="sc">*</span> w_x <span class="sc">*</span> w_y <span class="sc">*</span> <span class="fu">sd</span>(fang_xy<span class="sc">$</span>X) <span class="sc">*</span> <span class="fu">sd</span>(fang_xy<span class="sc">$</span>Y) <span class="sc">*</span></span>
<span id="cb186-5"><a href="#cb186-5"></a>            <span class="fu">cor</span>(fang_xy<span class="sc">$</span>X, fang_xy<span class="sc">$</span>Y))<span class="sc">^</span><span class="fl">0.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1"></a><span class="fu">plot</span>(sd_xy, ret_xy, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.05</span>),</span>
<span id="cb187-2"><a href="#cb187-2"></a>     <span class="at">xlab =</span> <span class="st">"Risk"</span>, <span class="at">ylab =</span> <span class="st">"Expected return"</span>)</span>
<span id="cb187-3"><a href="#cb187-3"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb187-4"><a href="#cb187-4"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb187-5"><a href="#cb187-5"></a><span class="fu">points</span>(<span class="fu">sd</span>(fang_xy<span class="sc">$</span>X), <span class="fu">mean</span>(fang_xy<span class="sc">$</span>X), <span class="at">cex =</span> <span class="dv">2</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb187-6"><a href="#cb187-6"></a><span class="fu">points</span>(<span class="fu">sd</span>(fang_xy<span class="sc">$</span>Y), <span class="fu">mean</span>(fang_xy<span class="sc">$</span>Y), <span class="at">cex =</span> <span class="dv">2</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb187-7"><a href="#cb187-7"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>),</span>
<span id="cb187-8"><a href="#cb187-8"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-taef" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-taef-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.14: 2-assets, efficient frontier.</figcaption>
</figure>
</div>
</div>
</div>
<p>Which is the minimum portfolio risk?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1"></a><span class="fu">min</span>(sd_xy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.008354639</code></pre>
</div>
</div>
<p>Which is the observation that match the minimum portfolio risk?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1"></a><span class="fu">which.min</span>(sd_xy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 60</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1"></a><span class="fu">plot</span>(sd_xy, ret_xy, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.05</span>),</span>
<span id="cb192-2"><a href="#cb192-2"></a>     <span class="at">xlab =</span> <span class="st">"Risk"</span>, <span class="at">ylab =</span> <span class="st">"Expected return"</span>)</span>
<span id="cb192-3"><a href="#cb192-3"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb192-4"><a href="#cb192-4"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb192-5"><a href="#cb192-5"></a><span class="fu">points</span>(<span class="fu">sd</span>(fang_xy<span class="sc">$</span>X), <span class="fu">mean</span>(fang_xy<span class="sc">$</span>X), <span class="at">cex =</span> <span class="dv">2</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb192-6"><a href="#cb192-6"></a><span class="fu">points</span>(<span class="fu">sd</span>(fang_xy<span class="sc">$</span>Y), <span class="fu">mean</span>(fang_xy<span class="sc">$</span>Y), <span class="at">cex =</span> <span class="dv">2</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"blue"</span>)</span>
<span id="cb192-7"><a href="#cb192-7"></a><span class="fu">points</span>(sd_xy[<span class="dv">60</span>], ret_xy[<span class="dv">60</span>], <span class="at">cex =</span> <span class="dv">2</span>, <span class="at">pch =</span> <span class="dv">19</span>)</span>
<span id="cb192-8"><a href="#cb192-8"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>),</span>
<span id="cb192-9"><a href="#cb192-9"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-taefamvp" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-taefamvp-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.15: 2-assets, efficient frontier and minimum variance portfolio.</figcaption>
</figure>
</div>
</div>
</div>
<p>Which are the minimum variance portfolio weights?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1"></a>w_x[<span class="dv">60</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.59</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1"></a>w_y[<span class="dv">60</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.41</code></pre>
</div>
</div>
<p>Now, consider the <tt><code>FANG</code></tt> database plus these two <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> assets. Let’s generate the portfolio specification and optimize our portfolio as we did before.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1"></a><span class="co"># Create the portfolio specification</span></span>
<span id="cb197-2"><a href="#cb197-2"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">portfolio.spec</span>(<span class="fu">colnames</span>(fang_xy))</span>
<span id="cb197-3"><a href="#cb197-3"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">add.constraint</span>(<span class="at">portfolio =</span> </span>
<span id="cb197-4"><a href="#cb197-4"></a>                              port_spec, <span class="at">type =</span> <span class="st">"full_investment"</span>)</span>
<span id="cb197-5"><a href="#cb197-5"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">add.constraint</span>(<span class="at">portfolio =</span> port_spec, <span class="at">type =</span> <span class="st">"long_only"</span>)</span>
<span id="cb197-6"><a href="#cb197-6"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">add.objective</span>(<span class="at">portfolio =</span> port_spec,</span>
<span id="cb197-7"><a href="#cb197-7"></a>                           <span class="at">type =</span> <span class="st">"risk"</span>,</span>
<span id="cb197-8"><a href="#cb197-8"></a>                           <span class="at">name =</span> <span class="st">"StdDev"</span>)</span>
<span id="cb197-9"><a href="#cb197-9"></a>port_spec <span class="ot">&lt;-</span> <span class="fu">add.objective</span>(<span class="at">portfolio =</span> port_spec,</span>
<span id="cb197-10"><a href="#cb197-10"></a>                           <span class="at">type =</span> <span class="st">"return"</span>,</span>
<span id="cb197-11"><a href="#cb197-11"></a>                           <span class="at">name =</span> <span class="st">"mean"</span>)</span>
<span id="cb197-12"><a href="#cb197-12"></a><span class="co"># Optimization.</span></span>
<span id="cb197-13"><a href="#cb197-13"></a><span class="fu">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb197-14"><a href="#cb197-14"></a>opt_xy <span class="ot">&lt;-</span> <span class="fu">optimize.portfolio</span>(fang_xy, <span class="at">portfolio =</span> port_spec,</span>
<span id="cb197-15"><a href="#cb197-15"></a>                          <span class="at">optimize_method =</span> <span class="st">"random"</span>, <span class="at">trace =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We are done. Now, let’s visualize the results.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1"></a><span class="co"># Plot results.</span></span>
<span id="cb198-2"><a href="#cb198-2"></a><span class="fu">chart.RiskReward</span>(opt_xy, <span class="at">risk.col =</span> <span class="st">"StdDev"</span>, </span>
<span id="cb198-3"><a href="#cb198-3"></a>                 <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb198-4"><a href="#cb198-4"></a>                 <span class="at">return.col =</span> <span class="st">"mean"</span>, <span class="at">chart.assets =</span> <span class="cn">TRUE</span>)</span>
<span id="cb198-5"><a href="#cb198-5"></a><span class="fu">points</span>(<span class="fl">0.05807126</span>, <span class="fl">0.02606294</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">1.5</span>, <span class="at">col =</span> <span class="st">"black"</span>)</span>
<span id="cb198-6"><a href="#cb198-6"></a><span class="fu">points</span>(<span class="fl">0.1170653</span>,<span class="fl">0.04960399</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">1.5</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb198-7"><a href="#cb198-7"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"opt_xy (FANG+X+Y)"</span>, </span>
<span id="cb198-8"><a href="#cb198-8"></a>       <span class="st">"opt_rand (FANG)"</span>, <span class="st">"opt_roi (FANG)"</span>, <span class="st">"opt_naive (FANG)"</span>),</span>
<span id="cb198-9"><a href="#cb198-9"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"black"</span>, <span class="st">"red"</span>, <span class="st">"orange"</span>), <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-fpxayrp" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-fpxayrp-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.16: FANG plus X and Y, random portfolio.</figcaption>
</figure>
</div>
</div>
</div>
<p>This looks great as the new assets contribute to the optimization process to deliver a less risky portfolio. Now, the optimal portfolio has almost the same return as Facebook but with a significant reduced risk. Then, correlation value plays a determinant role in the diversification process. This is why investors are looking for low, or even better, negatively correlated assets.</p>
<p>Let’s see the details of the new portfolio.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1"></a><span class="co"># Extract weight, risk and return.</span></span>
<span id="cb199-2"><a href="#cb199-2"></a><span class="fu">extractWeights</span>(opt_xy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   FB  AMZN  NFLX  GOOG     X     Y 
0.002 0.028 0.000 0.014 0.522 0.434 </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1"></a>opt_xy_mean <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">extractObjectiveMeasures</span>(opt_xy)<span class="sc">$</span>mean)</span>
<span id="cb201-2"><a href="#cb201-2"></a>opt_xy_sd <span class="ot">&lt;-</span> </span>
<span id="cb201-3"><a href="#cb201-3"></a>  <span class="fu">as.numeric</span>(<span class="fu">extractObjectiveMeasures</span>(opt_xy)<span class="sc">$</span>StdDev)</span>
<span id="cb201-4"><a href="#cb201-4"></a>opt_xy_sr <span class="ot">&lt;-</span> opt_xy_mean<span class="sc">/</span>opt_xy_sd</span>
<span id="cb201-5"><a href="#cb201-5"></a></span>
<span id="cb201-6"><a href="#cb201-6"></a>opt_xy_summary <span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">mean =</span> opt_xy_mean, </span>
<span id="cb201-7"><a href="#cb201-7"></a>                              <span class="at">sd =</span> opt_xy_sd, <span class="at">sr =</span> opt_xy_sr)</span>
<span id="cb201-8"><a href="#cb201-8"></a><span class="fu">row.names</span>(opt_xy_summary) <span class="ot">&lt;-</span> <span class="st">"opt_xy"</span></span>
<span id="cb201-9"><a href="#cb201-9"></a></span>
<span id="cb201-10"><a href="#cb201-10"></a>FANG_stats <span class="sc">|&gt;</span></span>
<span id="cb201-11"><a href="#cb201-11"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_rand"</span>, opt_rand_summary) <span class="sc">|&gt;</span></span>
<span id="cb201-12"><a href="#cb201-12"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_roi"</span>, opt_roi_summary) <span class="sc">|&gt;</span></span>
<span id="cb201-13"><a href="#cb201-13"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_naive"</span>, opt_naive_summary) <span class="sc">|&gt;</span></span>
<span id="cb201-14"><a href="#cb201-14"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_roi2"</span>, opt_roi2_summary) <span class="sc">|&gt;</span></span>
<span id="cb201-15"><a href="#cb201-15"></a>  <span class="fu">add_row</span>(<span class="at">symbol =</span> <span class="st">"opt_xy"</span>, opt_xy_summary) <span class="sc">|&gt;</span></span>
<span id="cb201-16"><a href="#cb201-16"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>sr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 4
  symbol      mean     sd    sr
  &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 opt_xy    0.0332 0.0123 2.70 
2 opt_roi2  0.0347 0.0716 0.485
3 opt_naive 0.0341 0.0718 0.476
4 opt_rand  0.0265 0.0581 0.456
5 opt_roi   0.0500 0.118  0.424
6 NFLX      0.0592 0.167  0.355
7 FB        0.0341 0.0989 0.345
8 AMZN      0.0257 0.0817 0.314
9 GOOG      0.0176 0.0594 0.296</code></pre>
</div>
</div>
<p>Note that the portfolio assigns high weights to <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> with values of 52.2% and 43.4%. The rest is 0.2% in FB, 2.8% in AMZN, 0% in NFLX, and 1.4% in GOOG.</p>
<p>The <tt><code>opt_xy</code></tt> shows an impressive improvement. Informed investors are not looking for high return assets to invest in. Specially not in the context of portfolio investment. High return assets are associated with high risk so it is likely not to get the promised, or expected, return. Let me put a silly example. You buy a lottery ticket for 2 USD and you expect to win 1,000,000 USD, however the odds to win are 1 in 12,607,306. A 999,998 USD return looks quite nice but you will hardly get it. This is why we argue that we do not pick an asset with respect to its price, nor with respect to its return, but with respect to its return per unit of risk. In the context of asset allocation, this is partially why informed investors are not looking for high return assets to invest in, although this sounds like the popular thought. Investors can do better by selecting low correlated assets because this will allow them to form a well diversified portfolio with a more certain return at <span class="math inline">\(t=0\)</span>. In sum, contrary to popular wisdom, we can argue that in many circumstances we are more interested in risk rather than in return. In fact, this topic is called <em>risk management</em>, not <em>return management</em>.</p>
<p>If you are not quite happy with the 2.645942% monthly return of <tt><code>opt_rand</code></tt> portfolio, you always have the <tt><code>opt_roi</code></tt> which is 4.999645% and still with a decent return per unit of risk. If this is still not good for you, then you should look to add an asset low or negatively correlated with your existing assets and conduct your optimization again. A good way to start looking at negative correlated assets is by looking at different and distant industries, or assets that belong to distant markets. This would at least improve the chances to find stocks with different responses to risk factors and this is a good way to start your search.</p>
</section>
<section id="rebalancing-portfolio-and-evaluation." class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="rebalancing-portfolio-and-evaluation."><span class="header-section-number">4.3</span> Rebalancing portfolio and evaluation.</h2>
<p>In the previous section we calculate portfolio weights once. We changed the optimization criteria and we added new assets, but we only calculate the portfolio weights once. Rebalancing is something very common in finance, it means to calculate portfolio weights as time passes. This makes sense because as time passes we have access to new information (stock returns) and we should re-balance our portfolio in order to take into account this new information. Evaluation is also a very common task in finance. We are interested to know what is the annualized return of an investment strategy in a period of time. In this section we are going to extend the asset allocation problem to incorporate rebalancing portfolio and evaluation. We are going to use a different database to illustrate our results.</p>
<p>Consider the following investment process. At <span class="math inline">\(t=0\)</span> I have access to 60 months historical information of a set of individual assets. Then, I can take information from <span class="math inline">\(t=-60\)</span> to <span class="math inline">\(t=0\)</span> to estimate optimal portfolio weights to form my portfolio at <span class="math inline">\(t=0\)</span>. At <span class="math inline">\(t=0\)</span>, <span class="math inline">\(t=1\)</span>, and <span class="math inline">\(t=2\)</span> I simply get my returns or losses depending on the evolution of the market. Then, at <span class="math inline">\(t=3\)</span> I calculate new portfolio weights with information from <span class="math inline">\(t=-57\)</span> to <span class="math inline">\(t=3\)</span>. At <span class="math inline">\(t=3\)</span>, <span class="math inline">\(t=4\)</span>, and <span class="math inline">\(t=5\)</span> I simply get my returns or losses depending on the evolution of the market. Then, at <span class="math inline">\(t=6\)</span> I calculate new portfolio weights with information from <span class="math inline">\(t=-54\)</span> to <span class="math inline">\(t=6\)</span>. And I continue with the same procedure for several years. What would be my annualized return, and my annualized return per unit of risk? How could I know whether my investment procedure is better than other alternatives?</p>
<p>Before answering these questions, it is convenient to think in the process above. This looks like a lot of work. Everything starts with getting the price data for the correspondent assets. Then, convert the prices to returns. Then, calculate an optimal portfolio and implement the investment recommendation. Wait for the returns, and then re-balance our portfolio and implement the investment recommendation. Wait for the returns, and do the same until the end of the investment period which could last years. After that, look back to the portfolio returns and calculate an annualized return to evaluate my investment. This process is painful without a computer and without access to a computer language like R. In a computer we can automate this process and spend our time in more strategic tasks. Automatization is very common in other industries. Have you seen how cars are manufactured nowadays? You can hardly see a human operator, most of the process is made by robots. In finance, we can design robots since our main input is free data. Also, most of our main technology is free (R), the most expensive input is human capital.</p>
<p>Let’s start with the data to tackle our objectives.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1"></a><span class="co"># Get the data.</span></span>
<span id="cb203-2"><a href="#cb203-2"></a><span class="fu">data</span>(indexes)</span>
<span id="cb203-3"><a href="#cb203-3"></a>returns <span class="ot">&lt;-</span> indexes[, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb203-4"><a href="#cb203-4"></a><span class="fu">tail</span>(returns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           US Bonds US Equities Int'l Equities Commodities
2009-07-31   0.0132      0.0703         0.0838      0.0044
2009-08-31   0.0108      0.0348         0.0517     -0.0242
2009-09-30   0.0108      0.0360         0.0371      0.0017
2009-10-31   0.0042     -0.0189        -0.0126      0.0555
2009-11-30   0.0134      0.0566         0.0199      0.0150
2009-12-31  -0.0175      0.0189         0.0143      0.0086</code></pre>
</div>
</div>
<p>The database goes from 1980-01-31 to 2009-12-31. The set of assets are: US Bonds, US Equities, Int’l Equities and Commodities. This means that the first investment recommendation is calculated with information from 1980-01-31 to 1985-01-31 (60 monthly observations), the second from 1980-05-31 to 1985-09-31, and so on until the last period that goes from 2009-09-31 to 2009-12-31. The first monthly return will be the one on 1985-01-31 and the last on 2009-12-31, these are 300 monthly portfolio returns.</p>
<p>Before calculating optimal portfolios, let’s calculate a benchmark portfolio. This will allow us to compare our optimal portfolio with a benchmark. In this case the benchmark is simply an equally weighted portfolio, investing 25% in each asset for all the periods. This equally weighted portfolio implies that we will not conduct any optimization. It is like investing 25% in each asset (or index in this case) and doing nothing until the end of the investment period.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1"></a><span class="co"># Equal weight benchmark.</span></span>
<span id="cb205-2"><a href="#cb205-2"></a>n <span class="ot">&lt;-</span> <span class="fu">ncol</span>(returns)</span>
<span id="cb205-3"><a href="#cb205-3"></a>equal_weights <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> n, n)</span>
<span id="cb205-4"><a href="#cb205-4"></a>benchmark_returns <span class="ot">&lt;-</span> <span class="fu">Return.portfolio</span>(<span class="at">R =</span> returns, </span>
<span id="cb205-5"><a href="#cb205-5"></a>                                      <span class="at">weights =</span> equal_weights,</span>
<span id="cb205-6"><a href="#cb205-6"></a>                                      <span class="at">rebalance_on =</span> <span class="st">"quarters"</span>)</span>
<span id="cb205-7"><a href="#cb205-7"></a><span class="fu">colnames</span>(benchmark_returns) <span class="ot">&lt;-</span> <span class="st">"benchmark"</span></span>
<span id="cb205-8"><a href="#cb205-8"></a><span class="co"># Benchmark performance.</span></span>
<span id="cb205-9"><a href="#cb205-9"></a><span class="fu">table.AnnualizedReturns</span>(benchmark_returns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                          benchmark
Annualized Return            0.0769
Annualized Std Dev           0.1029
Annualized Sharpe (Rf=0%)    0.7476</code></pre>
</div>
</div>
<p>We are interested in a benchmark because it would facilitate our evaluation task.</p>
<p>Now we define the portfolio specification as we did in the section before.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1"></a><span class="co"># Base portfolio specification.</span></span>
<span id="cb207-2"><a href="#cb207-2"></a>base_port_spec <span class="ot">&lt;-</span> <span class="fu">portfolio.spec</span>(<span class="at">assets =</span> <span class="fu">colnames</span>(returns))</span>
<span id="cb207-3"><a href="#cb207-3"></a><span class="co">#base_port_spec &lt;- add.constraint(portfolio = base_port_spec,</span></span>
<span id="cb207-4"><a href="#cb207-4"></a><span class="co">#                                 type = "full_investment")</span></span>
<span id="cb207-5"><a href="#cb207-5"></a><span class="co">#base_port_spec &lt;- add.constraint(portfolio = base_port_spec,</span></span>
<span id="cb207-6"><a href="#cb207-6"></a><span class="co">#                                 type = "long_only")</span></span>
<span id="cb207-7"><a href="#cb207-7"></a>base_port_spec <span class="ot">&lt;-</span> <span class="fu">add.constraint</span>(<span class="at">portfolio =</span> base_port_spec, </span>
<span id="cb207-8"><a href="#cb207-8"></a>                                 <span class="at">type =</span> <span class="st">"weight_sum"</span>, </span>
<span id="cb207-9"><a href="#cb207-9"></a>                                 <span class="at">min_sum =</span> <span class="fl">0.99</span>, <span class="at">max_sum =</span> <span class="fl">1.01</span>)</span>
<span id="cb207-10"><a href="#cb207-10"></a>base_port_spec <span class="ot">&lt;-</span> <span class="fu">add.constraint</span>(<span class="at">portfolio =</span> base_port_spec, </span>
<span id="cb207-11"><a href="#cb207-11"></a>                                 <span class="at">type =</span> <span class="st">"box"</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb207-12"><a href="#cb207-12"></a>base_port_spec <span class="ot">&lt;-</span> <span class="fu">add.objective</span>(<span class="at">portfolio =</span> base_port_spec, </span>
<span id="cb207-13"><a href="#cb207-13"></a>                                <span class="at">type =</span> <span class="st">"risk"</span>, <span class="at">name =</span> <span class="st">"StdDev"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We are ready to implement the investment process described before.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1"></a><span class="co"># Run the optimization with periodic rebalancing.</span></span>
<span id="cb208-2"><a href="#cb208-2"></a>opt_base <span class="ot">&lt;-</span> <span class="fu">optimize.portfolio.rebalancing</span>(<span class="at">R =</span> returns, </span>
<span id="cb208-3"><a href="#cb208-3"></a>            <span class="at">optimize_method =</span> <span class="st">"ROI"</span>, <span class="at">portfolio =</span> base_port_spec,</span>
<span id="cb208-4"><a href="#cb208-4"></a>            <span class="at">rebalance_on =</span> <span class="st">"quarters"</span>, <span class="at">training_period =</span> <span class="dv">60</span>, </span>
<span id="cb208-5"><a href="#cb208-5"></a>            <span class="at">rolling_window =</span> <span class="dv">60</span>)</span>
<span id="cb208-6"><a href="#cb208-6"></a><span class="co"># Calculate portfolio returns.</span></span>
<span id="cb208-7"><a href="#cb208-7"></a>base_returns <span class="ot">&lt;-</span> <span class="fu">Return.portfolio</span>(returns, <span class="fu">extractWeights</span>(opt_base))</span>
<span id="cb208-8"><a href="#cb208-8"></a><span class="fu">colnames</span>(base_returns) <span class="ot">&lt;-</span> <span class="st">"base"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We are done. Rebalancing and evaluation are done. Now, let’s show the results.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1"></a><span class="co"># Chart the optimal weights.</span></span>
<span id="cb209-2"><a href="#cb209-2"></a><span class="fu">chart.Weights</span>(opt_base)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-iow" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-iow-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.17: Indexes, optimal weights.</figcaption>
</figure>
</div>
</div>
</div>
<p>This is how re-balancing looks like. It is the contribution of each asset in my portfolio. Clearly US bonds dominate my portfolio but this is what the optimization recommends. Now, let’s see the annualized performance of this portfolio.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1"></a><span class="co"># Merge benchmark and portfolio returns.</span></span>
<span id="cb210-2"><a href="#cb210-2"></a>ret <span class="ot">&lt;-</span> <span class="fu">cbind</span>(benchmark_returns, base_returns)</span>
<span id="cb210-3"><a href="#cb210-3"></a><span class="co"># Annualized performance.</span></span>
<span id="cb210-4"><a href="#cb210-4"></a><span class="fu">table.AnnualizedReturns</span>(ret)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                          benchmark   base
Annualized Return            0.0769 0.0765
Annualized Std Dev           0.1029 0.0432
Annualized Sharpe (Rf=0%)    0.7476 1.7710</code></pre>
</div>
</div>
<p>We did better than our benchmark portfolio, that is good.</p>
<p>Something that happens frequently is that for some reasons we face constraints about how much money to invest in an individual asset. Let’s assume this is the case and that we are supposed not to invest more than 40% in US bonds. We can incorporate this constraint easily and reproduce the re-balancing chart and annualized returns.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1"></a><span class="co"># Make a copy of the portfolio specification.</span></span>
<span id="cb212-2"><a href="#cb212-2"></a>box_port_spec <span class="ot">&lt;-</span> base_port_spec</span>
<span id="cb212-3"><a href="#cb212-3"></a><span class="co"># Update the constraint.</span></span>
<span id="cb212-4"><a href="#cb212-4"></a>box_port_spec <span class="ot">&lt;-</span> <span class="fu">add.constraint</span>(<span class="at">portfolio =</span> box_port_spec,</span>
<span id="cb212-5"><a href="#cb212-5"></a>                                <span class="at">type =</span> <span class="st">"box"</span>, <span class="at">min =</span> <span class="fl">0.05</span>, <span class="at">max =</span> <span class="fl">0.4</span>,</span>
<span id="cb212-6"><a href="#cb212-6"></a>                                <span class="at">indexnum =</span> <span class="dv">2</span>)</span>
<span id="cb212-7"><a href="#cb212-7"></a><span class="co"># Backtest.</span></span>
<span id="cb212-8"><a href="#cb212-8"></a>opt_box <span class="ot">&lt;-</span> <span class="fu">optimize.portfolio.rebalancing</span>(<span class="at">R =</span> returns, </span>
<span id="cb212-9"><a href="#cb212-9"></a>                                          <span class="at">optimize_method =</span> <span class="st">"ROI"</span>,</span>
<span id="cb212-10"><a href="#cb212-10"></a>                                          <span class="at">portfolio =</span> box_port_spec,</span>
<span id="cb212-11"><a href="#cb212-11"></a>                                          <span class="at">rebalance_on =</span> <span class="st">"quarters"</span>,</span>
<span id="cb212-12"><a href="#cb212-12"></a>                                          <span class="at">training_period =</span> <span class="dv">60</span>,</span>
<span id="cb212-13"><a href="#cb212-13"></a>                                          <span class="at">rolling_window =</span> <span class="dv">60</span>)</span>
<span id="cb212-14"><a href="#cb212-14"></a><span class="co"># Calculate portfolio returns.</span></span>
<span id="cb212-15"><a href="#cb212-15"></a>box_returns <span class="ot">&lt;-</span> <span class="fu">Return.portfolio</span>(returns, <span class="fu">extractWeights</span>(opt_box))</span>
<span id="cb212-16"><a href="#cb212-16"></a><span class="fu">colnames</span>(box_returns) <span class="ot">&lt;-</span> <span class="st">"box"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In principle, more constraints will lead to a worse solution. The optimization algorithm works better as long as it can freely choose portfolio weights.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1"></a><span class="co"># Chart the optimal weights.</span></span>
<span id="cb213-2"><a href="#cb213-2"></a><span class="fu">chart.Weights</span>(opt_box)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-239-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Indexes, optimal weights with box constraint.</figcaption>
</figure>
</div>
</div>
</div>
<p>Now, the rest of the assets have a more significant role in our portfolio.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1"></a><span class="co"># Merge box portfolio returns.</span></span>
<span id="cb214-2"><a href="#cb214-2"></a>ret <span class="ot">&lt;-</span> <span class="fu">cbind</span>(ret, box_returns)</span>
<span id="cb214-3"><a href="#cb214-3"></a><span class="co"># Annualized performance.</span></span>
<span id="cb214-4"><a href="#cb214-4"></a><span class="fu">table.AnnualizedReturns</span>(ret)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                          benchmark   base    box
Annualized Return            0.0769 0.0765 0.0753
Annualized Std Dev           0.1029 0.0432 0.0806
Annualized Sharpe (Rf=0%)    0.7476 1.7710 0.9344</code></pre>
</div>
</div>
<p>As expected, more constraints negatively impact the possibilities to get a higher annualized return.</p>
<p>Most of these activities including providing investment recommendations in a regular manner are services offered by private firms. People looking to invest part of their money are supposed to receive assistance and guidance and many times it is in the form of an investment recommendation like the ones we calculate here. In the past, these services were provided only by those firms with access to the knowledge, capital, experience, and technology. Nowadays, there are an increasing number of fintechs that provide financial services because now we have access to powerful software and improved computational capabilities. In any case, functions like <tt><code>optimize.portfolio()</code></tt> are expected to be used as a tool by professionals and not as a pure source of investment recommendation.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1"></a><span class="fu">charts.PerformanceSummary</span>(<span class="at">R =</span> ret)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ipp" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="index_files/figure-html/fig-ipp-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.18: Indexes, portfolio performance.</figcaption>
</figure>
</div>
</div>
</div>
<p>#</p>
<p>#<code>{r DatavizMultilevel, child = 'multilevel.Rmd'} #</code></p>
</section>
</section>
<section id="blockchain." class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Blockchain.</h1>
<p>Here, we develop an example originally taken from Massimo Franceschet.</p>
<ul>
<li><a href="https://youtu.be/J-ab9was1p0">Blockchain Explanation</a></li>
<li><a href="https://youtu.be/SSo_EIwHSd4">How does a blockchain work - Simply Explained</a></li>
<li><a href="https://youtu.be/AQDCe585Lnc">Asymmetric Encryption - Simply explained</a></li>
<li><a href="https://youtu.be/XCo6yyutYAM">What is a Bitcoin hard fork? Simply Explained!</a></li>
<li><a href="https://youtu.be/M3EFi_POhps">Proof-of-Stake (vs proof-of-work)</a></li>
<li><a href="https://youtu.be/5I3wYAwbKMM">Will GDPR kill blockchains?</a></li>
<li><a href="https://youtu.be/OcmvMs4AMbM">Zero Knowledge Proof - ZKP</a></li>
</ul>
<p>A blockchain is a distributed system using cryptography to secure an evolving consensus about an economically valuable token. Cryptography is a method of protecting information and communications through the use of codes, so that only those for whom the information is intended can read and process it. The prefix <em>crypt-</em> means hidden or vault, and the suffix <em>-graphy</em> stands for writing.</p>
<section id="block." class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="block."><span class="header-section-number">5.1</span> Block.</h2>
<p>A blockchain is a chain of blocks. Hence, we first describe a block. A block is a container for data. In its simplest form it contains:</p>
<ul>
<li>An identification number, <tt><code>number</code></tt>.</li>
<li>A timestamp of block creation <tt><code>timestamp</code></tt>.</li>
<li>A bunch of data, <tt><code>data</code></tt>.</li>
<li>A reference to the previous block (parent block) in the chain, <tt><code>parent</code></tt>.</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1"></a>block <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">number =</span> <span class="dv">3</span>, </span>
<span id="cb217-2"><a href="#cb217-2"></a>             <span class="at">timestamp =</span> <span class="st">"2018-10-01 17:24:18 CEST"</span>, </span>
<span id="cb217-3"><a href="#cb217-3"></a>             <span class="at">data =</span> <span class="st">"London"</span>, </span>
<span id="cb217-4"><a href="#cb217-4"></a>             <span class="at">parent =</span> <span class="dv">2</span>) </span>
<span id="cb217-5"><a href="#cb217-5"></a></span>
<span id="cb217-6"><a href="#cb217-6"></a>block</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$number
[1] 3

$timestamp
[1] "2018-10-01 17:24:18 CEST"

$data
[1] "London"

$parent
[1] 2</code></pre>
</div>
</div>
<p>This was a single unchained block. Now, let’s introduce the concept of chain.</p>
</section>
<section id="chain." class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="chain."><span class="header-section-number">5.2</span> Chain.</h2>
<p>Blocks are concatenated into a chain. The first block of the chain is called the <em>genesis block</em> and has no parent block. The last block of a chain is the <em>current block</em> and is not parent of any other block (yet).</p>
<p>Here is the genesis block of the Ethereum blockchain: https://etherscan.io/block/0</p>
<p>Let’s chain some blocks.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1"></a><span class="co"># Some blocks.</span></span>
<span id="cb219-2"><a href="#cb219-2"></a>block1 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">number =</span> <span class="dv">1</span>,</span>
<span id="cb219-3"><a href="#cb219-3"></a>             <span class="at">timestamp =</span> <span class="st">"2018-10-01 17:24:00 CEST"</span>,</span>
<span id="cb219-4"><a href="#cb219-4"></a>             <span class="at">data =</span> <span class="st">"London"</span>,</span>
<span id="cb219-5"><a href="#cb219-5"></a>             <span class="at">parent =</span> <span class="cn">NA</span>)</span>
<span id="cb219-6"><a href="#cb219-6"></a></span>
<span id="cb219-7"><a href="#cb219-7"></a>block2 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">number =</span> <span class="dv">2</span>,</span>
<span id="cb219-8"><a href="#cb219-8"></a>             <span class="at">timestamp =</span> <span class="st">"2018-10-01 17:24:15 CEST"</span>,</span>
<span id="cb219-9"><a href="#cb219-9"></a>             <span class="at">data =</span> <span class="st">"Paris"</span>,</span>
<span id="cb219-10"><a href="#cb219-10"></a>             <span class="at">parent =</span> <span class="dv">1</span>) <span class="co"># We chain the block with respect to the last one.</span></span>
<span id="cb219-11"><a href="#cb219-11"></a></span>
<span id="cb219-12"><a href="#cb219-12"></a>block3 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">number =</span> <span class="dv">3</span>,</span>
<span id="cb219-13"><a href="#cb219-13"></a>             <span class="at">timestamp =</span> <span class="st">"2018-10-01 17:24:30 CEST"</span>,</span>
<span id="cb219-14"><a href="#cb219-14"></a>             <span class="at">data =</span> <span class="st">"Rome"</span>,</span>
<span id="cb219-15"><a href="#cb219-15"></a>             <span class="at">parent =</span> <span class="dv">2</span>) <span class="co"># We chain the block with respect to the last one.</span></span>
<span id="cb219-16"><a href="#cb219-16"></a></span>
<span id="cb219-17"><a href="#cb219-17"></a><span class="co"># The blockchain:</span></span>
<span id="cb219-18"><a href="#cb219-18"></a>blockchain <span class="ot">&lt;-</span> <span class="fu">list</span>(block1, block2, block3)</span>
<span id="cb219-19"><a href="#cb219-19"></a>blockchain</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]]$number
[1] 1

[[1]]$timestamp
[1] "2018-10-01 17:24:00 CEST"

[[1]]$data
[1] "London"

[[1]]$parent
[1] NA


[[2]]
[[2]]$number
[1] 2

[[2]]$timestamp
[1] "2018-10-01 17:24:15 CEST"

[[2]]$data
[1] "Paris"

[[2]]$parent
[1] 1


[[3]]
[[3]]$number
[1] 3

[[3]]$timestamp
[1] "2018-10-01 17:24:30 CEST"

[[3]]$data
[1] "Rome"

[[3]]$parent
[1] 2</code></pre>
</div>
</div>
<p>This is how we can get one block from the blockchain.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb221-1"><a href="#cb221-1"></a><span class="co"># Get the 2nd block.</span></span>
<span id="cb221-2"><a href="#cb221-2"></a>blockchain[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$number
[1] 2

$timestamp
[1] "2018-10-01 17:24:15 CEST"

$data
[1] "Paris"

$parent
[1] 1</code></pre>
</div>
</div>
<p>Let’s also write a validation function for the blockchain. For now, we only check that the parent field of a non-genesis block references to the previous block in the chain. Therefore, we validate a blockchain as long as its sequence is correct. That is not a very secure system but it works for now. For example, first the genesis, then the first one, then the second, and finally the third.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb223-1"><a href="#cb223-1"></a><span class="co"># Returns false if the blockchain sequence is not correct. </span></span>
<span id="cb223-2"><a href="#cb223-2"></a>validate <span class="ot">&lt;-</span> <span class="cf">function</span>(blockchain) {</span>
<span id="cb223-3"><a href="#cb223-3"></a>  <span class="cf">if</span> (<span class="fu">length</span>(blockchain) <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb223-4"><a href="#cb223-4"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(blockchain)) { <span class="co"># We skip the genesis block.</span></span>
<span id="cb223-5"><a href="#cb223-5"></a>      <span class="cf">if</span> (blockchain[[i]]<span class="sc">$</span>parent <span class="sc">!=</span> blockchain[[i<span class="dv">-1</span>]]<span class="sc">$</span>number) {</span>
<span id="cb223-6"><a href="#cb223-6"></a>        <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb223-7"><a href="#cb223-7"></a>      }</span>
<span id="cb223-8"><a href="#cb223-8"></a>    }</span>
<span id="cb223-9"><a href="#cb223-9"></a>  }</span>
<span id="cb223-10"><a href="#cb223-10"></a>  <span class="fu">return</span>(<span class="cn">TRUE</span>)</span>
<span id="cb223-11"><a href="#cb223-11"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1"></a><span class="fu">validate</span>(blockchain)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Our blockchain is valid. At the moment the validation criterion is quite simple. The next subsection introduces a more strict validation criterion.</p>
</section>
<section id="hash." class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="hash."><span class="header-section-number">5.3</span> Hash.</h2>
<p>The linking structure of the chain is more complex than one described above: each block in a blockchain is identified by a hash value of its content and references to the hash of the parent block, or 0 if the block is the genesis one.</p>
<p>Hashes of blocks are created using cryptographic hash functions, that are mathematical algorithms that maps data of arbitrary size to a bit string of a fixed size (called hash or digest). The hash is used to certify the information content of the block: by modifying even a single bit of the content, the hash completely changes. Furthermore, notice that the digest of the current block is computed in terms of the previous block digest. This means if you alter one block you need to modify not only the hash of it but that of all following block for the chain to be valid.</p>
<p>As a result, a hash function for three blocks looks like this: <span class="math inline">\(hash_3 = f_3(f_2(f_1(block_1), block_2), block_3)\)</span>.</p>
<p>The hash algorithm used here (SHA-256) is part of SHA-2 (Secure Hash Algorithm 2), a set of cryptographic hash functions designed by the United States National Security Agency (NSA). In particular, it uses digests of 256 bits (or 32 hexadecimal figures). See for example:</p>
<p>https://emn178.github.io/online-tools/sha256.html</p>
<p>It is implemented in R package <tt><code>digest</code></tt>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1"></a><span class="co"># Creates hash digests of arbitrary R objects.</span></span>
<span id="cb226-2"><a href="#cb226-2"></a><span class="fu">library</span>(digest)</span>
<span id="cb226-3"><a href="#cb226-3"></a></span>
<span id="cb226-4"><a href="#cb226-4"></a><span class="co"># Hash a string.</span></span>
<span id="cb226-5"><a href="#cb226-5"></a><span class="fu">digest</span>(<span class="st">"A blockchain is a chain of blocks"</span>, <span class="st">"sha256"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "5c2005976411a1628fabcdde3ac04be563d18943e710b7446afa2a8a5fab9abc"</code></pre>
</div>
</div>
<p>The hash 256 has a length of 64 characters.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1"></a><span class="fu">nchar</span>(<span class="st">"A blockchain is a chain of blocks"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 33</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1"></a><span class="fu">nchar</span>(<span class="st">"5c2005976411a1628fabcdde3ac04be563d18943e710b7446afa2a8a5fab9abc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 64</code></pre>
</div>
</div>
<p>Let’s implement the hash in the blockchain construction.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1"></a><span class="co"># Hash blocks.</span></span>
<span id="cb232-2"><a href="#cb232-2"></a>block1 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">number =</span> <span class="dv">1</span>,</span>
<span id="cb232-3"><a href="#cb232-3"></a>             <span class="at">timestamp =</span> <span class="st">"2018-10-01 17:24:00 CEST"</span>,</span>
<span id="cb232-4"><a href="#cb232-4"></a>             <span class="at">data =</span> <span class="st">"London"</span>,</span>
<span id="cb232-5"><a href="#cb232-5"></a>             <span class="at">parent_hash =</span> <span class="st">"0"</span>)</span>
<span id="cb232-6"><a href="#cb232-6"></a><span class="co"># Note that the whole block1 content is used to generate the hash.</span></span>
<span id="cb232-7"><a href="#cb232-7"></a>block1<span class="sc">$</span>hash <span class="ot">=</span> <span class="fu">digest</span>(block1, <span class="st">"sha256"</span>)</span>
<span id="cb232-8"><a href="#cb232-8"></a><span class="co"># The new block2 has block1 hash as the parent hash.</span></span>
<span id="cb232-9"><a href="#cb232-9"></a>block2 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">number =</span> <span class="dv">2</span>,</span>
<span id="cb232-10"><a href="#cb232-10"></a>             <span class="at">timestamp =</span> <span class="st">"2018-10-01 17:24:15 CEST"</span>,</span>
<span id="cb232-11"><a href="#cb232-11"></a>             <span class="at">data =</span> <span class="st">"Paris"</span>,</span>
<span id="cb232-12"><a href="#cb232-12"></a>             <span class="at">parent_hash =</span> block1<span class="sc">$</span>hash)</span>
<span id="cb232-13"><a href="#cb232-13"></a><span class="co"># Note that the block 2 hash has block1 hash.</span></span>
<span id="cb232-14"><a href="#cb232-14"></a>block2<span class="sc">$</span>hash <span class="ot">=</span> <span class="fu">digest</span>(block2, <span class="st">"sha256"</span>)</span>
<span id="cb232-15"><a href="#cb232-15"></a><span class="co"># The new block3 has block2 hash as the parent hash.</span></span>
<span id="cb232-16"><a href="#cb232-16"></a>block3 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">number =</span> <span class="dv">3</span>,</span>
<span id="cb232-17"><a href="#cb232-17"></a>             <span class="at">timestamp =</span> <span class="st">"2018-10-01 17:24:30 CEST"</span>,</span>
<span id="cb232-18"><a href="#cb232-18"></a>             <span class="at">data =</span> <span class="st">"Rome"</span>,</span>
<span id="cb232-19"><a href="#cb232-19"></a>             <span class="at">parent_hash =</span> block2<span class="sc">$</span>hash)</span>
<span id="cb232-20"><a href="#cb232-20"></a><span class="co"># Block 3 hash has block2 hash, which at the same time has block1 hash.</span></span>
<span id="cb232-21"><a href="#cb232-21"></a>block3<span class="sc">$</span>hash <span class="ot">=</span> <span class="fu">digest</span>(block3, <span class="st">"sha256"</span>)</span>
<span id="cb232-22"><a href="#cb232-22"></a><span class="co"># The blockchain.</span></span>
<span id="cb232-23"><a href="#cb232-23"></a>blockchain <span class="ot">&lt;-</span> <span class="fu">list</span>(block1, block2, block3)</span>
<span id="cb232-24"><a href="#cb232-24"></a>blockchain</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]]$number
[1] 1

[[1]]$timestamp
[1] "2018-10-01 17:24:00 CEST"

[[1]]$data
[1] "London"

[[1]]$parent_hash
[1] "0"

[[1]]$hash
[1] "e4064e41f246cba04e0e7d58418294c4e099aefff48f7e871f65a77aebbe8243"


[[2]]
[[2]]$number
[1] 2

[[2]]$timestamp
[1] "2018-10-01 17:24:15 CEST"

[[2]]$data
[1] "Paris"

[[2]]$parent_hash
[1] "e4064e41f246cba04e0e7d58418294c4e099aefff48f7e871f65a77aebbe8243"

[[2]]$hash
[1] "12dfcc49b856a2d2c6a941b9166ee14d276811e453f11a24f7bef8aa3247966d"


[[3]]
[[3]]$number
[1] 3

[[3]]$timestamp
[1] "2018-10-01 17:24:30 CEST"

[[3]]$data
[1] "Rome"

[[3]]$parent_hash
[1] "12dfcc49b856a2d2c6a941b9166ee14d276811e453f11a24f7bef8aa3247966d"

[[3]]$hash
[1] "22628b887626257faa3109dd7f786e88ea0d5ebe021a534afaef3ced3ad193d1"</code></pre>
</div>
</div>
<p>The hash of block 3 depends not only on the block 3 information, but also on the block 2 hash, which at the same time depends not only on the block 2 information, but also on the block 1 hash. The blocks are chained.</p>
<p>Let’s update the validation function. Now, we check that the parent field of a non-genesis block references to the correct hash of the following block.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1"></a>validate <span class="ot">&lt;-</span> <span class="cf">function</span>(blockchain) {</span>
<span id="cb234-2"><a href="#cb234-2"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(blockchain)) { <span class="co"># Check for the correct hash.</span></span>
<span id="cb234-3"><a href="#cb234-3"></a>    block <span class="ot">=</span> blockchain[[i]] <span class="co"># Evaluation starts.</span></span>
<span id="cb234-4"><a href="#cb234-4"></a>    hash <span class="ot">=</span> block<span class="sc">$</span>hash <span class="co"># Take the declared hash.</span></span>
<span id="cb234-5"><a href="#cb234-5"></a>    block<span class="sc">$</span>hash <span class="ot">=</span> <span class="cn">NULL</span> <span class="co"># Otherwise we cannot create the expected hash.</span></span>
<span id="cb234-6"><a href="#cb234-6"></a>    hash_expected <span class="ot">=</span> <span class="fu">digest</span>(block, <span class="st">"sha256"</span>) <span class="co"># Expected hash.</span></span>
<span id="cb234-7"><a href="#cb234-7"></a>    <span class="cf">if</span> (hash <span class="sc">!=</span> hash_expected) { <span class="co"># If true, then the blockchain is invalid.</span></span>
<span id="cb234-8"><a href="#cb234-8"></a>      <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb234-9"><a href="#cb234-9"></a>    }</span>
<span id="cb234-10"><a href="#cb234-10"></a>  }</span>
<span id="cb234-11"><a href="#cb234-11"></a>  <span class="cf">if</span> (<span class="fu">length</span>(blockchain) <span class="sc">&gt;=</span> <span class="dv">2</span>) { <span class="co"># Check for the consecutive hash.</span></span>
<span id="cb234-12"><a href="#cb234-12"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(blockchain)) {</span>
<span id="cb234-13"><a href="#cb234-13"></a>      <span class="cf">if</span> (blockchain[[i]]<span class="sc">$</span>parent_hash <span class="sc">!=</span> blockchain[[i<span class="dv">-1</span>]]<span class="sc">$</span>hash) {</span>
<span id="cb234-14"><a href="#cb234-14"></a>        <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb234-15"><a href="#cb234-15"></a>      }</span>
<span id="cb234-16"><a href="#cb234-16"></a>    }</span>
<span id="cb234-17"><a href="#cb234-17"></a>  }</span>
<span id="cb234-18"><a href="#cb234-18"></a>  <span class="fu">return</span>(<span class="cn">TRUE</span>)</span>
<span id="cb234-19"><a href="#cb234-19"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Test our blockchain again.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb235-1"><a href="#cb235-1"></a><span class="fu">validate</span>(blockchain)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Let’s test the validation algorithm. Here, we change London by Budapest and nothing else.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1"></a>blockchain[[<span class="dv">1</span>]]<span class="sc">$</span>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "London"</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1"></a><span class="co"># alter data of first block</span></span>
<span id="cb239-2"><a href="#cb239-2"></a>blockchain[[<span class="dv">1</span>]]<span class="sc">$</span>data <span class="ot">=</span> <span class="st">"Budapest"</span></span>
<span id="cb239-3"><a href="#cb239-3"></a><span class="fu">validate</span>(blockchain)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<p>It works. We cannot change one block bit of information because the blockchain become invalid. Let’s restore the original information.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1"></a><span class="co"># restore data</span></span>
<span id="cb241-2"><a href="#cb241-2"></a>blockchain[[<span class="dv">1</span>]]<span class="sc">$</span>data <span class="ot">=</span> <span class="st">"London"</span></span>
<span id="cb241-3"><a href="#cb241-3"></a><span class="fu">validate</span>(blockchain)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Another test of the validation algorithm. Now, we change London by Budapest and we update the corresponding hash in block 1.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1"></a><span class="co"># Alter data and hash of first block.</span></span>
<span id="cb243-2"><a href="#cb243-2"></a>blockchain[[<span class="dv">1</span>]]<span class="sc">$</span>data <span class="ot">=</span> <span class="st">"Budapest"</span></span>
<span id="cb243-3"><a href="#cb243-3"></a>blockchain[[<span class="dv">1</span>]]<span class="sc">$</span>hash <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb243-4"><a href="#cb243-4"></a>blockchain[[<span class="dv">1</span>]]<span class="sc">$</span>hash <span class="ot">=</span> <span class="fu">digest</span>(blockchain[[<span class="dv">1</span>]], <span class="st">"sha256"</span>)</span>
<span id="cb243-5"><a href="#cb243-5"></a></span>
<span id="cb243-6"><a href="#cb243-6"></a><span class="fu">validate</span>(blockchain)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<p>Works well. The hash of the second and third block would have to be altered as well, otherwise the blockchain is invalid. Remember the hash dependency looks like this: <span class="math inline">\(hash_3 = f_3(f_2(f_1(block_1), block_2), block_3)\)</span>.</p>
</section>
<section id="proof-of-work." class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="proof-of-work."><span class="header-section-number">5.4</span> Proof-of-Work.</h2>
<p>Hash alone is not enough to prevent tampering, since hash values can be computed fast by computers. A Proof-of-Work (PoW) algorithm controls the difficulty of creating a new block. For blockchains like BitCoin or Ethereum blocks are created (mined) by so-called <em>miners</em>. When a new block has to be created, a hard computational problem is sent out to the network. The miner which solves the problem first creates the new block and is rewarded in crypto currency.</p>
<p>In the case of BitCoin the PoW problem involves the problem of finding a number (called <em>nonce</em>) that once added to the block is such that the corresponding block hash contains a certain amount of leading zeros called difficulty (more specifically, Hashcash). The average work that a miner needs to perform in order to find a valid nonce is exponential in the difficulty, while one can verify the validity of the block by executing a single hash function.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1"></a>proof_of_work <span class="ot">&lt;-</span> <span class="cf">function</span>(block, difficulty, <span class="at">print =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb245-2"><a href="#cb245-2"></a>  block<span class="sc">$</span>nonce <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># Add a nonce=0 to the block as a starting point.</span></span>
<span id="cb245-3"><a href="#cb245-3"></a>  hash <span class="ot">=</span> <span class="fu">digest</span>(block, <span class="st">"sha256"</span>) <span class="co"># Generate the hash of the block.</span></span>
<span id="cb245-4"><a href="#cb245-4"></a>  zero <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">rep</span>(<span class="st">"0"</span>, difficulty), <span class="at">collapse =</span> <span class="st">""</span>) <span class="co"># Number of leading 0's.</span></span>
<span id="cb245-5"><a href="#cb245-5"></a>  <span class="cf">while</span>(<span class="fu">substr</span>(hash, <span class="dv">1</span>, difficulty) <span class="sc">!=</span> zero) { <span class="co"># Hash has not the leading 0's.</span></span>
<span id="cb245-6"><a href="#cb245-6"></a>      block<span class="sc">$</span>nonce <span class="ot">=</span> block<span class="sc">$</span>nonce <span class="sc">+</span> <span class="dv">1</span> <span class="co"># Add 1 to the nonce value.</span></span>
<span id="cb245-7"><a href="#cb245-7"></a>      hash <span class="ot">=</span> <span class="fu">digest</span>(block, <span class="st">"sha256"</span>)  <span class="co"># Generate the hash of the block.</span></span>
<span id="cb245-8"><a href="#cb245-8"></a>      <span class="cf">if</span>(print <span class="sc">==</span> <span class="cn">TRUE</span>) {<span class="fu">print</span>(hash)} <span class="co"># Print only if TRUE.</span></span>
<span id="cb245-9"><a href="#cb245-9"></a>  }</span>
<span id="cb245-10"><a href="#cb245-10"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">hash =</span> hash, <span class="at">nonce =</span> block<span class="sc">$</span>nonce))</span>
<span id="cb245-11"><a href="#cb245-11"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1"></a><span class="co"># This block will allow us to evaluate the function above.</span></span>
<span id="cb246-2"><a href="#cb246-2"></a>block <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">number =</span> <span class="dv">1</span>,</span>
<span id="cb246-3"><a href="#cb246-3"></a>             <span class="at">timestamp =</span> <span class="st">"2018-10-01 17:24:00 CEST"</span>,</span>
<span id="cb246-4"><a href="#cb246-4"></a>             <span class="at">data =</span> <span class="st">"London"</span>,</span>
<span id="cb246-5"><a href="#cb246-5"></a><span class="at">hash =</span> </span>
<span id="cb246-6"><a href="#cb246-6"></a>  <span class="st">"88e96d4537bea4d9c05d12549907b32561d3bf31f45aae734cdc119f13406cb6Parent"</span>,</span>
<span id="cb246-7"><a href="#cb246-7"></a>             <span class="at">parent_hash =</span> <span class="st">"d4e56740f876aef8c010b86a40d5f56745a118d0906a34e69aec8c0db1cb8fa3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>How difficult is difficulty 1?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb247-1"><a href="#cb247-1"></a><span class="co"># Evaluate a difficulty of 1 (one leading zero)</span></span>
<span id="cb247-2"><a href="#cb247-2"></a><span class="fu">proof_of_work</span>(block, <span class="dv">1</span>, <span class="at">print =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2ac786a13832b45ccf25466aec83ef714dae4562c9573511dedc10543568562c"
[1] "80d238e881cb74c5dd100adb12a7ba5d6c84ff1759320b1eda3fdc74eb205d52"
[1] "d51eeaf4dc82d6c52b452c9685c7fdf8d347c3612f7cb46c9e3fe1a6baff73a2"
[1] "495fbc7ec32f0edffc9af8344832f0a83ccf1f8ec4c650661620e38ddb5947ab"
[1] "a7d86c47ba718439066df81bffff60a41d3cd614ba31a93faed4c609a04b9c7e"
[1] "0a72347fbbe9ac46481b6499e3bcacd394f267d4c3d8a0544e00978fc124fe2f"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$hash
[1] "0a72347fbbe9ac46481b6499e3bcacd394f267d4c3d8a0544e00978fc124fe2f"

$nonce
[1] 6</code></pre>
</div>
</div>
<p>It takes 6 iterations to solve the problem of difficulty 1. Quite easy for a computer. How difficult is difficulty 2?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1"></a><span class="co"># Evaluate a difficulty of 2 (two leading zeros)</span></span>
<span id="cb250-2"><a href="#cb250-2"></a><span class="fu">proof_of_work</span>(block, <span class="dv">2</span>, <span class="at">print =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2ac786a13832b45ccf25466aec83ef714dae4562c9573511dedc10543568562c"
[1] "80d238e881cb74c5dd100adb12a7ba5d6c84ff1759320b1eda3fdc74eb205d52"
[1] "d51eeaf4dc82d6c52b452c9685c7fdf8d347c3612f7cb46c9e3fe1a6baff73a2"
[1] "495fbc7ec32f0edffc9af8344832f0a83ccf1f8ec4c650661620e38ddb5947ab"
[1] "a7d86c47ba718439066df81bffff60a41d3cd614ba31a93faed4c609a04b9c7e"
[1] "0a72347fbbe9ac46481b6499e3bcacd394f267d4c3d8a0544e00978fc124fe2f"
[1] "7d8d9144dd86cf70b24010534497970ae1e89ff7df03645d781ffbc4c5350988"
[1] "abb9814a9680c1ba7c970eb5f8965e01f074af7547243db9d94b0a44908d5b1a"
[1] "c61eebd36518426ac3510280eb698484856a2c9b93e1a534298cf11a3d7a62f9"
[1] "7fe608cd3784913fed93e01263e9d013a337adbd562ee76280e4775d24adeabd"
[1] "0e1344bc16dbbb1ee2ee2687a47925bcc82582e7fd90b281400ec9b467e81f68"
[1] "35979c8a93866a4ec7d8e1ca1a5c9a1746c60c18d80d885d2d66fe67c773fcc0"
[1] "3cd3f8a34fa46d01b4faedb6309a19b917fa133cede66d186ac4d5eb20685493"
[1] "3fcab70d4a7710a16fa23b6f63024159987b3b95fb62841e60dfb824aff22d7e"
[1] "89168037cbc585eed85f318b8063d48f350410052b47aa51a67e2a1a6a20870e"
[1] "c233234c2ff42b73c4c633d6bd54b197a33774da062e48d02b384efe64cff332"
[1] "75f98266dfa61fd5578f942f5140bbe58c6bbd285dab7375595b0ddaa29ce6ab"
[1] "955d82a9f0ca7d4eaeb51ff65551b0eb5c3416c89252f6530e286d28abb22d01"
[1] "5c5e31b26f1761d74e7409312d658be0053e5519ddfef914453a552e65832e4c"
[1] "6cb0f90002461d203f826aa63c2abe950da14d986395b6625c03d652f3bcc15c"
[1] "5b05120be9c2acaa937c6e8ed703d9c46c314e1bb8ec44cb8575716c7fbfc575"
[1] "1dc89bb3f3d3168e141a78d478ef0416b9db35db49ea29d83b39d4fd39fcf137"
[1] "11eb55ea6aa08526ea29fcbb7b2627571ce4a7ee64214f9a97bb7c11e41f65e6"
[1] "4ed393b7603b7dcaf2c39936d8261189ac5d3fddcdd26a9c8be93da87e4f3b8a"
[1] "1f0bb59cfc4dc2e50aa0721bc9cddc28eb1a31d64ec90c86a4579df6147342df"
[1] "3bbf029721533141094663e2b9b2bb9ec7d69b299c1e5945bacd77dd5c736138"
[1] "b4edd13b1f670ce9c0d66c17bb7bee6ddcb64a194f3d040d5df20b3a28c2b46e"
[1] "b5a553d535ad26d10b4e7e8cfcc27a35696a7ce75bb1a5f1dd4322c5039877f2"
[1] "186a2116c7fa43bb97c0573e6878b3260b57b1f854caa0412b0a45dc456f2ba2"
[1] "ec5eb69718fb8a01bf0da8fe5320571f3671e740a8c7bc799224b8da069d7748"
[1] "436460d156efc75f8c038c45544bbb14fc0261c3b83bdb576d36e145c759b285"
[1] "2081ced993d0faa150a8780cff8793a871b171b775903a3e5d844c6935c8fbc7"
[1] "332c6d6acf42dfef8b67a956367c4c318e56dca912b002ab51e62b495452eeb6"
[1] "5193a0f62d3c57e03817228efe8c624d19e22424d529c0ceee0dcef5615c1ee7"
[1] "6f0fc844d5c1ca51f9f64d2c34edd41fc12b3b5670cb9ae9b0f5dcb4214e90ee"
[1] "1e399483289deafbcd0e08b5475ce984838ef09362fea3c89df8e9cd708235ae"
[1] "49e12d2adde1c3e406a425552b676cd6b6c5006a91fb9ef02ece4f88f6dc150c"
[1] "8d6e35c790d3e5a8d4b1b262433d81de2628a227133a036aa758b45f16b712ff"
[1] "4a6aa4b71b76f38c063180c1506b2c0b96362f439fcb597fedf39d9bdb465ff1"
[1] "23d12c93c530f0d7642ab4e60d0d3ec4ed71429f75c8d9b43810058a3c795a80"
[1] "6e1912048fb80b8a6e7f4f8edde9ff79ade8b0f28c8e4f901294d4a8f7345586"
[1] "4533c74f4933d43730495774af13db8d0d7c917522e16fcd0f55062afce09be0"
[1] "82d16a1b0e2927216c8a241cb45fa0151cd40192b1c084e8e5b9a086f2a7c8cf"
[1] "0cd03a81725e5133e68a693d99a8763335eb13d65f2fa1e3a2b6a1e9badca154"
[1] "acf65bdea8bc4729749363cfe4e8ee268e8640c056c025955c0458de3b4b44ca"
[1] "5981a2f324b01a80674f016eaa4fe44fe577842a9d825ef8e5ed06801978b865"
[1] "8365e175af54bf134f21ef5b80c1aea66604893db27ba829118466b255d93c04"
[1] "c98b16c8ea2928361a4ede39d38638e8927d0e6bbf5ce1f688b2fddde02e82af"
[1] "2dafb2f5487cae69c48eedcb3bef62b6bf697a3e00cd359cc30e46e1b21bc46c"
[1] "7aafae605f73a701ece38a1fe7e292ade217ecf99f8fcc45f759c34fcd83002d"
[1] "eefac2bb3d27c16467125cab3be6470ea5a7d4edc749e1b3a6991fdc7f953ab7"
[1] "706238f0d708202d409979ab444f044ed334b22e251331605bf81e8a5e5ffdd7"
[1] "cc4aefc81929ac048f9ee988e32f5ede146afaa0016a05f8f94c9cce9324c69b"
[1] "20c7a47dcc8bddba10358e39ea7cacf7d2a3bf783cc076117514a9b561a67700"
[1] "1b3c6f6ec9abbad479df717fb62ceeccfe0c00371c8e4c541d68889cdd5fee98"
[1] "07dc06fe1d907c5d018c53d6433c38f92f1d27ff7327492d2d3e0e43fbb1c837"
[1] "70a1705abde4f30ac8e5c9ebdad79041d959de16607284e9b5add1c968686b05"
[1] "f12a87c31615488e93f157b3b7925462a337c89778780f5a8086e5a5c0c56002"
[1] "907ab7af7655531cb841b08db754cc790d8a6bcd3147310c66f5eae2db35401a"
[1] "70d73d143c9e756754172d6eb9546d1f461bda31f2aa0de7e47c336368ea9286"
[1] "a4de79e953f370022e4d6f511b928551587c42a0c849020f64c4605b33626b15"
[1] "77b56e696d6ef39a954804412df280bfac81db42148f5e8f80127c0139c83ea6"
[1] "f1491dc9536143365f8898d3d2adf6fc7871fa8be6bd27e89d9bb8f195dbd58c"
[1] "ac0041cad81f86bd7625ee07e9769f6286bfeeae51e8b5c1ecd8351983d7cc9d"
[1] "813f37737ea36c1ba97b5585f3bb16a13145b5f89e564d71248df36723165201"
[1] "1a11c0669487cddeb9c7d2c37f89b3cd9bd0e3cf7beb9b7e2ab2eff8d826eff8"
[1] "16e4f4a9308bb10784d212214270f1aea7d77f3320bd80427f72e40a19d5ff5c"
[1] "1da929217ccdfd4f80e2c2c5e9fde25dea6c3980c54e5637fffe001f80bc9747"
[1] "cbd56cca5f9ba3b0a7c7533c1c6015e719cf9e5402ea70ba7b1bd6b1c6489263"
[1] "072fcf30ef73d861af1cdc73d29097fb0bf6482a09607e58fc79eb69a98329ad"
[1] "53d8a89a4bee7db969c85abc5c7201b3a94751ba0a5566a3da5917a62e2a881d"
[1] "a01522b8b24fcd160bf6b650b214ca7ce5ad66d3ee5aacdb6b7331d35d38abb8"
[1] "4f1acdd38c7f87d99319012003483c7b3f2cd5c4b3046eba8b5d8181aee261ee"
[1] "6e7a41a5c635cb692b6be1f180a6df8b2f35cd636df4861a80ab86448b2095c8"
[1] "a310750d90857ed7b24527ddbc0cdf81049990becbf27004869adabc2c4b1013"
[1] "305c739452d9a5d2f0f0b7785cc6fcbfa0d97d08ef52bc2d38c4756abd532b54"
[1] "b59b0bb62486aea41ed1e79a9fa2a96be5cb569e25b6e4a855156ee7dad4cf31"
[1] "4ff6199ec0734b9f7073b1ad2fb309dc42abab36dd4986d4e7aeae639affc4b4"
[1] "d6ddaadaf7ea44af2ecc9ce19f97600391a30126ef10994c62667f710ca69090"
[1] "2173de29b60f2275e8fac1e165676f2c276cfce19ddfe55a509dfc507f3566f9"
[1] "41277987e6d0943ac5cdde53f398dd5a7c5ea49695437ec0a8e79aab5b5641ee"
[1] "5c855c099e96e5327b93ba5ae16af6a98b3755cdd9c044db1632030ac0fb4764"
[1] "fcff924a7cd4030544bc26412fc06baafae168bf9c733eedf35ca8c9e29866fe"
[1] "84104b2db9f7de1a18c337d63f8ec1a0e7622d693b0b34b69d1f26c6fdd95b62"
[1] "ef263baf2f39716ed981556a8ceed3f9b7d494aca0030bb08c8f7a76f568af66"
[1] "1bc17844a4c77e70dd9c95545e6490011db36b78b9f8bae3f2d2876c1a25e72a"
[1] "683211739c5519be35016bd7db8812e272d839c26aeace423c2786e296cbe7eb"
[1] "049c9ae3a95d7d806cf0bdfbc3aaa8b66a370adf66d918671cc501b7eb16893c"
[1] "98068d9988acf648dbe3768a6f4f9aaadfc4e4cacd8acacc73288bb7c3049c18"
[1] "456fc562f458f3b0d0dfdfc148965520ec5ee12aa7c3b715bc38b1122e2b1d68"
[1] "ac3af32e229d572a8a945a22b23a9522c2d3a121cb77a813686ef742714800a7"
[1] "3657d923f73dca7f12fca7001cdb757c817b8697af1e2c42d45147bc84463fe8"
[1] "3442caf8b04a69ba355b8948d4e065a03bde0120516ca3f6ea8914dce3f987bd"
[1] "cacd037f2f9b610acfcd8ec44a3721c0c2144de59bb5450d18367d9044f91360"
[1] "7ace1e58c1222cf7c1e0df4bca9356e238cb6a713e247a07b0735d4b07584ed9"
[1] "9104d8a71ec23a48ee2f1dde07acbe7a8072bcfa7d20f189fbad2904dfeb78d2"
[1] "860abeb5ed9e479c879b8d3caa0ecfb97e2c30c609d80a6f5a88d2fbe916a1fc"
[1] "5162ec75fc2dd6b382e2f4f3c00a0f615954a11de4ecf44006b88ec44f99539a"
[1] "1f931b0d9af7b9d580e3a163e5e86d9e012deedd22aaacd43d3103a25374f7a2"
[1] "c8b722b23c5e40ba2f2525515b876be5ebad271060cb53f7838f2c8ed263e148"
[1] "b5c405a0db9f29811a72a2c41ad95fbed4d6e9c415d4116f7b0b278e5f54d260"
[1] "87b5a6962debb873e956ce00b2ccd795cbc79e28626eae87fe451a759056d269"
[1] "46833431670435f7f6f90285075ddd5a34576ca758953c01f937d170674cacec"
[1] "fb3d6f18a15b0a2cb56620e98edb5e9859d8b00aa3b4f4471665ba544590b065"
[1] "39e5cef0b6fab302c47756379956c251595eab426437a69deb2235bd3e57012d"
[1] "9252f22d653092513e7884a9683f8da284e6f0ce569319eb84a2ad76b5706cbc"
[1] "66a709069db59ff4784db4227969a2e0e16b087363ee724dae3e078088821a14"
[1] "3b2e9ddc6f7f4902de3a01ad59b9dc04530aa31202b91526ee2d51a2fb0c00da"
[1] "21514f1f808593feecf52cc2b9b2f9b56619af9c4d0faaad82d48731c367b557"
[1] "219c7d2727e44929f38d1f5e36f1bc616a31d04bd097245788c2e1d9f919b077"
[1] "1093ed88bb41127ada9191ce767d301f53589821d69e88ea8858e55d39e793ae"
[1] "9c07c5aaec78eacec5078e30cdeed30353d3f265a7bdafc39b596b08bb69ee57"
[1] "c6c998cf58a382829f19e178b852db5648caa1432b022ee80a178d707654eaac"
[1] "1823ef4d4d8d90a63e9400fc80f23f83b71f12310415706db18c9095c9795e51"
[1] "1314d466891aab41490ffd96dcb8b75f7574f05dbe7c3f19caa76a486fb21b71"
[1] "5d1583ef53ad165c7391e04e91375c1759808db3ca69d756c3c6c139cf6f3720"
[1] "ae8ab2358f553a5a215690042c1e70de8b4b5c4ee508dd59245677f3989a1563"
[1] "ad4eeb607d10505eea0509fa15bc777d24f11b1ec087a2e3d6021a05d9b60659"
[1] "8ac87302354e7a84e69f4c21b1080e94c4bdb6e81dbe6f9416260063ced369cc"
[1] "a8b2e8a1b078555263811dabfa5cb093ef4dcf101441af63ff95f4a1a28945c8"
[1] "4d0e1bf41f146c6adf07123e4ab762402a77f0c3c8a006d625f30277b47affcb"
[1] "50f556421663748be602a3b38bfe4adfbf882228320134c029b91e68214e8a68"
[1] "5391020a77657d85a8e4c3d663d931efdb236c998e4d0f378ac0a63d3696c5f4"
[1] "1e9840d0fffde05227c7979e464143d29302c197585fe731dd6528f72adcfa51"
[1] "6167a09373071a5ba01fcde8272f370efff1d88abd54ca704a7126db1a523023"
[1] "be6cda1e9261fed00192044908a4cf679e536fd9684111a61ce35c70d8be9be7"
[1] "fa1456d8392dba2d27c5bda83e20bdb0295614a91569bb85f00c69eabb88540e"
[1] "b9e211bbed593135b2f58e1cc412e6166702c67dfdab358fdc74183f6a945e93"
[1] "8771dd4f9bc9da3c0744a2b733adc3dd479762085464d5f08719795d41ab5d07"
[1] "74821c8f2a305c3eac7b9bc9c809f39811f652e88869fc03b227368f3f1b17b0"
[1] "551301f75871d4feb21289ad44113ff8b394347ddd6d30c9c4eccd784167a41c"
[1] "55a261ba8cfd352ca563eb9d62c1dcd6a3c3303543b2171c6b4b21dcb0b5d1bf"
[1] "d249e152c0cabbd2d8e1914e95782c7c8e1c52b804d1a0b280d886b104a63d07"
[1] "5940cc54f0a5433a6162bd37e47c159b19ebe04c3d2e7e89bd76e2f2e783647e"
[1] "419b96e236b29536aae8908681df2d554317e54342f4563603cce2ce821c6e82"
[1] "10010e32757342c7d51275cb96e1a7d78094724121d63ce1cd497c659da0a9f9"
[1] "cac1870358b94529781cd46abff8c41b3d3a09638820e015648d4ce2e67f44d0"
[1] "e44814b8a26051bd63c4b162c19c6b387d0174b36bf13f4bdf0f36cbaffdfec2"
[1] "850617605c3d60ecd0145bfe4a8053fa529e9061f46824d3b902f8706161ee8c"
[1] "4a5f0d925bc3e6641ecedf78487fc6fa23efb0ad5a00708d80e6210271f8e881"
[1] "690bf0da1035be54725598ea0b30589bf09b2fe2298c4e021ca90b52fac634bf"
[1] "e4aea7dcaa870a731fc2a3a04b318540a3a21fee406dfa098fb467e22f49380f"
[1] "79215c4cc40681dfd88dedd5df0d1fd4f7b62a7fb64abde4ee2848b25c19df1a"
[1] "13a08458d3af517b14e055f08d9852b22077844c7b372b73edaf479125ff51f7"
[1] "5e57c85f8c9f603ddea5bbb312ff0261869be4581e582cfea5c2cab4b8f8236e"
[1] "683c94a5d35aae72308415911e50414bf8d3f0813cca154e28e0b148524df9b7"
[1] "cc0b40e48c3bb9ae06df848fa49873f5cf5d1f72991ba8280553ed68e4eb533e"
[1] "80e7ddf3fee383209542a8ec40de5f923a3f81cd74d10b7a0552898b40aef5ee"
[1] "50bbe55e82304fbcbc6a385dcf2625f8dbc6138dd2919791431c744fe5ed81e1"
[1] "d1339007864e3dc8f59e2eae95bea59512818abadcae1ca98785cbed87b5879e"
[1] "2eec1a0c571a37322daa637766a087db6d0c0075f5465af4e552f233bfdfa081"
[1] "34dff9655eb63b7732184707cfef092d63082f5e661561d05a753fb21d06e5a0"
[1] "a78f257422b7a915e3613f9fc61c099a874b71c4a515b1a5e14d5f9c8426f7ce"
[1] "33d1915f3c2fd3ef06cf4fcb4c0341037a41ecb55d23abc0d8519da588fe13e4"
[1] "098ae6adfee83c74b419015e4c24b6a3d0d67604852af563d7dca79b6f78f63f"
[1] "e728212b1f5ab89604be312d5c482d4ba40db1f72a9ddb5f1f4c09b5e56b36c0"
[1] "9a0e2179e639cc0cd57944ce35e3a2e4cec1bbbfc547059bd9da758b4f828c4f"
[1] "8b6178e6ce14b58635357d434f7fb21d3183b6e5d396f76a923e6269d481b870"
[1] "bb842bac82a00602cedd230e460056aa5a53ab094bbff5a681d217985b5f0309"
[1] "929731c7b52798f066238f85423e7dc8a105ad3037f5f92da26bd065553b443f"
[1] "98cb093b7305be1ee75f80bebf03d1661e4ffcd303b6b4438d0a37dd07200644"
[1] "2403175b1811790a93347df0313902446e455273aac7dd6b92ba0d229483adf6"
[1] "aa84ac653b8fb19914bb687f08b190f458ad7620253687d2bf5222bb1eb0b899"
[1] "239a832c6b7bdd66c51a4b85a734da94c7d1adf34320834f45a2e5116244fbe4"
[1] "005269bb674beb32c104bb415f9cd7501aace44bb3de16758b840ed08e12900a"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$hash
[1] "005269bb674beb32c104bb415f9cd7501aace44bb3de16758b840ed08e12900a"

$nonce
[1] 165</code></pre>
</div>
</div>
<p>It takes 165 iterations to solve the problem of difficulty 2. How difficult is difficulty 3? This time <tt><code>print = FALSE</code></tt> to save space.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb253-1"><a href="#cb253-1"></a><span class="co"># Evaluate a difficulty of 3 (three leading zeros)</span></span>
<span id="cb253-2"><a href="#cb253-2"></a><span class="fu">proof_of_work</span>(block, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$hash
[1] "0003b3433712535240d61d5c5c29c2975ec8a170e941323d489bcc5fedad55f6"

$nonce
[1] 2937</code></pre>
</div>
</div>
<p>It takes 2937 iterations to solve the problem of difficulty 3. Note that the block remains the same except for the nonce value which increase by one every iteration.</p>
<p>See a 19 leading zeros example: https://blockstream.info/block/0000000000000000000ae7a6057c9c3d00ff21c1f8f87ca4413d89059cd9f2c6</p>
<p>Collect the nonce for the first four levels of difficulty.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1"></a>n <span class="ot">=</span> <span class="dv">4</span> <span class="co"># Do not try difficulty 5!</span></span>
<span id="cb255-2"><a href="#cb255-2"></a>iterations <span class="ot">=</span> <span class="fu">vector</span>(<span class="st">"integer"</span>, n)</span>
<span id="cb255-3"><a href="#cb255-3"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb255-4"><a href="#cb255-4"></a>  iterations[i] <span class="ot">=</span> <span class="fu">proof_of_work</span>(block, i)<span class="sc">$</span>nonce</span>
<span id="cb255-5"><a href="#cb255-5"></a>}</span>
<span id="cb255-6"><a href="#cb255-6"></a></span>
<span id="cb255-7"><a href="#cb255-7"></a>iterations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]     6   165  2937 14644</code></pre>
</div>
</div>
<p>See how difficult the problem gets as we look for more leading zeros in the hash.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb257-1"><a href="#cb257-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span>n, iterations, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">xlab =</span> <span class="st">"difficulty"</span>,  <span class="at">ylab =</span> <span class="st">"iterations"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-322-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb258-1"><a href="#cb258-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="fu">log</span>(iterations), <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">xlab =</span> <span class="st">"difficulty"</span>,  </span>
<span id="cb258-2"><a href="#cb258-2"></a>     <span class="at">ylab =</span> <span class="st">"log(iterations)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-323-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s build a blockchain using the PoW method:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb259-1"><a href="#cb259-1"></a><span class="co"># Mine algorithm.</span></span>
<span id="cb259-2"><a href="#cb259-2"></a>mine <span class="ot">&lt;-</span> <span class="cf">function</span>(previous_block, difficulty, <span class="at">genesis =</span> <span class="cn">FALSE</span>){</span>
<span id="cb259-3"><a href="#cb259-3"></a>  op <span class="ot">&lt;-</span> <span class="fu">options</span>(<span class="at">digits.secs =</span> <span class="dv">6</span>) <span class="co"># To get millisecond timestamps.</span></span>
<span id="cb259-4"><a href="#cb259-4"></a>  <span class="cf">if</span> (genesis) {</span>
<span id="cb259-5"><a href="#cb259-5"></a>    <span class="co"># Define genesis block.</span></span>
<span id="cb259-6"><a href="#cb259-6"></a>    new_block <span class="ot">&lt;-</span>  <span class="fu">list</span>(<span class="at">number =</span> <span class="dv">1</span>,</span>
<span id="cb259-7"><a href="#cb259-7"></a>                       <span class="at">timestamp =</span> <span class="fu">Sys.time</span>(),</span>
<span id="cb259-8"><a href="#cb259-8"></a>                       <span class="at">data =</span> <span class="st">"I'm genesis block"</span>,</span>
<span id="cb259-9"><a href="#cb259-9"></a>                       <span class="at">parent_hash =</span> <span class="st">"0"</span>)  </span>
<span id="cb259-10"><a href="#cb259-10"></a>  } <span class="cf">else</span> {</span>
<span id="cb259-11"><a href="#cb259-11"></a>    <span class="co"># Create new block.</span></span>
<span id="cb259-12"><a href="#cb259-12"></a>    new_block <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">number =</span> previous_block<span class="sc">$</span>number <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb259-13"><a href="#cb259-13"></a>                      <span class="at">timestamp =</span> <span class="fu">Sys.time</span>(),</span>
<span id="cb259-14"><a href="#cb259-14"></a>                      <span class="at">data =</span> <span class="fu">paste0</span>(<span class="st">"I'm block "</span>, previous_block<span class="sc">$</span>number <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb259-15"><a href="#cb259-15"></a>                      <span class="at">parent_hash =</span> previous_block<span class="sc">$</span>hash)</span>
<span id="cb259-16"><a href="#cb259-16"></a>  }</span>
<span id="cb259-17"><a href="#cb259-17"></a>  <span class="co"># Add nonce with PoW.</span></span>
<span id="cb259-18"><a href="#cb259-18"></a>  new_block<span class="sc">$</span>nonce <span class="ot">&lt;-</span> <span class="fu">proof_of_work</span>(new_block, difficulty)<span class="sc">$</span>nonce</span>
<span id="cb259-19"><a href="#cb259-19"></a>  <span class="co"># Add hash.</span></span>
<span id="cb259-20"><a href="#cb259-20"></a>  new_block<span class="sc">$</span>hash <span class="ot">&lt;-</span> <span class="fu">digest</span>(new_block, <span class="st">"sha256"</span>)</span>
<span id="cb259-21"><a href="#cb259-21"></a>  <span class="fu">return</span>(new_block)</span>
<span id="cb259-22"><a href="#cb259-22"></a>}</span>
<span id="cb259-23"><a href="#cb259-23"></a></span>
<span id="cb259-24"><a href="#cb259-24"></a><span class="co"># Create a blockchain using the PoW method:</span></span>
<span id="cb259-25"><a href="#cb259-25"></a>blockchained <span class="ot">=</span> <span class="cf">function</span>(difficulty, nblocks) {</span>
<span id="cb259-26"><a href="#cb259-26"></a>  <span class="co"># Mine genesis block.</span></span>
<span id="cb259-27"><a href="#cb259-27"></a>  block_genesis <span class="ot">=</span> <span class="fu">mine</span>(<span class="cn">NULL</span>, difficulty, <span class="cn">TRUE</span>)   </span>
<span id="cb259-28"><a href="#cb259-28"></a>  <span class="co"># First block is the genesis block.</span></span>
<span id="cb259-29"><a href="#cb259-29"></a>  blockchain <span class="ot">&lt;-</span> <span class="fu">list</span>(block_genesis)</span>
<span id="cb259-30"><a href="#cb259-30"></a>  </span>
<span id="cb259-31"><a href="#cb259-31"></a>  <span class="cf">if</span> (nblocks <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb259-32"><a href="#cb259-32"></a>    <span class="co"># Add new blocks to the chain.</span></span>
<span id="cb259-33"><a href="#cb259-33"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>nblocks){</span>
<span id="cb259-34"><a href="#cb259-34"></a>      blockchain[[i]] <span class="ot">&lt;-</span> <span class="fu">mine</span>(blockchain[[i<span class="dv">-1</span>]], difficulty) </span>
<span id="cb259-35"><a href="#cb259-35"></a>    }</span>
<span id="cb259-36"><a href="#cb259-36"></a>    }</span>
<span id="cb259-37"><a href="#cb259-37"></a>  <span class="fu">return</span>(blockchain)</span>
<span id="cb259-38"><a href="#cb259-38"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Create 4 blocks with difficulty 3.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1"></a><span class="co"># 4 blocks, difficulty 3</span></span>
<span id="cb260-2"><a href="#cb260-2"></a><span class="fu">blockchained</span>(<span class="at">difficulty =</span> <span class="dv">3</span>, <span class="at">nblocks =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[[1]]$number
[1] 1

[[1]]$timestamp
[1] "2024-01-02 23:59:46.650306 CST"

[[1]]$data
[1] "I'm genesis block"

[[1]]$parent_hash
[1] "0"

[[1]]$nonce
[1] 10846

[[1]]$hash
[1] "000d70e61ddb2618977a6af37dcf28b556e50f639d4c236939ab5661221341ac"


[[2]]
[[2]]$number
[1] 2

[[2]]$timestamp
[1] "2024-01-02 23:59:47.052567 CST"

[[2]]$data
[1] "I'm block 2"

[[2]]$parent_hash
[1] "000d70e61ddb2618977a6af37dcf28b556e50f639d4c236939ab5661221341ac"

[[2]]$nonce
[1] 3066

[[2]]$hash
[1] "000f89d9f598d7e2c47780ade01658a244bfec986bf07b8a2a11d2cbecb1e608"


[[3]]
[[3]]$number
[1] 3

[[3]]$timestamp
[1] "2024-01-02 23:59:47.19418 CST"

[[3]]$data
[1] "I'm block 3"

[[3]]$parent_hash
[1] "000f89d9f598d7e2c47780ade01658a244bfec986bf07b8a2a11d2cbecb1e608"

[[3]]$nonce
[1] 2185

[[3]]$hash
[1] "00044431f9243270d0e300bce1aa4058392ec88f5a98ef4a3842bf9b6cc8d6a3"


[[4]]
[[4]]$number
[1] 4

[[4]]$timestamp
[1] "2024-01-02 23:59:47.276062 CST"

[[4]]$data
[1] "I'm block 4"

[[4]]$parent_hash
[1] "00044431f9243270d0e300bce1aa4058392ec88f5a98ef4a3842bf9b6cc8d6a3"

[[4]]$nonce
[1] 6003

[[4]]$hash
[1] "000272a43911dd3166c5a2f837680fc0f7c0af5c478c3444cd4f23521481829e"</code></pre>
</div>
</div>
<p>Nice.</p>
</section>
<section id="transactions." class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="transactions."><span class="header-section-number">5.5</span> Transactions.</h2>
<p>Typically, the data field of a block contains a certain number of transactions. Each transaction has a sender, a receiver and a value of crypto currency that is transferred from sender to receiver. Moreover, it contains a fee of the transaction. Transactions are stored in a pool of pending transactions and each mined block will include a (proper) subset of pending transactions. The miner of the block gets the fees of all blocked transactions plus a fixed mining reward (and this transaction is included in the following block). This is how new coins are introduced in the blockchain economy.</p>
<p>Let’s create a pool of fictitious pending transactions. We store them in a data frame structure using the <tt><code>tibble</code></tt> package.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb262-2"><a href="#cb262-2"></a>ntrx <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># Number of transactions.</span></span>
<span id="cb262-3"><a href="#cb262-3"></a>sender <span class="ot">&lt;-</span> <span class="fu">sample</span>(LETTERS, ntrx) <span class="co"># Sender names.</span></span>
<span id="cb262-4"><a href="#cb262-4"></a>receiver <span class="ot">&lt;-</span> <span class="fu">sample</span>(LETTERS, ntrx) <span class="co"># Receiver names.</span></span>
<span id="cb262-5"><a href="#cb262-5"></a>value <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="at">n =</span> ntrx, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">100</span>), <span class="dv">0</span>) <span class="co"># Transaction value.</span></span>
<span id="cb262-6"><a href="#cb262-6"></a>fee <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="at">n =</span> ntrx, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>), <span class="dv">2</span>) <span class="co"># Transaction fee.</span></span>
<span id="cb262-7"><a href="#cb262-7"></a>(<span class="at">transactions =</span> <span class="fu">tibble</span>(sender, receiver, value, fee)) <span class="co"># Pending transactions.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
   sender receiver value   fee
   &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
 1 P      C           60  0.59
 2 F      O           79  0.46
 3 Z      I           70  0.8 
 4 R      S           46  0.97
 5 W      J           42  0.68
 6 Q      P           24  0.34
 7 B      F           95  0.58
 8 E      M            0  0.98
 9 M      U            8  0.65
10 Y      N           48  0.75</code></pre>
</div>
</div>
<p>Let’s update the mining function. Each block will include the most profitable transactions (the ones with the highest fees) among the pending ones. The miner of the block gets as reward the sum of the fees of transactions in the block. The reward transaction is inserted in the next block. We take advantage of <tt><code>dplyr</code></tt> package.</p>
<p>Update of the mining function. ::: {.cell}</p>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb264-1"><a href="#cb264-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb264-2"><a href="#cb264-2"></a></span>
<span id="cb264-3"><a href="#cb264-3"></a>mine <span class="ot">&lt;-</span> <span class="cf">function</span>(previous_block, transactions, <span class="at">difficulty =</span> <span class="dv">3</span>, </span>
<span id="cb264-4"><a href="#cb264-4"></a>                 <span class="at">block_size =</span> <span class="dv">3</span>, <span class="at">miner =</span> <span class="st">"Z"</span>, <span class="at">genesis =</span> <span class="cn">FALSE</span>){</span>
<span id="cb264-5"><a href="#cb264-5"></a>  <span class="co"># Filter transactions to add.</span></span>
<span id="cb264-6"><a href="#cb264-6"></a>  trans_pending <span class="ot">=</span> <span class="fu">arrange</span>(transactions, <span class="sc">-</span>fee) <span class="co"># from higher to lower fee.</span></span>
<span id="cb264-7"><a href="#cb264-7"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(trans_pending) <span class="sc">&lt;</span> block_size) {</span>
<span id="cb264-8"><a href="#cb264-8"></a>    trans_to_add <span class="ot">=</span> trans_pending</span>
<span id="cb264-9"><a href="#cb264-9"></a>    trans_pending <span class="ot">=</span> <span class="fu">tibble</span>()</span>
<span id="cb264-10"><a href="#cb264-10"></a>  } <span class="cf">else</span> {</span>
<span id="cb264-11"><a href="#cb264-11"></a>    trans_to_add <span class="ot">=</span>  <span class="fu">filter</span>(trans_pending, <span class="fu">row_number</span>() <span class="sc">&lt;=</span> block_size) </span>
<span id="cb264-12"><a href="#cb264-12"></a>    trans_pending <span class="ot">=</span> <span class="fu">filter</span>(trans_pending, <span class="fu">row_number</span>() <span class="sc">&gt;</span> block_size) </span>
<span id="cb264-13"><a href="#cb264-13"></a>  }</span>
<span id="cb264-14"><a href="#cb264-14"></a>  </span>
<span id="cb264-15"><a href="#cb264-15"></a>  <span class="cf">if</span> (genesis) {</span>
<span id="cb264-16"><a href="#cb264-16"></a>    <span class="co"># Define genesis block.</span></span>
<span id="cb264-17"><a href="#cb264-17"></a>    new_block <span class="ot">&lt;-</span>  <span class="fu">list</span>(<span class="at">number =</span> <span class="dv">1</span>,</span>
<span id="cb264-18"><a href="#cb264-18"></a>                       <span class="at">timestamp =</span> <span class="fu">Sys.time</span>(),</span>
<span id="cb264-19"><a href="#cb264-19"></a>                       <span class="at">data =</span> trans_to_add,</span>
<span id="cb264-20"><a href="#cb264-20"></a>                       <span class="at">parent_hash =</span> <span class="st">"0"</span>)  </span>
<span id="cb264-21"><a href="#cb264-21"></a>  } <span class="cf">else</span> {</span>
<span id="cb264-22"><a href="#cb264-22"></a>    <span class="co"># Create new block.</span></span>
<span id="cb264-23"><a href="#cb264-23"></a>    new_block <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">number =</span> previous_block<span class="sc">$</span>number <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb264-24"><a href="#cb264-24"></a>                      <span class="at">timestamp =</span> <span class="fu">Sys.time</span>(),</span>
<span id="cb264-25"><a href="#cb264-25"></a>                      <span class="at">data =</span> trans_to_add,</span>
<span id="cb264-26"><a href="#cb264-26"></a>                      <span class="at">parent_hash =</span> previous_block<span class="sc">$</span>hash)</span>
<span id="cb264-27"><a href="#cb264-27"></a>  }</span>
<span id="cb264-28"><a href="#cb264-28"></a>  </span>
<span id="cb264-29"><a href="#cb264-29"></a>  <span class="co"># Add nonce with PoW.</span></span>
<span id="cb264-30"><a href="#cb264-30"></a>  new_block<span class="sc">$</span>nonce <span class="ot">&lt;-</span> <span class="fu">proof_of_work</span>(new_block, difficulty)<span class="sc">$</span>nonce</span>
<span id="cb264-31"><a href="#cb264-31"></a>  <span class="co"># Add hash.</span></span>
<span id="cb264-32"><a href="#cb264-32"></a>  new_block<span class="sc">$</span>hash <span class="ot">&lt;-</span> <span class="fu">digest</span>(new_block, <span class="st">"sha256"</span>)</span>
<span id="cb264-33"><a href="#cb264-33"></a>  <span class="co"># Add reward transaction.</span></span>
<span id="cb264-34"><a href="#cb264-34"></a>  trans_pending <span class="ot">=</span> <span class="fu">rbind</span>(trans_pending, </span>
<span id="cb264-35"><a href="#cb264-35"></a>                        <span class="fu">data.frame</span>(<span class="at">sender =</span> <span class="cn">NA</span>, <span class="at">receiver =</span> miner, </span>
<span id="cb264-36"><a href="#cb264-36"></a>                                   <span class="at">value =</span> <span class="fu">sum</span>(new_block<span class="sc">$</span>data<span class="sc">$</span>fee), </span>
<span id="cb264-37"><a href="#cb264-37"></a>                                   <span class="at">fee =</span> <span class="fl">0.01</span>))</span>
<span id="cb264-38"><a href="#cb264-38"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">block =</span> new_block, <span class="at">transactions =</span> trans_pending))</span>
<span id="cb264-39"><a href="#cb264-39"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>:::</p>
<p>Blockchain with transactions.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb265-1"><a href="#cb265-1"></a>blockchained <span class="ot">=</span> <span class="cf">function</span>(transactions, difficulty, block_size, nblocks) {</span>
<span id="cb265-2"><a href="#cb265-2"></a>  <span class="co"># Define genesis block.</span></span>
<span id="cb265-3"><a href="#cb265-3"></a>  mined <span class="ot">=</span> <span class="fu">mine</span>(<span class="cn">NULL</span>, transactions, difficulty, block_size, <span class="at">miner =</span> <span class="st">"Z"</span>, </span>
<span id="cb265-4"><a href="#cb265-4"></a>               <span class="at">genesis =</span> <span class="cn">TRUE</span>)</span>
<span id="cb265-5"><a href="#cb265-5"></a>  block_genesis <span class="ot">&lt;-</span> mined<span class="sc">$</span>block</span>
<span id="cb265-6"><a href="#cb265-6"></a>  pending <span class="ot">=</span> mined<span class="sc">$</span>transactions</span>
<span id="cb265-7"><a href="#cb265-7"></a>  <span class="co"># First block is the genesis block.</span></span>
<span id="cb265-8"><a href="#cb265-8"></a>  blockchain <span class="ot">&lt;-</span> <span class="fu">list</span>(block_genesis)</span>
<span id="cb265-9"><a href="#cb265-9"></a></span>
<span id="cb265-10"><a href="#cb265-10"></a>  <span class="cf">if</span> (nblocks <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb265-11"><a href="#cb265-11"></a>    <span class="co"># Add blocks to the chain.</span></span>
<span id="cb265-12"><a href="#cb265-12"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>nblocks){</span>
<span id="cb265-13"><a href="#cb265-13"></a>      mined <span class="ot">&lt;-</span> <span class="fu">mine</span>(blockchain[[i<span class="dv">-1</span>]], pending, difficulty, block_size, </span>
<span id="cb265-14"><a href="#cb265-14"></a>                    <span class="at">miner =</span> <span class="st">"Z"</span>)</span>
<span id="cb265-15"><a href="#cb265-15"></a>      blockchain[[i]] <span class="ot">&lt;-</span> mined<span class="sc">$</span>block</span>
<span id="cb265-16"><a href="#cb265-16"></a>      pending <span class="ot">=</span> mined<span class="sc">$</span>transactions</span>
<span id="cb265-17"><a href="#cb265-17"></a>    }</span>
<span id="cb265-18"><a href="#cb265-18"></a>  }</span>
<span id="cb265-19"><a href="#cb265-19"></a>  </span>
<span id="cb265-20"><a href="#cb265-20"></a>  <span class="fu">return</span>(blockchain)</span>
<span id="cb265-21"><a href="#cb265-21"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Build a new blockchain with transactions.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb266-1"><a href="#cb266-1"></a>trans <span class="ot">&lt;-</span> <span class="fu">blockchained</span>(transactions, <span class="at">difficulty =</span> <span class="dv">3</span>, <span class="at">block_size =</span> <span class="dv">5</span>, </span>
<span id="cb266-2"><a href="#cb266-2"></a>                      <span class="at">nblocks =</span> <span class="dv">3</span>)</span>
<span id="cb266-3"><a href="#cb266-3"></a>trans[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$number
[1] 1

$timestamp
[1] "2024-01-02 23:59:47.690387 CST"

$data
# A tibble: 5 × 4
  sender receiver value   fee
  &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
1 E      M            0  0.98
2 R      S           46  0.97
3 Z      I           70  0.8 
4 Y      N           48  0.75
5 W      J           42  0.68

$parent_hash
[1] "0"

$nonce
[1] 3458

$hash
[1] "000ee4538a804b980c19bc933f9255b18ab0a1ed0c673ce2a2bca5d7002dffa3"</code></pre>
</div>
</div>
<p>In the first block above, we have the first half of the transactions sorted by fee.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb268-1"><a href="#cb268-1"></a>trans[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$number
[1] 2

$timestamp
[1] "2024-01-02 23:59:47.817323 CST"

$data
# A tibble: 5 × 4
  sender receiver value   fee
  &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
1 M      U            8  0.65
2 P      C           60  0.59
3 B      F           95  0.58
4 F      O           79  0.46
5 Q      P           24  0.34

$parent_hash
[1] "000ee4538a804b980c19bc933f9255b18ab0a1ed0c673ce2a2bca5d7002dffa3"

$nonce
[1] 963

$hash
[1] "00086392d4427baa4226ec9b8abd66ef26ac174ae5aece581d112e8b5fa027da"</code></pre>
</div>
</div>
<p>In the second block above, we have the second half of the transactions sorted by fee.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb270-1"><a href="#cb270-1"></a>trans[[<span class="dv">3</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$number
[1] 3

$timestamp
[1] "2024-01-02 23:59:47.86622 CST"

$data
# A tibble: 2 × 4
  sender receiver value   fee
  &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
1 &lt;NA&gt;   Z         4.18  0.01
2 &lt;NA&gt;   Z         2.62  0.01

$parent_hash
[1] "00086392d4427baa4226ec9b8abd66ef26ac174ae5aece581d112e8b5fa027da"

$nonce
[1] 912

$hash
[1] "000180211f77f6235ebf1c8c016ae2610da6f4f5dd5703fe14d8a84250cff303"</code></pre>
</div>
</div>
<p>In the third block above, the miner of the block Z solves the leading zeros problem and gets the fees of all blocked transactions plus a fixed mining reward (and this transaction is included in the following block).</p>
</section>
<section id="digital-signature." class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="digital-signature."><span class="header-section-number">5.6</span> Digital signature.</h2>
<p>How can we be sure that transactions are authentic? Blockchain uses asymmetric cryptography to implement digital signatures of transactions. Each transaction is signed by the sender with her private key and anyone can verify the authenticity of the signature (and of the transaction) using the sender’s public key.</p>
<p>Public-key cryptography, or asymmetric cryptography, is any cryptographic system that uses pairs of keys: public keys which may be disseminated widely, and private keys which are known only to the owner. This accomplishes two functions: authentication, where the public key verifies that a holder of the paired private key sent the message, and encryption, where only the paired private key holder can decrypt the message encrypted with the public key. The strength of a public key cryptography system relies on the computational effort required to find the private key from its paired public key.</p>
<p>In a public key encryption system, any person can encrypt a message using the receiver’s public key. That encrypted message can only be decrypted with the receiver’s private key. In a public key signature system, a person can combine a message with a private key to create a short digital signature on the message. Anyone with the corresponding public key can combine the signed message and the known public key to verify whether the signature on the message was valid, i.e.&nbsp;made by the owner of the corresponding private key. Changing the message, even replacing a single letter, will cause verification to fail.</p>
<p>To speed up the process of transmission, instead of applying the sender’s digital signature to the (possibly large) message, the sender can rather hash the message using a cryptographic hash function and then digitally sign the generated hash value. The sender would then sign the newly generated hash value with their private key and encrypt the original message with the receiver’s public key. The transmission would then take place securely and with confidentiality and non-repudiation still intact. The receiver would then verify the signature with sender’s public key and decrypt the message with their private key.</p>
<p>RSA (Rivest–Shamir–Adleman) is one of the first public-key cryptosystems and is widely used for secure data transmission. In RSA, the asymmetry is based on the practical difficulty of the factorization of the product of two large prime numbers.</p>
<p>Next is an example of encryption and digital signature using package <tt><code>openssl</code></tt>. First, the encryption example.</p>
<p>Generate a RSA (Rivest–Shamir–Adleman) private and a public key (pubkey).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb272-1"><a href="#cb272-1"></a><span class="fu">library</span>(openssl)</span>
<span id="cb272-2"><a href="#cb272-2"></a><span class="co"># Encryption.</span></span>
<span id="cb272-3"><a href="#cb272-3"></a>key <span class="ot">&lt;-</span> <span class="fu">rsa_keygen</span>(<span class="dv">512</span>)</span>
<span id="cb272-4"><a href="#cb272-4"></a>pubkey <span class="ot">&lt;-</span> key<span class="sc">$</span>pubkey</span>
<span id="cb272-5"><a href="#cb272-5"></a>key</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[512-bit rsa private key]
md5: ce1eea4490b0bda6547e76c7db45123b
sha256: edfe1b5979ee54e4a83fb6b3bed5040793f13a521d496aef4207ad4ddf9cd23e</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb274-1"><a href="#cb274-1"></a>pubkey</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[512-bit rsa public key]
md5: ce1eea4490b0bda6547e76c7db45123b
sha256: edfe1b5979ee54e4a83fb6b3bed5040793f13a521d496aef4207ad4ddf9cd23e</code></pre>
</div>
</div>
<p>Looks the same, but the the private key has some more information inside the key object.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb276"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb276-1"><a href="#cb276-1"></a><span class="fu">str</span>(pubkey)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>List of 5
 $ type       : chr "rsa"
 $ size       : int 512
 $ ssh        : chr "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAAQQCe0Lr9vrBsXu ..."
 $ fingerprint: 'hash' raw [1:32] ed fe 1b 59 ...
 $ data       :List of 2
  ..$ e: 'bignum' raw [1:3] 01 00 01
  ..$ n: 'bignum' raw [1:65] 00 9e d0 ba ...</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1"></a><span class="fu">str</span>(key)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>List of 4
 $ type  : chr "rsa"
 $ size  : int 512
 $ pubkey:List of 5
  ..$ type       : chr "rsa"
  ..$ size       : int 512
  ..$ ssh        : chr "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAAQQCe0Lr9vrBsXu ..."
  ..$ fingerprint: 'hash' raw [1:32] ed fe 1b 59 ...
  ..$ data       :List of 2
  .. ..$ e: 'bignum' raw [1:3] 01 00 01
  .. ..$ n: 'bignum' raw [1:65] 00 9e d0 ba ...
 $ data  :List of 8
  ..$ e : 'bignum' raw [1:3] 01 00 01
  ..$ n : 'bignum' raw [1:65] 00 9e d0 ba ...
  ..$ p : 'bignum' raw [1:33] 00 cc 16 3d ...
  ..$ q : 'bignum' raw [1:33] 00 c7 36 7d ...
  ..$ d : 'bignum' raw [1:64] 75 79 56 67 ...
  ..$ dp: 'bignum' raw [1:32] 47 cd 17 70 ...
  ..$ dq: 'bignum' raw [1:32] 09 78 c1 c8 ...
  ..$ qi: 'bignum' raw [1:33] 00 b8 24 fa ...</code></pre>
</div>
</div>
<p>The <tt><code>charToRaw()</code></tt> function converts a length-one character string to raw bytes.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1"></a><span class="co"># Message.</span></span>
<span id="cb280-2"><a href="#cb280-2"></a>msg <span class="ot">&lt;-</span> <span class="fu">charToRaw</span>(<span class="st">"Blockchain is terrific!"</span>)</span>
<span id="cb280-3"><a href="#cb280-3"></a>msg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 42 6c 6f 63 6b 63 68 61 69 6e 20 69 73 20 74 65 72 72 69 66 69 63 21</code></pre>
</div>
</div>
<p>The message <em>Blockchain is terrific!</em> is now transformed into data to encrypt. Each pair of characters (62, 6c and so on) represents one word, blank space or exclamation mark.</p>
<p>Cipher (transform a message to conceal its meaning) the message with public key.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1"></a>ciphermsg <span class="ot">&lt;-</span> <span class="fu">rsa_encrypt</span>(msg, pubkey)</span>
<span id="cb282-2"><a href="#cb282-2"></a>ciphermsg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 2e bb 7b 07 e5 56 c2 2b 97 28 d6 29 72 de 39 f1 89 96 a7 7b 14 a1 25 4e 46
[26] cd 6a b1 06 dd f0 30 9f e5 74 11 f8 ce 2b 55 93 0b 62 bf 98 ad 93 e2 6d bf
[51] e2 01 4a 88 a1 d6 34 ed 54 7b 2a 68 8a b2</code></pre>
</div>
</div>
<p>This is how it looks the encrypted message <em>Blockchain is terrific!</em></p>
<p>Decrypt the message with private key.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb284-1"><a href="#cb284-1"></a><span class="fu">rawToChar</span>(<span class="fu">rsa_decrypt</span>(ciphermsg, key))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Blockchain is terrific!"</code></pre>
</div>
</div>
<p>And this is how we can decrypt the message with the private key. Now, the signature example where the message is a transaction.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb286-1"><a href="#cb286-1"></a><span class="co"># Signature.</span></span>
<span id="cb286-2"><a href="#cb286-2"></a><span class="co"># Generate a private key (key) and a public key (pubkey)</span></span>
<span id="cb286-3"><a href="#cb286-3"></a>key <span class="ot">&lt;-</span> <span class="fu">rsa_keygen</span>()</span>
<span id="cb286-4"><a href="#cb286-4"></a>pubkey <span class="ot">&lt;-</span> key<span class="sc">$</span>pubkey</span>
<span id="cb286-5"><a href="#cb286-5"></a><span class="co"># build a transaction</span></span>
<span id="cb286-6"><a href="#cb286-6"></a>trans <span class="ot">=</span> <span class="fu">list</span>(<span class="at">sender =</span> <span class="st">"A"</span>, <span class="at">receiver =</span> <span class="st">"B"</span>, <span class="at">amount =</span> <span class="st">"100"</span>)</span>
<span id="cb286-7"><a href="#cb286-7"></a>trans</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$sender
[1] "A"

$receiver
[1] "B"

$amount
[1] "100"</code></pre>
</div>
</div>
<p>This is the original transaction.</p>
<p>Serialize the transaction data.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb288-1"><a href="#cb288-1"></a>data <span class="ot">&lt;-</span> <span class="fu">serialize</span>(trans, <span class="cn">NULL</span>)</span>
<span id="cb288-2"><a href="#cb288-2"></a>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] 58 0a 00 00 00 03 00 04 03 02 00 03 05 00 00 00 00 05 55 54 46 2d 38 00 00
 [26] 02 13 00 00 00 03 00 00 00 10 00 00 00 01 00 04 00 09 00 00 00 01 41 00 00
 [51] 00 10 00 00 00 01 00 04 00 09 00 00 00 01 42 00 00 00 10 00 00 00 01 00 04
 [76] 00 09 00 00 00 03 31 30 30 00 00 04 02 00 00 00 01 00 04 00 09 00 00 00 05
[101] 6e 61 6d 65 73 00 00 00 10 00 00 00 03 00 04 00 09 00 00 00 06 73 65 6e 64
[126] 65 72 00 04 00 09 00 00 00 08 72 65 63 65 69 76 65 72 00 04 00 09 00 00 00
[151] 06 61 6d 6f 75 6e 74 00 00 00 fe</code></pre>
</div>
</div>
<p>In computing, serialization is the process of translating a data structure or object state into a format that can be stored or transmitted and reconstructed later. Here, the transaction is translated into a format that can be reconstructed later. At the moment, this object called <tt><code>data</code></tt> has not been signed yet by the sender. The next code chunk sign the <tt><code>data</code></tt> object by the sender.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb290"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb290-1"><a href="#cb290-1"></a><span class="co"># Sign (a hash of) the transaction with private key.</span></span>
<span id="cb290-2"><a href="#cb290-2"></a>sig <span class="ot">&lt;-</span> <span class="fu">signature_create</span>(data, sha256, <span class="at">key =</span> key)</span>
<span id="cb290-3"><a href="#cb290-3"></a>sig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] 5a e2 0f 98 83 b7 32 df 59 99 fa d4 00 1a 02 70 c9 6a f3 d7 e9 0e 61 f9 5f
 [26] 84 fc 34 0d 86 35 ce 76 f6 96 3e 08 ed 43 c8 ac 0c c2 67 a6 4e 96 c2 f1 f2
 [51] a0 e8 d8 a5 73 9b 0b d3 7b 8b 83 7b 1d 06 c2 12 86 f1 2e 16 98 a8 6d d5 1a
 [76] 05 3e 23 2d 47 b1 ac 6f 95 e6 77 e4 bc f8 84 3e 56 ca fa 7f 8e 5a 90 fd 59
[101] 72 a2 13 c3 01 f9 58 32 1e 4b 8b 0a 6f 29 70 7f d5 ae 01 51 02 84 9e bd d1
[126] ef b4 c5 5b 77 61 ae d2 5f 49 9c 30 9e b9 38 3d 94 db ac ca 0d 69 20 d3 6b
[151] f9 0e f6 67 d0 16 52 62 da 0a df 1f 5b d1 f8 44 80 16 08 14 4c c6 63 c0 4a
[176] bc 8d ea 44 88 84 cc 34 a6 8f 1d 5d 8b b7 9b e7 6c 04 1c 5d ef e6 c5 15 13
[201] d6 83 2e 48 fd 4f 06 74 7c ba 10 2c 31 1e 4f 12 61 40 c5 d3 6b 82 e8 20 83
[226] 38 69 9a d3 85 89 13 a0 61 4f 40 b9 21 32 2b 9d 81 f4 aa 24 78 88 51 67 b3
[251] 1e b3 49 da 0f e0</code></pre>
</div>
</div>
<p>The new object <tt><code>sig</code></tt> has not only the translated transaction, it has been also signed by the sender. With the function <tt><code>signature_verify()</code></tt>, anyone could verify that the sender of the transaction is the owner of the <tt><code>pubkey</code></tt>.</p>
<p>Verify the message with public key.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb292"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb292-1"><a href="#cb292-1"></a><span class="fu">signature_verify</span>(data, sig, sha256, <span class="at">pubkey =</span> pubkey)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Anyone could know that the transaction belongs to the sender with the <tt><code>pubkey</code></tt>. Now, we encrypt the translated and signed transaction.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb294"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb294-1"><a href="#cb294-1"></a><span class="co"># Cipher the transaction with public key</span></span>
<span id="cb294-2"><a href="#cb294-2"></a>ciphermsg <span class="ot">&lt;-</span> <span class="fu">rsa_encrypt</span>(data, pubkey)</span>
<span id="cb294-3"><a href="#cb294-3"></a>ciphermsg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] 1b 71 bd 41 c8 4e 10 fc c1 86 bf 3a 23 d3 b8 2b 40 63 33 51 6e 7f 0c 6d 56
 [26] 32 52 09 92 d6 6a 4a 05 98 96 f0 42 ef 9a 48 ec d7 34 7b 1c 1f f1 64 31 8a
 [51] d3 cb 64 0c 92 29 eb eb 2b 71 c9 29 a3 cd 87 5c a6 54 e8 9e 03 77 b8 be 67
 [76] 33 9f cc 57 a2 77 2e bb f0 dd 0f 11 31 0f 25 d3 3a 0a 94 cf 97 d4 5e 6d 81
[101] 6f 08 3c f5 b5 a6 b0 26 6f a8 95 c9 52 d1 f3 51 28 eb 21 39 8c 22 41 e0 3d
[126] e0 9a 5a 0e c2 a3 ad 66 47 51 68 2d a4 69 2a 2e a6 d5 25 54 7d 4a b8 21 62
[151] ef 3b 90 f9 fe 31 5c 12 0d 8c 13 ba 8a 21 ef 2a 5d 28 2e b2 09 5b 19 30 36
[176] f1 4d 0e 63 9a 96 8d 23 6e 28 24 81 ae c4 f1 da e8 09 16 66 9f 16 6c d5 af
[201] fd 15 c9 95 bb 9a 38 f9 c9 04 08 ed 52 76 cc f3 66 5f 40 bd f7 65 bc 4f 34
[226] ad 47 b6 55 36 38 64 a7 ed 4e 21 d0 49 7e ee 19 56 f0 59 3f 3d 55 8c 34 54
[251] b6 c7 5b 7b a1 76</code></pre>
</div>
</div>
<p>The transaction is translated, signed by the sender and now encrypted with the sender’s <tt><code>pubkey</code></tt>. To recover the original transaction we would need to decrypt the serialized message with the private key <tt><code>key</code></tt>, and then unserialize the result.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb296"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb296-1"><a href="#cb296-1"></a><span class="co"># Decrypt and unserialize the transation with private key.</span></span>
<span id="cb296-2"><a href="#cb296-2"></a><span class="fu">unserialize</span>(<span class="fu">rsa_decrypt</span>(ciphermsg, key))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$sender
[1] "A"

$receiver
[1] "B"

$amount
[1] "100"</code></pre>
</div>
</div>
<p>The transaction details are back.</p>
</section>
<section id="network." class="level2" data-number="5.7">
<h2 data-number="5.7" class="anchored" data-anchor-id="network."><span class="header-section-number">5.7</span> Network.</h2>
<p>Finally, the blockchain ledger is distributed over a peer-to-peer network. The steps to run the network are as follows:</p>
<ul>
<li>new transactions are broadcast to all nodes;</li>
<li>each node collects new transactions into a block;</li>
<li>each node works on finding a difficult proof-of-work for its block;</li>
<li>when a node finds a proof-of-work, it broadcasts the block to all nodes;</li>
<li>nodes accept the block only if all transactions in it are valid and not already spent;</li>
<li>nodes express their acceptance of the block by working on creating the next block in the chain, using the hash of the accepted block as the previous hash.</li>
</ul>
<p>Nodes always consider the longest chain to be the correct one and will keep working on extending it. The incentive of rewards may help encourage nodes to stay honest. If a greedy attacker is able to assemble more CPU power than all the honest nodes, he would have to choose between using it to defraud people by stealing back his payments, or using it to generate new coins. He ought to find it more profitable to play by the rules (generate new coins), such rules that favour him with more new coins than everyone else combined, than to undermine the system and the validity of his own wealth.</p>
</section>
<section id="privacy." class="level2" data-number="5.8">
<h2 data-number="5.8" class="anchored" data-anchor-id="privacy."><span class="header-section-number">5.8</span> Privacy.</h2>
<p>The traditional banking model achieves a level of privacy by limiting access to information to the parties involved and the trusted third party. The necessity to announce all transactions publicly precludes this method, but privacy can still be maintained by breaking the flow of information in another place: by keeping public keys anonymous. The public can see that someone is sending an amount to someone else, but without information linking the transaction to anyone. This is similar to the level of information released by stock exchanges, where the time and size of individual trades, the tape, is made public, but without telling who the parties were.</p>
</section>
</section>
<section id="conclusion." class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Conclusion.</h1>
<p>Finance is not about how to make money; it is about much more than that. Finance is about how to find and use resources, and how to assign them into projects. This is not an easy task as resources are limited and projects are risky. Moreover, sometimes the financial markets do not work well: bad projects are financed and good projects are not. However, if we rely on finance theory, quantitative models, and data analysis, we increase the chances to make good and informed decisions. Making money is a necessary step that allows us to pursue superior objectives like making firms growth, create better jobs, stimulate innovation, economic growth, and hopefully improve the standard of living of the population.</p>
<p>We have made some progress at implementing financial and economic models to achieve these superior objectives but we cannot say we have succeeded. Poverty levels in some countries are high, and income inequality leads not only to economic but also social problems. Fortunately, there is an increasing and genuine interest in learning finance principles by good people around the world.</p>
<!-- # Proyectos PEF. -->
<!-- ```{r} -->
<!-- format(Sys.time(), '%d %b %Y, %H:%M:%S.') -->
<!-- ``` -->
<!-- Los siguientes proyectos PEF y su breve descripción están dirigidos a estudiantes de ingeniería en sistemas computacionales o ciencias computacionales con interés en finanzas computacionales, finanzas cuantitativas, o aplicaciones FinTech.  -->
<!-- Aquí se describen cuatro proyectos, pero puedo proponer más dependiendo de los intereses y habilidades de los estudiantes. Las posibilidades son amplias porque en el sistema financiero local, nacional e internacional todavía hay muchas oportunidades de incorporar tecnología y modelos financieros para innovar y ofrecer soluciones de inversión y financiamiento a los agentes económicos (individuos, empresas y gobiernos). Estos proyectos no necesariamente tienen que ser software, también podrían orientarse a proyectos de consultoría de negocios, o a proyectos de investigación en donde se justifique el uso intensivo de programación para abordar preguntas en el área de finanzas.  -->

<!-- **Título.** *Trading en los mercados financieros - RoboTrader.* **Descripción.** El trading implica la compra y venta de instrumentos financieros como acciones, divisas o criptomonedas con el objetivo de obtener una ganancia de capital de corto plazo. Un trader compra una acción, y si después de algunos días sube de precio, la vende. Anticipar oportunamente las oportunidades de generar ganancias haciendo trading no es trivial porque requiere entender el mercado y las herramientas de análisis de datos. ¿Qué acción comprar, cuándo comprarla, cuándo venderla? Existen modelos financieros, econométricos y otros asociados con machine learning que presumiblemente tienen la capacidad de anticipar el precio de los activos financieros y diseñar reglas de trading. Un software o algoritmo podría tomar datos del mercado, estimar los modelos, y generar una señal de compra o venta de acuerdo a reglas establecidas por el usuario, incluso podría comunicarse con un gestor o con una aplicación para realizar la compra o de venta de manera automática. Este proyecto puede ser de interés para empresas que ofrecen servicios financieros, como base para la creación de una FinTech, o sitios web especializados en ofrecer recomendaciones de inversión. Este tema puede orientarse a un proyecto de investigación en donde se comparan las utilidades derivadas de reglas de trading a partir de métodos tradicionales y modernos para evaluar si los modelos más modernos ofrecen mejores o peores rendimientos para el inversionista. -->
<!-- **Título.** *Oportunidades de arbitraje - RoboAdvisor.* **Descripción.** El arbitraje representa oportunidades de generar ganancias virtualmente libres de riesgo a partir de desequilibrios o fallas en el mercado. Tradicionalmente, estas oportunidades solo podían identificarse de manera teórica porque normalmente desaparecen en poco tiempo. Sin embargo, las nuevas tecnologías y el desarrollo de modelos financieros abren la posibilidad de identificar estas oportunidades de arbitraje en los mercados y generar las recomendaciones necesarias para aprovecharlas y obtener ganancias con un nivel de riesgo relativamente bajo. Una de muchas alternativas podría ser evaluar la paridad put-call, que bajo ciertas condiciones puede ayudar a identificar estas oportunidades de arbitraje. El software descargaría información a tiempo real del mercado, evalúa un modelo financiero, aplica algunas reglas y criterios, y daría como resultado recomendaciones de inversión automatizadas que puede ser de interés para empresas e inversionistas. -->
<!-- **Título.** *Riesgo de crédito de empresas públicas.* **Descripción.** El riesgo de crédito es la posibilidad de incumplir con el pago de deudas. Si una empresa no puede pagar sus deudas puede caer en bancarrota y en el peor de los casos se declara en quiebra y la empresa deja de existir. El riesgo de crédito se puede medir y gestionar con la ayuda de datos y modelos financieros. Las empresas con relativamente bajos niveles de riesgo de crédito son más exitosas en la atracción de financiamiento, lo cual le permite invertir y crecer. Las empresas con altos niveles de riesgo de crédito generalmente tienen más dificultades para acceder a financiamiento, y si lo hacen es un financiamiento caro. La medición del riesgo de crédito es una tarea que tradicionalmente hacen empresas multinacionales muy grandes, y consiste en otorgar una calificación (que resulta muy cara) a las empresas para que el mercado tenga una idea clara de la calidad crediticia de la empresa. Las calificaciones crediticias representan información valiosa para la obtención de financiamiento por parte de la empresa, y para identificar oportunidades de inversión para los inversionistas. Sin embargo, las nuevas tecnologías y los modelos financieros abren la posibilidad de que surjan empresas de menor tamaño o tecnología que permita la estimación del riesgo de crédito y/o calificaciones crediticias. Este proyecto puede representar un software para que la empresa interesada acceda a la estimación de su propio riesgo de crédito. Otra alternativa es una empresa que venda calificaciones crediticias a otras empresas. Una alternativa adicional es una empresa que asesore a otras sobre la forma y la tecnología para gestionar su riesgo de crédito. Estos servicios son de interés para empresas de cualquier industria, pero son especialmente atractivos para bancos y sofomes.  -->
<!-- **Título.** *Riesgo de crédito de individuos.* **Descripción.** El tema principal de este proyecto es muy parecido al anterior. Sin embargo, el enfoque es distinto porque aquí se evalúa la probabilidad de que un individuo deje de pagar un crédito. Este proyecto puede ser de interés para las empresas que les interesa reducir su cartera vencida mediante el otorgamiento de crédito de manera óptima, en base a criterios y recomendaciones de modelos de riesgo de crédito. En la actualidad, hay instituciones financieras que toman la decisión de otorgar un crédito en base a las respuestas de una encuesta sin fundamento científico, y en otros casos es una decisión simplemente arbitraria. Como consecuencia, estas empresas tienen poco control sobre su cartera vencida y los costos de sus ineficiencias se trasladan al cliente, lo que abre la posibilidad de mejorar los procesos utilizando criterios basados en modelos financieros automatizados. El resultado implica que la empresa pueda aumentar su porcentaje de créditos otorgados y reducir su cartera vencida, lo cual incrementa sus ingresos y se reducen sus costos, lo que la vuelve más competitiva en el mercado. -->
<!-- Si alguno de estos proyectos es de su interés, o si quiere discutir otras opciones en donde puede aplicar sus habilidades computacionales en el área de finanzas, economía, estadística aplicada, ciencia de datos, puede contactarme para agendar una junta por Zoom. -->
<!-- Dr. Martín Lozano. martin.lozano@udem.edu -->
<!-- WEB: https://sites.google.com/site/mlozanoqf/ -->
<!-- GitHub: https://mlozanoqf.github.io/ -->
<!-- Zoom: https://us02web.zoom.us/j/9209945512 -->
<p>This document took 3.58 minutes to compile in Quarto version 1.3.450, and R version 4.3.2 (2023-10-31 ucrt).</p>
</section>
<section id="references." class="level1 unnumbered">
<h1 class="unnumbered">References.</h1>
<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-knuth1984literate" class="csl-entry" role="listitem">
Knuth, Donald Ervin. 1984. <span>“Literate Programming.”</span> <em>The Computer Journal</em> 27 (2): 97–111.
</div>
<div id="ref-merton1973theory" class="csl-entry" role="listitem">
Merton, Robert C. 1973. <span>“Theory of Rational Option Pricing.”</span> <em>The Bell Journal of Economics and Management Science</em>, 141–83.
</div>
<div id="ref-oecd2020oecd" class="csl-entry" role="listitem">
OECD. 2020. <em>OECD/INFE 2020 International Survey of Adult Financial Literacy</em>. <a href="https://www.oecd.org/financial/education/oecd-infe-2020-international-survey-of-adult-financial-literacy.pdf">https://www.oecd.org/financial/education/oecd-infe-2020-international-survey-of-adult-financial-literacy.pdf</a>.
</div>
<div id="ref-Rref" class="csl-entry" role="listitem">
R Core Team. 2024. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-scholes1973pricing" class="csl-entry" role="listitem">
Scholes, Myron. 1973. <span>“The Pricing of Options and Corporate.”</span> <em>The Journal of Political Economy</em> 81 (3): 637–54.
</div>
<div id="ref-sharpe1964capital" class="csl-entry" role="listitem">
Sharpe, William F. 1964. <span>“Capital Asset Prices: A Theory of Market Equilibrium Under Conditions of Risk.”</span> <em>The Journal of Finance</em> 19 (3): 425–42.
</div>
</div>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The Black-Scholes formula for pricing European call and put options is one of the most famous equations in financial mathematics. See <span class="citation" data-cites="scholes1973pricing">Scholes (<a href="#ref-scholes1973pricing" role="doc-biblioref">1973</a>)</span> and <span class="citation" data-cites="merton1973theory">Merton (<a href="#ref-merton1973theory" role="doc-biblioref">1973</a>)</span>. This equation is so important that Robert Merton and Myron Scholes received the 1997 Nobel Price for Economics in honour of their work. Unfortunately, Fischer Black, who clearly contributed extensive work to the formula, passed away in 1995. Interestingly, the Black-Scholes formula is basically a partial differential equation (PDE) well known in physics as the “heat equation” which describes the distribution of heat in a given region over time. Moreover, there are close parallels between random movements of particles in a fluid (called physical Brownian motion) and price fluctuations in financial markets (known as financial Brownian motion). Thus, finance seems to follow not only human behaviour but also some physics principles.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>According to market intelligence company IDC, the ‘Global Datasphere’ in 2018 reached 18 zettabytes. The vast majority of the world’s data has been created in the last few years and this astonishing growth of data shows no sign of slowing down. In fact, IDC predicts the world’s data will grow to 175 zettabytes in 2025. One zettabyte is 1000000000000000000000 bytes. In scientific notation this is 1e+21 or 1 with 21 zeros at the right, we call it one sextillion.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>The logic behind this is not very different from what we have heard about <em>flatten the curve</em> in the context of the 2020 pandemic. As the curve increases, the high speed of increase is captured by big vertical blue bars. It is expected that the speed of increase slows down before the curve is flat, and this slowing down is captured by smaller vertical blue lines. So, before the curve is flat and starts to decrease, the blue vertical lines become smaller and smaller.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-P732Y7798E"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-P732Y7798E');
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



<script src="index_files/libs/quarto-html/zenscroll-min.js"></script>
</body></html>